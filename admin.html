<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - ITD</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* RELOJ DE ESPERA (Loader) */
        .loader-clock {
            width: 48px;
            height: 48px;
            border: 4px solid #1B396A;
            border-radius: 50%;
            position: relative;
            background: rgba(255, 255, 255, 0.5);
            margin: 0 auto;
        }
        .loader-clock::before {
            content: '';
            position: absolute;
            width: 6px; height: 6px;
            background: #1B396A;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        .loader-clock::after {
            content: '';
            position: absolute;
            width: 3px; height: 18px;
            background: #9D2449; /* Color guinda */
            top: 50%; left: 50%;
            margin-left: -1.5px;
            margin-top: -18px;
            transform-origin: bottom center;
            border-radius: 2px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec',
            TEACHERS_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSAe4dmVN4CArjEy_lvI5qrXf16naxZLO1lAxGm2Pj4TrdnoebBg03Vv4-DCXciAkHJFiZaBMKletUs/pub?gid=987931491&single=true&output=csv'
        };

        const ADMIN_EMAILS = [
            'alejandro.calderon@itdurango.edu.mx',
            'desarrollo.academico@itdurango.edu.mx'
        ];

        const CHART_LABELS = [
            "INGENIERIA INDUSTRIAL", 
            "SISTEMAS Y COMPUTACI√ìN", 
            "CIENCIAS B√ÅSICAS", 
            "QU√çMICA BIOQU√çMICA", 
            "METAL MEC√ÅNICA", 
            "C. ECON√ìMICO ADMINISTRATIVAS", 
            "POSGRADO E INVESTIGACI√ìN", 
            "CIENCIAS DE LA TIERRA", 
            "ELECTRICA ELECTR√ìNICA",
            "OTRO"
        ];

        const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';

        // --- UTILIDADES ---
        const removeAccents = (text) => text ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '') : '';
        const getImageDataFromURL = (url) => {
            return new Promise((resolve) => {
                const img = new Image(); img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                    try { resolve(canvas.toDataURL('image/png')); } catch (e) { resolve(null); }
                };
                img.onerror = () => resolve(null); img.src = url;
            });
        };
        const drawLogo = (doc, logoData, x, y, targetWidth) => {
            if (!logoData) return;
            try {
                const props = doc.getImageProperties(logoData);
                const targetHeight = (props.height * targetWidth) / props.width;
                doc.addImage(logoData, 'PNG', x, y, targetWidth, targetHeight);
            } catch (e) { doc.addImage(logoData, 'PNG', x, y, targetWidth, targetWidth); }
        };
        const parseCSVLine = (line) => {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') { if (inQuotes && line[i + 1] === '"') { current += '"'; i++; } else { inQuotes = !inQuotes; } }
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else { current += char; }
            }
            result.push(current.trim());
            return result;
        };
        const cleanCSVValue = (val) => { let c = val.trim(); if (c.startsWith('"') && c.endsWith('"')) c = c.substring(1, c.length - 1).replace(/""/g, '"'); return c; };

        // ==========================================
        // LOGIN SCREEN
        // ==========================================
        const LoginScreen = ({ onLogin, error }) => {
            const googleBtnRef = useRef(null);
            
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.google && window.google.accounts && googleBtnRef.current) {
                        clearInterval(interval);
                        try {
                            window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin });
                            window.google.accounts.id.renderButton(googleBtnRef.current, { theme: "filled_blue", size: "large", text: "signin_with", shape: "pill" });
                        } catch (e) { console.error("Error rendering Google Button", e); }
                    }
                }, 500);
                return () => clearInterval(interval);
            }, [onLogin]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full border-t-4 border-indigo-600 animate-fadeIn">
                        <img src={ITD_LOGO_URL} className="h-20 mx-auto mb-4 object-contain"/>
                        <h1 className="text-2xl font-bold text-slate-800 mb-2">Panel Administrativo</h1>
                        <p className="text-slate-500 mb-6">Actualizaci√≥n Docente ITD</p>
                        {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm font-bold border border-red-200">{error}</div>}
                        <div className="flex justify-center min-h-[50px]" ref={googleBtnRef}></div>
                        <div className="mt-6 text-xs text-slate-400">Acceso exclusivo para Coordinaci√≥n</div>
                        <a href="index.html" className="block mt-4 text-indigo-600 text-sm hover:underline font-semibold">‚Üê Volver al Portal</a>
                    </div>
                </div>
            );
        };

        // ==========================================
        // M√ìDULO 1: BUSCADOR
        // ==========================================
        const SearchPanel = ({ user }) => {
            const [query, setQuery] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [teachers, setTeachers] = useState([]);
            const [suggestions, setSuggestions] = useState([]);

            useEffect(() => {
                const getTeachers = async () => {
                    try {
                        const response = await fetch(`${CONFIG.TEACHERS_CSV_URL}&_=${Date.now()}`);
                        const csvText = await response.text();
                        const list = csvText.trim().split(/\r?\n/).slice(1).map(line => {
                            const v = parseCSVLine(line);
                            return v.length >= 3 ? { nombreCompleto: cleanCSVValue(v[0]), email: cleanCSVValue(v[2]) } : null;
                        }).filter(Boolean);
                        setTeachers(list);
                    } catch (e) { console.error("Error docentes", e); }
                };
                getTeachers();
            }, []);

            const handleSuggestion = (e) => {
                const val = e.target.value; setQuery(val);
                if (val.length > 2) {
                    const norm = removeAccents(val.toLowerCase());
                    setSuggestions(teachers.filter(t => removeAccents(t.nombreCompleto.toLowerCase()).includes(norm)).slice(0, 5));
                } else setSuggestions([]);
            };

            const search = (target) => {
                if(!target.trim()) return; 
                setLoading(true);
                setSuggestions([]);
                setResult(null);
                setQuery(target);
                
                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getTeacherHistory&id_token=${user.token}&target_email=${encodeURIComponent(target)}`)
                    .then(r => r.json())
                    .then(res => {
                        if(res.success && res.data && res.data.courses.length > 0) {
                            setResult(res.data);
                        } else {
                            alert("No se encontraron registros para este docente.");
                        }
                    })
                    .catch(err => alert("Error de conexi√≥n: " + err.message))
                    .finally(() => setLoading(false));
            };

            const exportKardexPdf = async () => {
                if(!result) return;
                const { teacher, courses } = result;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'letter');
                const pageWidth = doc.internal.pageSize.getWidth();

                const itdLogo = await getImageDataFromURL(ITD_LOGO_URL);
                if (itdLogo) drawLogo(doc, itdLogo, pageWidth - 35, 10, 25);

                doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(27, 57, 106);
                doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth/2, 20, { align: "center" });
                doc.setFontSize(11); doc.setTextColor(100);
                doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth/2, 26, { align: "center" });
                doc.setFontSize(14); doc.setTextColor(128, 0, 0);
                doc.text("HISTORIAL DE CURSOS", pageWidth/2, 38, { align: "center" });

                doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "bold");
                doc.text("Docente:", 14, 50);
                doc.setFont("helvetica", "normal");
                doc.text(teacher.name, 35, 50);

                const today = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
                doc.setFont("helvetica", "bold");
                doc.text("Fecha de emisi√≥n:", 14, 55);
                doc.setFont("helvetica", "normal");
                doc.text(today, 50, 55);

                const tableBody = courses.map(c => [
                    c.year, c.folio, c.courseName, c.datesText, c.hours, c.type, c.deptOrigin || teacher.dept
                ]);

                doc.autoTable({
                    head: [['A√±o', 'Folio', 'Curso', 'Fechas', 'Hrs', 'Tipo', 'Depto. Origen']],
                    body: tableBody,
                    startY: 60, theme: 'grid',
                    headStyles: { fillColor: [27, 57, 106], textColor: 255, fontSize: 9, halign: 'center' },
                    styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 12, halign: 'center' },
                        3: { cellWidth: 25, halign: 'center' },
                        4: { cellWidth: 10, halign: 'center' },
                        5: { cellWidth: 20, halign: 'center' },
                        6: { cellWidth: 35, halign: 'left' }
                    }
                });

                doc.save(`Kardex_${teacher.name}.pdf`);
            };

            const exportKardexExcel = () => {
                if(!result) return;
                const { teacher, courses } = result;
                const rows = courses.map(c => ({
                    "A√±o": c.year,
                    "Folio": c.folio,
                    "Curso": c.courseName,
                    "Fechas": c.datesText,
                    "Horas": c.hours,
                    "Tipo": c.type,
                    "Depto. Origen": c.deptOrigin || teacher.dept
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Historial");
                XLSX.writeFile(wb, `Historial_${teacher.name}.xlsx`);
            };

            return (
                <div className="animate-fadeIn p-6">
                    <div className="max-w-4xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <span className="bg-indigo-100 p-2 rounded-lg text-indigo-600">üîç</span> Consultar Historial Docente
                        </h2>
                        
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
                            <div className="relative flex gap-2">
                                <div className="flex-grow relative">
                                    <input 
                                        type="text" 
                                        value={query} 
                                        onChange={handleSuggestion} 
                                        onKeyDown={(e) => e.key === 'Enter' && query.trim() && search(query)}
                                        placeholder="Escriba el nombre del docente o correo..." 
                                        className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                    />
                                    {suggestions.length > 0 && (
                                        <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 shadow-xl max-h-60 overflow-auto">
                                            {suggestions.map((t, i) => (
                                                <li key={i} onClick={() => { setQuery(t.nombreCompleto); setSuggestions([]); search(t.nombreCompleto); }} className="px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 last:border-0">
                                                    <div className="font-bold text-slate-800">{t.nombreCompleto}</div>
                                                    <div className="text-xs text-slate-500">{t.email}</div>
                                                </li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                                <button 
                                    onClick={() => search(query)} 
                                    disabled={loading || !query.trim()} 
                                    className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-3 rounded-lg shadow transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                                >
                                    {loading ? <div className="loader-clock !w-5 !h-5 !border-2"></div> : 'Buscar'}
                                </button>
                            </div>
                        </div>

                        {result && (
                            <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                                <div className="p-6 border-b border-slate-100 flex flex-wrap gap-4 justify-between items-center bg-slate-50">
                                    <div>
                                        <h3 className="text-xl font-bold text-slate-800">{result.teacher.name}</h3>
                                        <p className="text-slate-500 text-sm">{result.teacher.email}</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={exportKardexPdf} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><span>üìÑ</span> PDF</button>
                                        <button onClick={exportKardexExcel} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><span>üìä</span> Excel</button>
                                    </div>
                                </div>
                                <div className="max-h-[500px] overflow-auto custom-scrollbar">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100 text-slate-700 uppercase font-bold text-xs sticky top-0">
                                            <tr>
                                                <th className="px-4 py-3">A√±o</th>
                                                <th className="px-4 py-3">Curso</th>
                                                <th className="px-4 py-3">Folio</th>
                                                <th className="px-4 py-3">Hrs</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {result.courses.map((c, i) => (
                                                <tr key={i} className="hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-bold text-indigo-700">{c.year}</td>
                                                    <td className="px-4 py-3 font-medium text-slate-800">{c.courseName}</td>
                                                    <td className="px-4 py-3 text-slate-500 font-mono text-xs">{c.folio}</td>
                                                    <td className="px-4 py-3">{c.hours}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // M√ìDULO 2: ENCUESTAS (EFICACIA + DOCENTES)
        // ==========================================
        const SurveyPanel = () => {
            const [efficacyStats, setEfficacyStats] = useState(null);
            const [teacherStats, setTeacherStats] = useState(null);
            const [loading, setLoading] = useState(true);
            
            const chartRef1 = useRef(null);
            const chartInstance1 = useRef(null);
            const chartRef2 = useRef(null);
            const chartInstance2 = useRef(null);

            // Mapping function to specific chart labels
            const mapToChartLabel = (rawName) => {
                const r = removeAccents(rawName || '').toUpperCase().trim();
                
                if(r.includes("INDUSTRIAL")) return "INGENIERIA INDUSTRIAL";
                if(r.includes("SISTEMAS") || r.includes("COMPUTACI√ìN") || r.includes("COMPUTACION") || r.includes("ISC")) return "SISTEMAS Y COMPUTACI√ìN";
                if(r.includes("B√ÅSICAS") || r.includes("BASICAS") || r.includes("CB")) return "CIENCIAS B√ÅSICAS";
                if(r.includes("QU√çMICA") || r.includes("QUIMICA") || r.includes("BIOQU√çMICA")) return "QU√çMICA BIOQU√çMICA";
                if(r.includes("METAL") || r.includes("MEC√ÅNICA") || r.includes("MECANICA")) return "METAL MEC√ÅNICA";
                if(r.includes("ECON√ìMICO") || r.includes("ECONOMICO") || r.includes("ADMINISTRATIVAS") || r.includes("CEA")) return "CIENCIAS ECON√ìMICO ADMINISTRATIVAS";
                if(r.includes("POSGRADO") || r.includes("INVESTIGACI√ìN") || r.includes("INVESTIGACION")) return "POSGRADO E INVESTIGACI√ìN";
                if(r.includes("TIERRA")) return "CIENCIAS DE LA TIERRA";
                if(r.includes("ELECTRICA") || r.includes("ELECTR√ìNICA") || r.includes("ELECTRONICA")) return "ELECTRICA ELECTR√ìNICA";
                
                return "OTRO";
            };

            useEffect(() => {
                setLoading(true);
                Promise.all([
                    fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getSurveyStats`).then(r => r.json()),
                    fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getTeacherSurveyStats`).then(r => r.json())
                ])
                .then(([res1, res2]) => {
                    if(res1.success) setEfficacyStats(res1.data);
                    if(res2.success) setTeacherStats(res2.data);
                })
                .catch(e => console.error(e))
                .finally(() => setLoading(false));
            }, []);

            // Render Chart 1: Eficacia
            useEffect(() => {
                if (!loading && efficacyStats && chartRef1.current) {
                    renderChart(chartRef1.current, chartInstance1, efficacyStats, 'Participaci√≥n en Encuesta de Eficacia por Fefaturas', ['#4f46e5', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#9ca3af']);
                }
            }, [efficacyStats, loading]);

            // Render Chart 2: Docentes
            useEffect(() => {
                if (!loading && teacherStats && chartRef2.current) {
                    renderChart(chartRef2.current, chartInstance2, teacherStats, 'Participaci√≥n en Encuesta de Docentes', ['#be123c', '#e11d48', '#f43f5e', '#fb7185', '#fda4af', '#9f1239', '#881337', '#be123c', '#e11d48', '#f43f5e']);
                }
            }, [teacherStats, loading]);

            const renderChart = (canvas, instanceRef, stats, label, colors) => {
                const aggregatedCounts = {};
                CHART_LABELS.forEach(label => { aggregatedCounts[label] = 0; });

                if (stats.participacion) {
                    Object.entries(stats.participacion).forEach(([raw, count]) => {
                        const label = mapToChartLabel(raw);
                        if (aggregatedCounts.hasOwnProperty(label)) {
                            aggregatedCounts[label] += count;
                        }
                    });
                }

                const dataValues = CHART_LABELS.map(l => aggregatedCounts[l] || 0);

                if(instanceRef.current) {
                    instanceRef.current.destroy();
                }
                
                instanceRef.current = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: CHART_LABELS, 
                        datasets: [{ 
                            label: label, 
                            data: dataValues, 
                            backgroundColor: colors, 
                            borderRadius: 4,
                            borderWidth: 1
                        }]
                    },
                    plugins: [ChartDataLabels],
                    options: { 
                        indexAxis: 'y', // Horizontal chart
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: { label: (ctx) => `${ctx.raw} evaluaciones` }
                            },
                            datalabels: {
                                color: '#000',
                                anchor: 'end',
                                align: 'end',
                                font: {
                                    weight: 'bold'
                                },
                                formatter: (value) => value > 0 ? value : ''
                            }
                        }, 
                        layout: {
                            padding: {
                                right: 30
                            }
                        },
                        scales: { 
                            x: { beginAtZero: true, ticks: { stepSize: 1 } },
                            y: { 
                                ticks: { font: { size: 10, weight: 'bold' }, autoSkip: false } 
                            }
                        } 
                    }
                });
            };

            const exportPdf = async (stats, chartRef, title, filename) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const logo = await getImageDataFromURL(ITD_LOGO_URL);
                if (logo) drawLogo(doc, logo, 15, 10, 18);
                doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(27, 57, 106);
                doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth / 2, 18, { align: "center" });
                doc.setFontSize(10); doc.setTextColor(100); 
                doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth / 2, 24, { align: "center" });
                doc.setFontSize(12); doc.setTextColor(0); 
                doc.text(title.toUpperCase(), pageWidth / 2, 35, { align: "center" });
                doc.setDrawColor(27, 57, 106); doc.setLineWidth(0.5); doc.line(15, 40, pageWidth - 15, 40);
                
                if(chartRef.current) {
                    const canvas = chartRef.current;
                    const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
                    const ctx = tempCanvas.getContext('2d'); ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); ctx.drawImage(canvas, 0, 0);
                    const imgData = tempCanvas.toDataURL("image/png");
                    doc.addImage(imgData, 'PNG', 15, 50, 180, 140); 
                }
                const dateStr = new Date().toLocaleDateString('es-MX', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                doc.setFontSize(10); doc.setTextColor(80); 
                doc.text(`Total de Evaluaciones: ${stats?.total || 0}`, 15, 200);
                doc.text(`Fecha de corte: ${dateStr}`, 15, 205);
                doc.save(filename);
            };

            return (
                <div className="animate-fadeIn p-6">
                    <div className="max-w-5xl mx-auto space-y-12">
                        {loading ? (
                             <div className="text-center py-20">
                                <div className="loader-clock"></div>
                                <p className="mt-4 text-slate-500 font-semibold">Cargando encuestas...</p>
                             </div>
                        ) : (
                            <>
                                {/* Gr√°fica 1: Eficacia */}
                                <div>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                            <span className="bg-yellow-100 p-2 rounded-lg text-yellow-600">üìä</span> Encuesta de Eficacia
                                        </h2>
                                        <button onClick={() => exportPdf(efficacyStats, chartRef1, 'Encuesta de Eficacia - Avance por Departamento', 'Reporte_Eficacia.pdf')} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition shadow flex items-center gap-2">
                                            <span>üìÑ</span> PDF
                                        </button>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                        <div className="mb-4 bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500 inline-block">
                                            <span className="text-xs font-bold text-blue-600 uppercase block">Total</span>
                                            <span className="text-2xl font-bold text-blue-900">{efficacyStats?.total || 0}</span>
                                        </div>
                                        <div className="h-[500px] w-full"><canvas ref={chartRef1}></canvas></div>
                                    </div>
                                </div>

                                {/* Gr√°fica 2: Docentes */}
                                <div>
                                    <div className="flex justify-between items-center mb-4 border-t pt-8 border-slate-200">
                                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                            <span className="bg-rose-100 p-2 rounded-lg text-rose-600">üéì</span> Encuesta de Docentes
                                        </h2>
                                        <button onClick={() => exportPdf(teacherStats, chartRef2, 'Encuesta de Docentes - Avance por Departamento', 'Reporte_Docentes.pdf')} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition shadow flex items-center gap-2">
                                            <span>üìÑ</span> PDF
                                        </button>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                        <div className="mb-4 bg-rose-50 p-3 rounded-lg border-l-4 border-rose-500 inline-block">
                                            <span className="text-xs font-bold text-rose-600 uppercase block">Total</span>
                                            <span className="text-2xl font-bold text-rose-900">{teacherStats?.total || 0}</span>
                                        </div>
                                        <div className="h-[500px] w-full"><canvas ref={chartRef2}></canvas></div>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // ==========================================
        // M√ìDULO 3: REPORTES (FILTROS MEJORADOS)
        // ==========================================
        const ReportsPanel = ({ user }) => {
            const [year, setYear] = useState('ACTUAL');
            const [dept, setDept] = useState('');
            const [month, setMonth] = useState('');
            const [departments, setDepartments] = useState([]);
            const [data, setData] = useState([]);
            const [filtered, setFiltered] = useState([]);
            const [loading, setLoading] = useState(false);

            const MONTHS = [
                {v: '', l: '-- Todos --'},
                {v: '1', l: 'Enero'},
                {v: '6', l: 'Junio'},
                {v: '8', l: 'Agosto'}
            ];

            useEffect(() => {
                setLoading(true);
                setDept('');
                setMonth('');
                setFiltered([]);
                
                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getReportData&period=${year}&id_token=${user.token}`)
                    .then(r => r.json())
                    .then(res => {
                        if(res.success) {
                            const processedData = res.data.map(item => {
                                // "Depto. Oferente" se obtiene directamente de la columna "Departamento" (√≠ndice 6 en el sheet).
                                // La API devuelve ese valor en item.departamento.
                                return { ...item, depto_oferente: item.departamento };
                            });

                            setData(processedData);
                            const uniqueDepts = [...new Set(processedData.map(i => i.departamento).filter(Boolean).map(d => d.trim().toUpperCase()))].sort();
                            setDepartments(uniqueDepts);
                        } else { setData([]); setDepartments([]); }
                    })
                    .finally(() => setLoading(false));
            }, [year]);

            useEffect(() => {
                let temp = data;

                if(dept) {
                    temp = temp.filter(i => i.departamento && i.departamento.trim().toUpperCase() === dept);
                }

                if(month) {
                    temp = temp.filter(i => {
                        if (!i.fechas) return false;
                        const d = i.fechas.toUpperCase();
                        if (month === '1') return d.includes('ENE') || d.includes('JAN') || d.includes('/01/') || d.includes('-01-') || d.startsWith('01/');
                        if (month === '6') return d.includes('JUN') || d.includes('/06/') || d.includes('-06-') || d.startsWith('06/');
                        if (month === '8') return d.includes('AGO') || d.includes('AUG') || d.includes('/08/') || d.includes('-08-') || d.startsWith('08/');
                        return false;
                    });
                }

                setFiltered(temp);
            }, [dept, month, data]);

            const exportPdf = async () => {
                if(filtered.length === 0) return;
                const { jsPDF } = window.jspdf; 
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const logo = await getImageDataFromURL(ITD_LOGO_URL);
                if(logo) drawLogo(doc, logo, 10, 8, 20);

                doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.setTextColor(27, 57, 106);
                doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth/2, 15, { align: "center" });
                doc.setFontSize(10); doc.setTextColor(100);
                doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth/2, 20, { align: "center" });
                doc.setFontSize(14); doc.setTextColor(128, 0, 0);
                doc.text(`REPORTE GENERAL ${year}`, pageWidth/2, 30, { align: "center" });
                
                let subtitle = "";
                if(dept) subtitle += ` Depto: ${dept}`;
                if(month) subtitle += ` | Mes: ${MONTHS.find(m=>m.v===month)?.l}`;
                if(subtitle) { doc.setFontSize(10); doc.setTextColor(0); doc.text(subtitle, 14, 38); }
                
                doc.text(`Total: ${filtered.length}`, pageWidth-14, 38, { align: "right" });

                doc.autoTable({
                    head: [['Nombre', 'Curso', 'Folio', 'Fecha', 'Depto. Oferente']],
                    body: filtered.map(r => [r.nombre, r.curso, r.folio, r.fechas, r.depto_oferente]),
                    startY: 42, theme: 'striped', 
                    headStyles: { fillColor: [27, 57, 106], textColor: 255, halign: 'center' }, 
                    styles: { fontSize: 8, cellPadding: 2 }
                });
                
                doc.save(`Reporte_${year}.pdf`);
            };

            const exportExcel = () => {
                const rows = filtered.map(r => ({
                    "Nombre": r.nombre, "Curso": r.curso, "Folio": r.folio, "Fecha": r.fechas, "Departamento Docente": r.departamento, "Departamento Oferente": r.depto_oferente
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new(); 
                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                XLSX.writeFile(wb, `Reporte_${year}.xlsx`);
            };

            return (
                <div className="animate-fadeIn p-6">
                    <div className="max-w-7xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                            <span className="bg-green-100 p-2 rounded-lg text-green-600">üìã</span> Reportes Masivos
                        </h2>
                        <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-bold mb-2 text-slate-700">A√±o</label>
                                    <select value={year} onChange={e=>setYear(e.target.value)} className="w-full p-2 border rounded">
                                        <option value="ACTUAL">üü¢ Periodo Actual</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-2 text-slate-700">Mes de Inicio</label>
                                    <select value={month} onChange={e=>setMonth(e.target.value)} className="w-full p-2 border rounded">
                                        {MONTHS.map(m => <option key={m.v} value={m.v}>{m.l}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold mb-2 text-slate-700">Departamento (Docente)</label>
                                    <select value={dept} onChange={e=>setDept(e.target.value)} className="w-full p-2 border rounded" disabled={!departments.length}>
                                        <option value="">-- Todos --</option>
                                        {departments.map(d=><option key={d} value={d}>{d}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-4 mb-6 border-b border-slate-100 pb-6">
                                <button onClick={exportPdf} disabled={!filtered.length} className="bg-red-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed shadow transition flex items-center gap-2"><span>üìÑ</span> Descargar PDF</button>
                                <button onClick={exportExcel} disabled={!filtered.length} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed shadow transition flex items-center gap-2"><span>üìä</span> Descargar Excel</button>
                            </div>
                            {loading ? <div className="text-center py-10"><div className="loader-clock"></div><p className="mt-2 text-gray-500">Cargando...</p></div> : (
                                <div>
                                    <p className="text-sm text-gray-500 mb-2">Mostrando {filtered.length} registros</p>
                                    <div className="overflow-x-auto border rounded-lg max-h-[500px]">
                                        <table className="w-full text-xs text-left">
                                            <thead className="bg-slate-100 font-bold sticky top-0 text-slate-700 z-10">
                                                <tr>
                                                    <th className="p-3 border-b">Nombre Docente</th>
                                                    <th className="p-3 border-b">Curso</th>
                                                    <th className="p-3 border-b">Folio</th>
                                                    <th className="p-3 border-b">Fecha</th>
                                                    <th className="p-3 border-b text-blue-700">Depto. Oferente</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {filtered.map((r, i) => (
                                                    <tr key={i} className="hover:bg-gray-50">
                                                        <td className="p-3 font-medium">{r.nombre}</td>
                                                        <td className="p-3">{r.curso}</td>
                                                        <td className="p-3 font-mono text-gray-500">{r.folio}</td>
                                                        <td className="p-3">{r.fechas}</td>
                                                        <td className="p-3 font-semibold text-blue-800 bg-blue-50">{r.depto_oferente}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const AdminApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('search');
            const [error, setError] = useState('');

            const handleLogin = (response) => {
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    if (ADMIN_EMAILS.includes(payload.email)) {
                        setUser({ name: payload.name, email: payload.email, token: response.credential, picture: payload.picture });
                    } else {
                        setError('Acceso denegado. No tienes permisos de administrador.');
                    }
                } catch(e) { setError('Error de autenticaci√≥n.'); }
            };

            if (!user) return <LoginScreen onLogin={handleLogin} error={error} />;

            return (
                <div className="flex min-h-screen">
                    <aside className="w-64 bg-slate-900 text-white flex flex-col fixed h-full z-10 shadow-2xl">
                        <div className="p-6 border-b border-slate-700 flex items-center gap-3 bg-slate-900">
                            <img src={user.picture} className="w-10 h-10 rounded-full border-2 border-indigo-500"/>
                            <div className="overflow-hidden">
                                <p className="font-bold text-sm truncate">{user.name}</p>
                                <p className="text-xs text-slate-400">Administrador</p>
                            </div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            {[
                                {id:'search', icon:'üîç', label:'Consultar Docente'},
                                {id:'surveys', icon:'üìä', label:'Encuestas'},
                                {id:'reports', icon:'üìã', label:'Reportes'}
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 ${activeTab === item.id ? 'bg-indigo-600 text-white shadow-lg translate-x-1' : 'hover:bg-slate-800 text-slate-400 hover:text-white'}`}>
                                    <span>{item.icon}</span> {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700 bg-slate-900">
                            <a href="index.html" className="block w-full text-center py-2 text-sm text-slate-400 hover:text-white mb-2">Ir al Portal Publico</a>
                            <button onClick={() => setUser(null)} className="block w-full text-center py-2 text-sm text-red-400 hover:text-red-300 font-bold border border-red-900/30 rounded hover:bg-red-900/20 transition">Cerrar Sesi√≥n</button>
                        </div>
                    </aside>

                    <main className="flex-1 ml-64 bg-slate-50 min-h-screen">
                        <header className="bg-white shadow-sm p-6 mb-6 border-b border-slate-200">
                            <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                                {activeTab === 'search' && 'üîé Buscador del Historial Acad√©mico'}
                                {activeTab === 'surveys' && 'üìà Panel de Encuestas de Eficacia'}
                                {activeTab === 'reports' && 'üìë Generador de Reportes Masivos'}
                            </h1>
                        </header>
                        <div className="px-6 pb-12">
                            {activeTab === 'search' && <SearchPanel user={user} />}
                            {activeTab === 'surveys' && <SurveyPanel />}
                            {activeTab === 'reports' && <ReportsPanel user={user} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
