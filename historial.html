<!DOCTYPE html>
<html lang="es">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V2V4CT2C69"></script>
<script src="ga.js"></script>
    
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
<title>Historial Acad√©mico - Portal ITD</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
</style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900 pb-20">
<!-- Bot√≥n Flotante Volver -->
<div class="fixed top-4 left-4 z-50">
    <a href="index.html" class="bg-white/90 backdrop-blur text-blue-900 px-4 py-2 rounded-full shadow-md font-bold text-sm hover:bg-blue-900 hover:text-white transition-all flex items-center gap-2">
        ‚Üê Volver al Portal
    </a>
</div>

<header class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-orange-500">
    <div class="container mx-auto px-4 py-4 sm:py-6 flex justify-between items-center gap-4">
        <div class="w-16 sm:w-20">
             <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" class="h-12 sm:h-16 object-contain">
        </div>
        <div class="text-center flex-1">
            <h1 class="text-lg sm:text-2xl font-bold text-slate-800">HISTORIAL DE CURSOS</h1>
            <p class="text-xs sm:text-sm text-orange-600 font-bold tracking-wider uppercase">Kardex de Actualizaci√≥n Docente</p>
        </div>
        <div class="w-16 sm:w-20 flex justify-end">
            <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" class="h-12 sm:h-16 object-contain">
        </div>
    </div>
</header>

<div id="root"></div>

<footer class="bg-slate-900 text-white text-center py-8 mt-12">
    <div class="container mx-auto px-4">
        <p class="font-bold text-sm mb-1">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
        <p class="text-xs opacity-60 mb-1">Instituto Tecnol√≥gico de Durango</p>
        <p class="text-xs opacity-40">M.C. Alejandro Calder√≥n Renter√≠a</p>
    </div>
</footer>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CONFIG = {
        GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
    };

    const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';

    const getImageDataFromURL = (url) => {
        return new Promise((resolve) => {
            const img = new Image(); img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                try { resolve(canvas.toDataURL('image/png')); } catch (e) { resolve(null); }
            };
            img.onerror = () => resolve(null); img.src = url;
        });
    };
    
    const drawLogo = (doc, logoData, x, y, targetWidth) => {
        if (!logoData) return;
        try {
            const props = doc.getImageProperties(logoData);
            const targetHeight = (props.height * targetWidth) / props.width;
            doc.addImage(logoData, 'PNG', x, y, targetWidth, targetHeight);
        } catch (e) { doc.addImage(logoData, 'PNG', x, y, targetWidth, targetWidth); }
    };

    const LoginScreen = ({ onLogin }) => {
        const googleBtnRef = useRef(null);
        
        useEffect(() => {
            const interval = setInterval(() => {
                if (window.google && window.google.accounts && googleBtnRef.current) {
                    clearInterval(interval);
                    try {
                        window.google.accounts.id.initialize({ 
                            client_id: CONFIG.GOOGLE_CLIENT_ID, 
                            callback: onLogin,
                            use_fedcm_for_prompt: false
                        });
                        window.google.accounts.id.renderButton(googleBtnRef.current, { theme: "filled_blue", size: "large", text: "continue_with", shape: "pill" });
                        window.google.accounts.id.prompt();
                    } catch (e) { console.error("Error rendering Google Button", e); }
                }
            }, 500);
            return () => clearInterval(interval);
        }, [onLogin]);

        return (
            <div className="min-h-[60vh] flex items-center justify-center animate-fadeIn">
                <div className="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border-t-4 border-orange-500">
                    <div className="text-5xl mb-4">üìö</div>
                    <h2 className="text-2xl font-bold mb-2 text-slate-800">Acceso a Historial</h2>
                    <p className="text-slate-500 mb-8">Inicia sesi√≥n con tu cuenta institucional para ver tu kardex de cursos.</p>
                    <div className="flex justify-center min-h-[50px]" ref={googleBtnRef}></div>
                </div>
            </div>
        );
    };

    const Dashboard = ({ user, data, onLogout }) => {
        const { teacher, courses } = data;
        
        const exportToPdf = async () => {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('p', 'mm', 'letter');
            const pageWidth = doc.internal.pageSize.getWidth();

            const itdLogo = await getImageDataFromURL(ITD_LOGO_URL); 
            if (itdLogo) drawLogo(doc, itdLogo, pageWidth - 35, 10, 25);

            doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(27, 57, 106);
            doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth/2, 20, { align: "center" });
            doc.setFontSize(11); doc.setTextColor(100); 
            doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth/2, 26, { align: "center" });
            doc.setFontSize(14); doc.setTextColor(128, 0, 0);
            doc.text("HISTORIAL DE CURSOS", pageWidth/2, 38, { align: "center" });
            
            doc.setTextColor(0); doc.setFontSize(10); doc.setFont("helvetica", "bold");
            doc.text("Docente:", 14, 50);
            doc.setFont("helvetica", "normal");
            doc.text(teacher.name, 35, 50);

            const today = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFont("helvetica", "bold");
            doc.text("Fecha de emisi√≥n:", 14, 55);
            doc.setFont("helvetica", "normal");
            doc.text(today, 50, 55);
            
            const tableBody = courses.map(c => [
                c.year, c.folio, c.courseName, c.datesText, c.hours, c.type, c.deptOrigin || teacher.dept
            ]);

            doc.autoTable({ 
                head: [['A√±o', 'Folio', 'Curso', 'Fechas', 'Hrs', 'Tipo', 'Depto. Origen']], 
                body: tableBody, 
                startY: 60, theme: 'striped', 
                headStyles: { fillColor: [234, 88, 12], textColor: 255, fontSize: 9, halign: 'center' }, // Orange header
                styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak' },
                columnStyles: {
                    0: { cellWidth: 12, halign: 'center', fontStyle: 'bold' },
                    1: { cellWidth: 25, fontStyle: 'bold' },
                    2: { cellWidth: 'auto' },
                    3: { cellWidth: 25 },
                    4: { cellWidth: 10, halign: 'center' },
                    5: { cellWidth: 20, halign: 'center' },
                    6: { cellWidth: 30, halign: 'left' }
                }
            });
            
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(8); doc.setTextColor(150);
            doc.text("P√°gina 1 de " + pageCount, pageWidth/2, doc.internal.pageSize.getHeight() - 10, { align: "center" });

            doc.save(`Kardex_${teacher.name}.pdf`);
        };
        
        const years = [...new Set(courses.map(c => c.year))].sort().reverse();
        
        return (
            <div className="animate-fadeIn container mx-auto px-4 py-8 max-w-5xl">
                <div className="bg-white rounded-2xl shadow-lg p-6 mb-8 border-l-8 border-orange-500 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">Bienvenido</p>
                        <h2 className="text-2xl font-bold text-slate-800">{user.name}</h2>
                        <p className="text-sm text-slate-500">{user.email}</p>
                    </div>
                    <button onClick={onLogout} className="bg-slate-100 text-slate-600 px-6 py-2 rounded-full font-bold hover:bg-slate-200 hover:text-slate-800 transition-colors">
                        Cerrar Sesi√≥n
                    </button>
                </div>
                
                <div className="bg-white rounded-2xl shadow-md p-8 mb-10 relative border border-slate-100">
                    <div className="absolute top-0 right-0 p-6">
                        <button onClick={exportToPdf} className="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-100 transition-colors flex items-center gap-2 shadow-sm">
                            <span>üìÑ</span> Descargar PDF
                        </button>
                    </div>
                    <div className="mt-4 sm:mt-0">
                        <p className="text-xs font-bold text-orange-500 uppercase tracking-wider mb-1">Historial Acad√©mico</p>
                        <h2 className="text-3xl font-bold text-slate-800 mb-1">{teacher.name}</h2>
                        <p className="text-slate-500 font-medium">{teacher.dept}</p>
                    </div>
                </div>

                {years.length === 0 ? (
                    <div className="text-center py-12 bg-white rounded-xl shadow">
                        <p className="text-slate-400">No se encontraron cursos registrados.</p>
                    </div>
                ) : (
                    years.map(year => (
                        <div key={year} className="mb-10">
                            <div className="flex items-center mb-6">
                                <div className={`px-6 py-2 rounded-full text-sm font-bold shadow-md ${year === '2026' ? 'bg-orange-600 text-white' : 'bg-slate-700 text-white'}`}>
                                    {year === '2026' ? 'Periodo Actual' : year}
                                </div>
                                <div className="h-px bg-slate-200 flex-grow ml-4"></div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                {courses.filter(c => c.year === year).map((c, i) => (
                                    <div key={i} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all hover:-translate-y-1 group">
                                        <div className="flex justify-between items-start mb-3">
                                            <span className={`text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide ${c.type.toUpperCase().includes('PROFESIONAL') ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {c.type}
                                            </span>
                                            <span className="text-xs font-mono font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded">{c.folio}</span>
                                        </div>
                                        <h3 className="font-bold text-lg text-slate-800 mb-3 leading-tight group-hover:text-orange-600 transition-colors">{c.courseName}</h3>
                                        
                                        <div className="space-y-2 pt-3 border-t border-slate-50">
                                            <div className="flex items-center text-sm text-slate-600">
                                                <span className="w-6 text-center mr-2">üìÖ</span> {c.datesText}
                                            </div>
                                            <div className="flex items-center text-sm text-slate-600">
                                                <span className="w-6 text-center mr-2">‚è±Ô∏è</span> {c.hours} horas de capacitaci√≥n
                                            </div>
                                            <div className="flex items-center text-sm text-slate-500 italic">
                                                <span className="w-6 text-center mr-2">üèõÔ∏è</span> {c.deptOrigin || 'Desarrollo Acad√©mico'}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))
                )}
            </div>
        );
    };

    const App = () => {
        const [user, setUser] = useState(null);
        const [data, setData] = useState(null);
        const [loading, setLoading] = useState(false);

        const handleLogin = (response) => {
            setLoading(true);
            try {
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'getTeacherHistory', id_token: response.credential, email: payload.email })
                    })
                    .then(r => r.json())
                    .then(res => {
                        if(res.success) {
                            setUser({ name: payload.name, email: payload.email, picture: payload.picture, token: response.credential });
                            setData(res.data);
                        } else { alert("Error: " + res.message); }
                    })
                    .finally(() => setLoading(false));
            } catch(e) { setLoading(false); }
        };

        const handleLogout = () => { setUser(null); setData(null); };

        if(loading) return (
            <div className="flex flex-col justify-center items-center h-screen bg-slate-50">
                <div className="animate-spin h-12 w-12 border-4 border-orange-500 rounded-full border-t-transparent mb-4"></div>
                <p className="text-slate-500 font-bold animate-pulse">Cargando tu historial...</p>
            </div>
        );
        
        if(!user || !data) return <div className="container mx-auto px-4 pt-10"><LoginScreen onLogin={handleLogin} /></div>;
        
        return <Dashboard user={user} data={data} onLogout={handleLogout} />;
    };

    window.onload = () => {
         const rootEl = document.getElementById('root');
         if(rootEl && window.ReactDOM) window.ReactDOM.createRoot(rootEl).render(<App />);
    };
</script>
    </body>
</html>
]]></content>
</change>
</changes>
