<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscripción a Cursos - ITD</title>
    <meta name="description" content="Inscríbete a los cursos de actualización docente del Instituto Tecnológico de Durango. Consulta la oferta académica, selecciona tus cursos y regístrate en línea.">
    <meta name="keywords" content="inscripciones ITD, cursos ITD, registro cursos, actualización docente, TecNM Durango">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between gap-4 py-4 min-h-[100px]">
                <div class="flex-shrink-0">
                    <img class="h-16 md:h-20 lg:h-24" src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="Logo TecNM">
                </div>
                <div class="text-center flex-1 px-2">
                    <h1 class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-blue-900">
                        SISTEMA DE INSCRIPCIÓN A CURSOS DE ACTUALIZACIÓN DOCENTE
                    </h1>
                    <h2 class="text-sm sm:text-base md:text-lg text-blue-900 mt-1">
                        INSTITUTO TECNOLÓGICO DE DURANGO
                    </h2>
                </div>
                <div class="flex-shrink-0">
                    <img class="h-16 md:h-20 lg:h-24" src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="Logo Instituto Tecnológico de Durango">
                </div>
            </div>
        </div>
    </header>

    <div id="root"></div>

    <footer class="bg-blue-800 text-white text-center p-4 mt-auto border-t-8 border-b-8 border-red-900">
        <p class="font-semibold text-sm sm:text-base">© Coordinación de actualización docente</p>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz2hpmaNoCj0Zy0mzl8mvYU978u7llspIFMyNuqt7VRu7Xi3yK3vkkOFNDWyokPVl5ODw/exec'
        };
        
        const DEPARTMENTS = [
            "ADMINISTRATIVO",
            "DEPARTAMENTO DE CIENCIAS BASICAS",
            "DEPARTAMENTO DE CIENCIAS DE LA TIERRA",
            "DEPARTAMENTO DE CIENCIAS ECONOMICO ADMINISTRATIVAS",
            "DEPARTAMENTO DE INGENIERÍA ELÉCTRICA Y ELECTRÓNICA",
            "DEPARTAMENTO DE INGENIERÍA INDUSTRIAL",
            "DEPARTAMENTO DE INGENIERÍA QUÍMICA BIOQUÍMICA",
            "DEPARTAMENTO DE METAL MECÁNICA",
            "DEPARTAMENTO DE SISTEMAS Y COMPUTACION",
            "DIVISION DE ESTUDIOS DE POSGRADO E INVESTIGACION",
            "EDUCACION A DISTANCIA"
        ].sort();

        // ============================================================================
        // === FUNCIONES DE UTILIDAD ==================================================
        // ============================================================================
        
        const removeAccents = (text) => {
            if (!text) return '';
            return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        };

        // ============================================================================
        // === COMPONENTES DE LA UI ==================================================
        // ============================================================================

        function Spinner() {
            return (
                <div className="flex justify-center items-center h-64">
                    <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-600"></div>
                </div>
            );
        }

        function StepIndicator({ currentStep }) {
            const steps = ["Información", "Cursos", "Confirmar", "Finalizado"];
            return (
                <div className="flex justify-between items-center mb-8 px-4">
                    {steps.map((step, index) => {
                        const stepNumber = index + 1;
                        const isCompleted = currentStep > stepNumber;
                        const isActive = currentStep === stepNumber;
                        return (
                            <React.Fragment key={step}>
                                <div className="flex flex-col items-center">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white transition-colors ${isCompleted ? 'bg-green-500' : isActive ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                        {isCompleted ? '✓' : stepNumber}
                                    </div>
                                    <p className={`mt-2 text-xs text-center font-semibold ${isActive ? 'text-blue-600' : 'text-gray-500'}`}>{step}</p>
                                </div>
                                {stepNumber < steps.length && <div className={`flex-1 h-1 mx-2 ${isCompleted ? 'bg-green-500' : 'bg-gray-300'}`}></div>}
                            </React.Fragment>
                        );
                    })}
                </div>
            );
        }
        
        // --- COMPONENTE DE AUTOCOMPLETADO (BASADO EN EL EJEMPLO QUE FUNCIONA) ---
        function AutocompleteInput({ items, onSelect, value, onChange, placeholder }) {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowSuggestions(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const handleInputChange = (e) => {
                const currentValue = e.target.value;
                onChange(e); // Llama al onChange del padre

                if (currentValue && currentValue.length > 0) {
                    const normalizedInput = removeAccents(currentValue.toLowerCase());
                    const filtered = items.filter(item =>
                        item && item.nombre && removeAccents(item.nombre.toLowerCase()).includes(normalizedInput)
                    ).slice(0, 7); // Muestra hasta 7 sugerencias
                    setSuggestions(filtered);
                    setShowSuggestions(filtered.length > 0);
                } else {
                    setSuggestions([]);
                    setShowSuggestions(false);
                }
            };

            const handleSelect = (item) => {
                onSelect(item); // Llama al onSelect del padre
                setShowSuggestions(false);
            };

            return (
                <div className="relative" ref={containerRef}>
                    <input
                        type="text"
                        value={value}
                        onChange={handleInputChange}
                        onFocus={() => { if (value) setShowSuggestions(true); }}
                        placeholder={placeholder || "Escriba un nombre"}
                        className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 uppercase"
                        autoComplete="off"
                    />
                    {showSuggestions && suggestions.length > 0 && (
                        <ul className="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-auto">
                            {suggestions.map((item, index) => (
                                <li
                                    key={item.email || index}
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        handleSelect(item);
                                    }}
                                    className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
                                >
                                    {item.nombre} {item.departamento && <span className="text-sm text-gray-500 ml-2">({item.departamento})</span>}
                                </li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        }

        // --- COMPONENTE Step1TeacherInfo CORREGIDO Y USANDO AutocompleteInput ---
        function Step1TeacherInfo({ formData, setFormData, onNext, teachers }) {

            const handleTeacherSelect = (teacher) => {
                setFormData(prev => ({
                    ...prev,
                    fullName: teacher.nombre.toUpperCase(),
                    email: teacher.email || '',
                    department: teacher.departamento || ''
                }));
            };
            
            const handleNameChange = (e) => {
                const newName = e.target.value.toUpperCase();
                const exactMatch = teachers.find(t => t.nombre.toUpperCase() === newName);
                
                setFormData(prev => ({
                    ...prev,
                    fullName: newName,
                    email: exactMatch ? exactMatch.email : '',
                    department: exactMatch ? exactMatch.departamento : ''
                }));
            };

            const isFormValid = formData.fullName && formData.curp && formData.email && formData.gender && formData.department;

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Información Personal</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="relative">
                            <label className="block text-sm font-medium text-gray-700">Nombre Completo *</label>
                            <AutocompleteInput
                                items={teachers}
                                value={formData.fullName}
                                onChange={handleNameChange}
                                onSelect={handleTeacherSelect}
                                placeholder="Escriba su nombre y seleccione"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">CURP *</label>
                            <input type="text" value={formData.curp} onChange={e => setFormData(prev => ({ ...prev, curp: e.target.value.toUpperCase() }))} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 uppercase" placeholder="18 caracteres" maxLength="18" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Email Institucional *</label>
                            <input type="email" value={formData.email} onChange={e => setFormData(prev => ({ ...prev, email: e.target.value }))} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="email@itdurango.edu.mx" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Género *</label>
                            <select value={formData.gender} onChange={e => setFormData(prev => ({ ...prev, gender: e.target.value }))} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="">Seleccione un género</option>
                                <option value="Mujer">Mujer</option>
                                <option value="Hombre">Hombre</option>
                            </select>
                        </div>
                        <div className="md:col-span-2">
                            <label className="block text-sm font-medium text-gray-700">Departamento *</label>
                            <select value={formData.department} onChange={e => setFormData(prev => ({ ...prev, department: e.target.value }))} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                <option value="">Seleccione un departamento</option>
                                {DEPARTMENTS.map(dep => (
                                    <option key={dep} value={dep}>{dep}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    <div className="mt-6 text-right">
                        <button onClick={onNext} disabled={!isFormValid} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50">
                            Continuar
                        </button>
                    </div>
                </div>
            );
        }

        function Step2CourseSelection({ formData, setFormData, onNext, onBack, courses }) {
            const [filters, setFilters] = useState({ period: 'Enero - Junio 2025', type: 'Todos' });
            
            const handleCourseSelect = (course, isSelected) => {
                setFormData(prev => {
                    const currentSelection = prev.selectedCourses || [];
                    if (isSelected) {
                        return { ...prev, selectedCourses: [...currentSelection, course] };
                    } else {
                        return { ...prev, selectedCourses: currentSelection.filter(c => c.id_curso !== course.id_curso) };
                    }
                });
            };

            const availablePeriods = useMemo(() => [...new Set(courses.map(c => c.periodo))], [courses]);
            const availableTypes = useMemo(() => ['Todos', ...new Set(courses.map(c => c.tipo))], [courses]);
            
            const filteredCourses = useMemo(() => {
                return courses.filter(course =>
                    course.estado === 'Activo' &&
                    course.periodo === filters.period &&
                    (filters.type === 'Todos' || course.tipo === filters.type)
                );
            }, [courses, filters]);

            const selectedCount = (formData.selectedCourses || []).length;

            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Selección de Cursos</h3>
                    <div className="flex gap-4 mb-4">
                        {/* Aquí podrías agregar los filtros si los necesitas */}
                    </div>
                    {filteredCourses.map(course => (
                        <div key={course.id_curso} className="mb-2 p-2 border rounded">
                            <input 
                                type="checkbox" 
                                id={course.id_curso} 
                                disabled={selectedCount >= 3 && !(formData.selectedCourses || []).find(c => c.id_curso === course.id_curso)}
                                checked={(formData.selectedCourses || []).some(c => c.id_curso === course.id_curso)}
                                onChange={e => handleCourseSelect(course, e.target.checked)}
                            />
                            <label htmlFor={course.id_curso} className="ml-2">{course.nombre_curso}</label>
                        </div>
                    ))}
                    <div className="mt-6 flex justify-between">
                        <button onClick={onBack} className="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Atrás</button>
                        <button onClick={onNext} disabled={selectedCount === 0} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50">Continuar</button>
                    </div>
                </div>
            );
        }

        function Step3Confirm({ formData, onBack, onSubmit }) {
            return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Confirmar Inscripción</h3>
                    <p><strong>Nombre:</strong> {formData.fullName}</p>
                    <p><strong>Cursos Seleccionados:</strong></p>
                    <ul>
                        {(formData.selectedCourses || []).map(c => <li key={c.id_curso}>- {c.nombre_curso}</li>)}
                    </ul>
                    <div className="mt-6 flex justify-between">
                        <button onClick={onBack} className="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Atrás</button>
                        <button onClick={onSubmit} className="bg-green-500 text-white font-bold py-2 px-6 rounded-lg">Confirmar e Inscribir</button>
                    </div>
                </div>
            );
        }

        function Step4Finalized({ results, onReset }) {
             return (
                <div>
                    <h3 className="text-xl font-bold mb-4">Resultado de la Inscripción</h3>
                    {results.map(result => (
                        <div key={result.courseId} className={`p-4 border-l-4 rounded-r-lg mb-2 ${result.success ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`}>
                            <h4 className="font-bold">{result.courseName}</h4>
                            <p className={`text-sm ${result.success ? 'text-green-800' : 'text-red-800'}`}>{result.message}</p>
                        </div>
                    ))}
                    <div className="mt-6 text-center">
                        <button onClick={onReset} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Realizar otra inscripción</button>
                    </div>
                </div>
            );
        }


        // ============================================================================
        // === COMPONENTE PRINCIPAL DE LA APLICACIÓN =================================
        // ============================================================================

        function InscripcionesApp() {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({ fullName: '', curp: '', email: '', gender: '', department: '', selectedCourses: [] });
            const [courses, setCourses] = useState([]);
            const [teachers, setTeachers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [submissionResults, setSubmissionResults] = useState([]);

            useEffect(() => {
                async function loadInitialData() {
                    setLoading(true);
                    setError(null);
                    const cacheBuster = `&ts=${new Date().getTime()}`;
                    const fetchOptions = { method: 'GET', mode: 'cors', redirect: 'follow' };

                    try {
                        const coursesRes = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getCoursesList${cacheBuster}`, fetchOptions);
                        if (!coursesRes.ok) throw new Error(`No se pudo conectar con el servidor de cursos (código: ${coursesRes.status}).`);
                        const coursesData = await coursesRes.json();
                        if (!coursesData.success) throw new Error(`Error del servidor al cargar cursos: ${coursesData.message || 'Respuesta no válida'}`);
                        setCourses(coursesData.data || []);

                        const teachersRes = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getTeachersList${cacheBuster}`, fetchOptions);
                        if (!teachersRes.ok) throw new Error(`No se pudo conectar con el servidor de docentes (código: ${teachersRes.status}).`);
                        const teachersData = await teachersRes.json();
                        if (!teachersData.success) throw new Error(`Error del servidor al cargar docentes: ${teachersData.message || 'Respuesta no válida'}`);
                        setTeachers(teachersData.data || []);

                    } catch (err) {
                        console.error("Fallo en loadInitialData:", err);
                        setError(err.message || "Ocurrió un error inesperado al cargar los datos iniciales.");
                    } finally {
                        setLoading(false);
                    }
                }
                loadInitialData();
            }, []);
            
            const handleNext = () => setStep(prev => prev + 1);
            const handleBack = () => setStep(prev => prev - 1);
            const handleReset = () => {
                setStep(1);
                setFormData({ fullName: '', curp: '', email: '', gender: '', department: '', selectedCourses: [] });
                setSubmissionResults([]);
            };

            const handleSubmit = async () => {
                setLoading(true);
                setStep(4);
                const results = [];
                for (const course of formData.selectedCourses) {
                    try {
                        const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                            method: 'POST',
                            mode: 'cors',
                            redirect: 'follow',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({ action: 'registerCourse', ...formData, course: course })
                        });
                        const result = await response.json();
                        results.push({ ...result, courseId: course.id_curso, courseName: course.nombre_curso });
                    } catch (err) {
                        results.push({ success: false, message: 'Error de conexión', courseId: course.id_curso, courseName: course.nombre_curso });
                    }
                }
                setSubmissionResults(results);
                setLoading(false);
            };

            const renderStep = () => {
                if (loading && step < 4) return <Spinner />;
                if (error) return <div className="text-red-500 text-center p-4 bg-red-50 border border-red-200 rounded-md">{error}</div>;

                switch (step) {
                    case 1: return <Step1TeacherInfo formData={formData} setFormData={setFormData} onNext={handleNext} teachers={teachers} />;
                    case 2: return <Step2CourseSelection formData={formData} setFormData={setFormData} onNext={handleNext} onBack={handleBack} courses={courses} />;
                    case 3: return <Step3Confirm formData={formData} onBack={handleBack} onSubmit={handleSubmit} />;
                    case 4: return <Step4Finalized results={submissionResults} onReset={handleReset} />;
                    default: return <div>Paso no válido</div>;
                }
            };
            
            return (
                <main className="container mx-auto px-4 py-8">
                    <a href="index.html" className="text-blue-600 hover:underline mb-4 inline-block">← Volver al Portal</a>
                    <div className="bg-white rounded-lg shadow-xl p-6">
                        <StepIndicator currentStep={step} />
                        {renderStep()}
                    </div>
                </main>
            );
        }

        window.addEventListener('load', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<InscripcionesApp />);
        });
    </script>
</body>
</html>
