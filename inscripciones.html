<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscripción a Cursos - ITD</title>
    <meta name="description" content="Inscríbete a los cursos de actualización docente del Instituto Tecnológico de Durango. Consulta la oferta disponible y asegura tu lugar.">
    
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://cdn.jsdelivr.net/gh/DA-itd/web/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">INSCRIPCIÓN A CURSOS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">Desarrollo Académico</p>
                </div>
                <img src="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-semibold text-sm sm:text-base mb-2">© Coordinación de Actualización Docente</p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // ============================================================================
        // === CONFIGURACIÓN Y SERVICIOS =============================================
        // ============================================================================
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwaCOFUQFQnvuCEVJU33uNsILIGaVTuv_aREuMdqxrsKYAZ7dtYNtWxX3LdqwP614i6/exec',
            // **IMPORTANTE**: Reemplaza estas URLs con las URLs de TUS hojas publicadas como CSV
            COURSES_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ.../pub?gid=...&single=true&output=csv',
            TEACHERS_CSV_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ.../pub?gid=...&single=true&output=csv'
        };

        const parseCSV = (text) => {
            const rows = text.split(/\r?\n/).map(row => row.split(','));
            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).map(row => {
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = row[i] ? row[i].trim() : '';
                });
                return obj;
            });
        };

        const fetchDataFromCSV = async (url) => {
            const cacheBustingUrl = `${url}&_=${new Date().getTime()}`;
            const response = await fetch(cacheBustingUrl);
            if (!response.ok) throw new Error(`No se pudo cargar: ${url}`);
            const text = await response.text();
            return parseCSV(text);
        };
        
        const postData = async (data) => {
            const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error(`Error de red: ${response.status}`);
            return await response.json();
        };

        // ============================================================================
        // === COMPONENTES (Definidos antes de usarse) ===============================
        // ============================================================================
        const Spinner = () => (
            <div className="flex justify-center items-center h-64">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-800"></div>
            </div>
        );

        const StepIndicator = ({ currentStep }) => (
            <div className="flex justify-center items-center space-x-4 sm:space-x-8 mb-8">
                {['Información', 'Cursos', 'Confirmar', 'Finalizado'].map((label, index) => {
                    const stepNumber = index + 1;
                    const isActive = stepNumber === currentStep;
                    const isCompleted = stepNumber < currentStep;
                    return (
                        <div key={label} className="flex flex-col items-center text-center">
                            <div className={`w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-bold text-white ${isCompleted ? 'bg-green-500' : isActive ? 'bg-blue-600' : 'bg-gray-300'}`}>
                                {isCompleted ? '✓' : stepNumber}
                            </div>
                            <span className={`mt-2 text-xs sm:text-sm ${isActive ? 'text-blue-600 font-bold' : 'text-gray-500'}`}>{label}</span>
                        </div>
                    );
                })}
            </div>
        );
        
        const Step1PersonalInfo = ({ onNext, formData, setFormData, teachers }) => {
            const handleTeacherSelect = (e) => {
                const selectedEmail = e.target.value;
                const selectedTeacher = teachers.find(t => t.email === selectedEmail);
                setFormData(prev => ({
                    ...prev,
                    email: selectedEmail,
                    nombreCompleto: selectedTeacher ? selectedTeacher.nombre_completo : '',
                    departamento: selectedTeacher ? selectedTeacher.departamento : '',
                }));
            };

            return (
                <div>
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Información Personal</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                            <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email Institucional *</label>
                            <select id="email" value={formData.email} onChange={handleTeacherSelect} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" required>
                                <option value="">Seleccione su correo...</option>
                                {teachers.map(teacher => <option key={teacher.email} value={teacher.email}>{teacher.email}</option>)}
                            </select>
                        </div>
                        <div>
                            <label htmlFor="nombreCompleto" className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                            <input type="text" id="nombreCompleto" value={formData.nombreCompleto} readOnly className="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" />
                        </div>
                        <div>
                            <label htmlFor="curp" className="block text-sm font-medium text-gray-700">CURP *</label>
                            <input type="text" id="curp" value={formData.curp} onChange={e => setFormData(p => ({ ...p, curp: e.target.value.toUpperCase() }))} maxLength="18" className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required />
                        </div>
                        <div>
                            <label htmlFor="genero" className="block text-sm font-medium text-gray-700">Género *</label>
                            <select id="genero" value={formData.genero} onChange={e => setFormData(p => ({ ...p, genero: e.target.value }))} className="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md" required>
                                <option value="">Seleccione...</option>
                                <option value="Hombre">Hombre</option>
                                <option value="Mujer">Mujer</option>
                            </select>
                        </div>
                        <div className="sm:col-span-2">
                            <label htmlFor="departamento" className="block text-sm font-medium text-gray-700">Departamento</label>
                            <input type="text" id="departamento" value={formData.departamento} readOnly className="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md" />
                        </div>
                    </div>
                    <div className="mt-8 flex justify-end">
                        <button onClick={onNext} disabled={!formData.email || !formData.curp || !formData.genero} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50">Siguiente</button>
                    </div>
                </div>
            );
        };
        
        const Step2CourseSelection = ({ onBack, onNext, formData, setFormData, courses }) => {
            const handleCourseChange = (e, index) => {
                const { value } = e.target;
                const newSelection = [...formData.selectedCourses];
                newSelection[index] = value;
                setFormData(p => ({ ...p, selectedCourses: newSelection.filter(c => c) }));
            };
            const addCourseSelector = () => {
                if (formData.selectedCourses.length < 3) {
                    setFormData(p => ({ ...p, selectedCourses: [...p.selectedCourses, ''] }));
                }
            };
            const availableCourses = courses.filter(course => !formData.selectedCourses.includes(course['ID Curso']));

            return (
                <div>
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Selección de Cursos</h3>
                    <div className="space-y-4">
                        {formData.selectedCourses.map((selected, index) => (
                            <div key={index}>
                                <label className="block text-sm font-medium text-gray-700">Curso {index + 1}</label>
                                <select value={selected} onChange={e => handleCourseChange(e, index)} className="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md">
                                    <option value="">Seleccione un curso...</option>
                                    {selected && <option value={selected}>{(courses.find(c => c['ID Curso'] === selected) || {})['Nombre Curso']}</option>}
                                    {availableCourses.map(course => <option key={course['ID Curso']} value={course['ID Curso']}>{course['Nombre Curso']}</option>)}
                                </select>
                            </div>
                        ))}
                    </div>
                    {formData.selectedCourses.length < 3 && (
                        <button onClick={addCourseSelector} className="mt-4 text-sm text-blue-600 hover:underline">+ Agregar otro curso</button>
                    )}
                    <div className="mt-8 flex justify-between">
                        <button onClick={onBack} className="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Atrás</button>
                        <button onClick={onNext} disabled={formData.selectedCourses.length === 0} className="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50">Siguiente</button>
                    </div>
                </div>
            );
        };

        const Step3Confirm = ({ onBack, onSubmit, formData, courses }) => {
            const selectedCourseDetails = formData.selectedCourses.map(id => courses.find(c => c['ID Curso'] === id)).filter(Boolean);
            return (
                <div>
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Confirmar Inscripción</h3>
                    <div className="bg-gray-50 p-4 rounded-lg space-y-4">
                        <div>
                            <h4 className="font-semibold">Información Personal</h4>
                            <p><strong>Nombre:</strong> {formData.nombreCompleto}</p>
                            <p><strong>Email:</strong> {formData.email}</p>
                            <p><strong>CURP:</strong> {formData.curp}</p>
                            <p><strong>Departamento:</strong> {formData.departamento}</p>
                        </div>
                        <div>
                            <h4 className="font-semibold">Cursos Seleccionados</h4>
                            <ul className="list-disc pl-5">
                                {selectedCourseDetails.map(course => <li key={course['ID Curso']}>{course['Nombre Curso']} ({course.FechaCurso})</li>)}
                            </ul>
                        </div>
                    </div>
                    <div className="mt-8 flex justify-between">
                        <button onClick={onBack} className="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg">Atrás</button>
                        <button onClick={onSubmit} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar y Enviar</button>
                    </div>
                </div>
            );
        };

        const Step4Final = ({ results, onReset, courses }) => (
            <div className="text-center">
                <h3 className="text-2xl font-bold text-green-600 mb-4">Resultados de la Inscripción</h3>
                <div className="space-y-4 text-left">
                    {results.map(result => {
                        const course = courses.find(c => c['ID Curso'] === result.courseId);
                        const courseName = course ? course['Nombre Curso'] : 'Curso Desconocido';
                        return (
                            <div key={result.courseId} className={`p-4 border-l-4 rounded-r-lg ${result.success ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`}>
                                <h3 className="font-bold">{courseName}</h3>
                                <p className={`text-sm ${result.success ? 'text-green-800' : 'text-red-800'}`}>{result.message}</p>
                            </div>
                        );
                    })}
                </div>
                <button onClick={onReset} className="mt-8 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg">Realizar otra inscripción</button>
            </div>
        );

        // ============================================================================
        // === COMPONENTE PRINCIPAL ===================================================
        // ============================================================================
        const InscripcionesApp = () => {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                nombreCompleto: '', email: '', curp: '', genero: '', departamento: '', selectedCourses: ['']
            });
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [courses, setCourses] = useState([]);
            const [teachers, setTeachers] = useState([]);
            const [submissionResults, setSubmissionResults] = useState([]);

            useEffect(() => {
                const loadInitialData = async () => {
                    try {
                        const [coursesData, teachersData] = await Promise.all([
                            fetchDataFromCSV(CONFIG.COURSES_CSV_URL),
                            fetchDataFromCSV(CONFIG.TEACHERS_CSV_URL)
                        ]);
                        setCourses(coursesData.filter(c => c.Estado === 'Activo'));
                        setTeachers(teachersData);
                    } catch (err) {
                        setError("Error al cargar datos. Asegúrese de que las URLs en el código son correctas y las hojas están publicadas como CSV.");
                    } finally {
                        setLoading(false);
                    }
                };
                loadInitialData();
            }, []);

            const handleNext = () => setStep(prev => prev + 1);
            const handleBack = () => setStep(prev => prev - 1);
            const handleReset = () => {
                setFormData({ nombreCompleto: '', email: '', curp: '', genero: '', departamento: '', selectedCourses: [''] });
                setStep(1);
            };

            const handleSubmit = async () => {
                setStep(4);
                setLoading(true);
                const results = [];
                for (const courseId of formData.selectedCourses) {
                    if (!courseId) continue;
                    try {
                        const response = await postData({ action: 'registerCourse', ...formData, id_curso: courseId });
                        results.push({ courseId, success: response.success, message: response.message });
                    } catch (err) {
                        results.push({ courseId, success: false, message: err.message });
                    }
                }
                setSubmissionResults(results);
                setLoading(false);
            };
            
            const renderContent = () => {
                if (loading && step !== 4) return <Spinner />;
                if (error) return <div className="text-red-600 text-center p-8">{error}</div>;

                switch(step) {
                    case 1: return <Step1PersonalInfo onNext={handleNext} formData={formData} setFormData={setFormData} teachers={teachers} />;
                    case 2: return <Step2CourseSelection onBack={handleBack} onNext={handleNext} formData={formData} setFormData={setFormData} courses={courses} />;
                    case 3: return <Step3Confirm onBack={handleBack} onSubmit={handleSubmit} formData={formData} courses={courses} />;
                    case 4: return loading ? <Spinner /> : <Step4Final results={submissionResults} onReset={handleReset} courses={courses} />;
                    default: return <p>Paso desconocido</p>;
                }
            };

            return (
                <main className="container mx-auto px-4 py-8 sm:py-12">
                    <div className="max-w-3xl mx-auto">
                        <a href="index.html" className="text-blue-600 hover:underline mb-4 inline-block">← Volver al Portal</a>
                        <div className="bg-white rounded-lg shadow-xl p-6 sm:p-8">
                            <StepIndicator currentStep={step} />
                            {renderContent()}
                        </div>
                    </div>
                </main>
            );
        };
        
        window.addEventListener('load', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<InscripcionesApp />);
        });
    </script>

</body>
</html>
