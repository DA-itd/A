<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas de Opini√≥n - ITD</title>
    <meta name="description" content="Participa en las encuestas de opini√≥n y eficacia para evaluar los cursos de actualizaci√≥n docente del ITD. Tu retroalimentaci√≥n es importante.">
    <meta name="keywords" content="encuestas ITD, evaluaci√≥n de cursos, opini√≥n docente, eficacia cursos, mejora continua">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" 
                     alt="TecNM" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
                
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">
                        ENCUESTAS DE OPINI√ìN Y EFICACIA
                    </h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">
                        Desarrollo Acad√©mico
                    </p>
                </div>
                
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" 
                     alt="ITD" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-semibold text-sm sm:text-base mb-2">
                ¬© Coordinaci√≥n de Actualizaci√≥n Docente
            </p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        
        const SURVEY_CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbz99U2AFCliLI34Aqh7nK__MT0NNIsE1DKr7glVGL7zxJhfxiR8izQUaD1BgPDVe5DNow/exec',
            SESSION_TIMEOUT_MINUTES: 30,
            opinion: {
                url: 'https://forms.gle/BBLvYmwzQDbFESXF7',
                courseNameEntryId: 'entry.152060533',
                departmentEntryId: 'entry.1854497676'
            },
            eficacia: {
                url: 'https://forms.gle/G1HUp2thYPbvy7t49',
                fullNameEntryId: 'entry.198393507',
                departmentEntryId: 'entry.864708779'
            }
        };

        const sessionManager = {
            save: (data) => {
                const sessionData = {
                    ...data,
                    timestamp: new Date().getTime()
                };
                localStorage.setItem('survey_session', JSON.stringify(sessionData));
            },
            load: () => {
                const stored = localStorage.getItem('survey_session');
                if (!stored) return null;
                const sessionData = JSON.parse(stored);
                const now = new Date().getTime();
                const elapsedMinutes = (now - sessionData.timestamp) / (1000 * 60);
                if (elapsedMinutes > SURVEY_CONFIG.SESSION_TIMEOUT_MINUTES) {
                    localStorage.removeItem('survey_session');
                    return null;
                }
                return sessionData;
            },
            clear: () => {
                localStorage.removeItem('survey_session');
            }
        };

        const getEficaciaSurveyPeriod = () => {
             const isTestMode = false; 
             if (isTestMode) {
                return { active: true, id: `EFICACIA_TEST`, name: `Periodo de Prueba` };
            }

            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const year = now.getFullYear();

            if ((month === 5 && day >= 15) || month === 6 || (month === 7 && day < 15)) {
                return { active: true, id: `EFICACIA_${year}_1`, name: `Mayo-Julio ${year}` };
            }
            if ((month === 11 && day >= 15) || month === 12) {
                return { active: true, id: `EFICACIA_${year}_2`, name: `Nov-Ene ${year}` };
            }
            if (month === 1 && day < 15) {
                return { active: true, id: `EFICACIA_${year-1}_2`, name: `Nov-Ene ${year-1}` };
            }
            
            return { active: false, id: null, name: null };
        };

        const getCoursesByEmail = async (email) => {
            const url = new URL(SURVEY_CONFIG.APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getCoursesForSurveyByEmail');
            url.searchParams.append('email', email);
            url.searchParams.append('_', Date.now().toString());

            const response = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
            const result = await response.json();

            if (result.success && result.data) {
                return result.data;
            } else {
                throw new Error(result.message || 'No se pudieron cargar los datos.');
            }
        };
        
        const recordSurveyClick = async (data) => {
            const response = await fetch(SURVEY_CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'submitSurveyRecord', ...data })
            });
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || 'Error al registrar la participaci√≥n.');
            }
             return true;
        };

        const RedirectingOverlay = () => {
            return (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 z-50 flex items-center justify-center">
                    <div className="bg-white rounded-lg shadow-xl p-8 text-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                        <p className="text-lg font-semibold text-gray-700">Registrando tu participaci√≥n y redirigiendo a la encuesta...</p>
                    </div>
                </div>
            );
        };

        const LoginStep = ({ onLogin, error }) => {
            useEffect(() => {
                if (window.google) {
                    google.accounts.id.initialize({
                        client_id: SURVEY_CONFIG.GOOGLE_CLIENT_ID,
                        callback: onLogin,
                    });
                    google.accounts.id.prompt((notification) => {
                        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                             console.log('Google prompt no se mostr√≥.');
                        }
                    });
                }
            }, [onLogin]);
            
            const handleManualLogin = () => {
                if (window.google) {
                    google.accounts.id.prompt();
                }
            };
            
            return (
                <div className="animate-fadeIn text-center">
                    <div className="text-6xl mb-4">‚úçÔ∏è</div>
                    <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Bienvenido/a al Sistema de Encuestas</h2>
                    <p className="text-gray-600 mt-2 max-w-2xl mx-auto">
                        Inicie sesi√≥n para acceder a sus encuestas. La ventana de Google deber√≠a aparecer autom√°ticamente.
                    </p>
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-6 text-left" role="alert">
                            <strong className="font-bold">Error de Autenticaci√≥n</strong>
                            <span className="block sm:inline ml-2">{error}</span>
                        </div>
                    )}
                    
                    <div className="mt-8">
                         <button onClick={handleManualLogin} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 mx-auto">
                           <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                           Acceder con Google
                        </button>
                        <p className="text-xs text-gray-500 mt-2">Si la ventana no aparece, haga clic aqu√≠.</p>
                    </div>


                    <div className="mt-6 bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-md text-left max-w-lg mx-auto">
                        <h4 className="font-bold">üîí Su Privacidad es Importante</h4>
                        <p className="text-sm mt-1">
                            Su correo se utiliza √∫nicamente para identificar sus cursos. Las respuestas que env√≠e en los formularios son <strong>completamente an√≥nimas</strong>. No se recopila ni almacena ning√∫n dato personal.
                        </p>
                    </div>
                </div>
            );
        };
        
        const SurveyCard = ({ survey, teacherData, onParticipationChange, registered, onSurveyClick }) => {
            const { type, course, periodInfo } = survey;

            const generateSurveyUrl = () => {
                const config = SURVEY_CONFIG[type];
                if (!config.url || config.url === '#') return '#';
                const url = new URL(config.url);

                if (type === 'opinion') {
                    url.searchParams.set(config.courseNameEntryId, course.name);
                    url.searchParams.set(config.departmentEntryId, teacherData.department);
                } else if (type === 'eficacia') {
                    url.searchParams.set(config.fullNameEntryId, teacherData.fullName);
                    url.searchParams.set(config.departmentEntryId, teacherData.department);
                }
                return url.toString();
            };

            const handleSurveyClick = async () => {
                if (registered) return;
                
                const recordData = {
                    teacherName: teacherData.fullName,
                    teacherEmail: teacherData.email,
                    department: teacherData.department,
                    courseId: type === 'opinion' ? course.id : periodInfo.id,
                    courseName: type === 'opinion' ? course.name : `Encuesta General de Eficacia (${periodInfo.name})`,
                    surveyType: type === 'opinion' ? 'opinion' : 'eficacia'
                };
                
                const surveyUrl = generateSurveyUrl();
                onSurveyClick(recordData, surveyUrl);
            };
            
            const buttonText = type === 'opinion' ? 'üí¨ Responder Encuesta de Opini√≥n' : 'üìà Responder Encuesta de Eficacia';
            const buttonBg = type === 'opinion' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700';

            return (
                <div className={`bg-white p-4 sm:p-6 rounded-lg shadow-md border-l-4 ${type === 'opinion' ? 'border-indigo-500' : 'border-green-500'}`}>
                    <h3 className="text-lg font-bold text-gray-900 mb-3">{type === 'opinion' ? course.name : 'Encuesta General de Eficacia'}</h3>
                     {type === 'eficacia' && (
                        <p className="text-sm text-gray-700 mb-4">
                            Esta encuesta eval√∫a el impacto de los cursos tomados durante el periodo <strong>{periodInfo.name}</strong>. Solo necesita responderla una vez.
                        </p>
                    )}
                    <button
                        onClick={handleSurveyClick}
                        disabled={registered}
                        className={`w-full text-center font-semibold py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2 text-white ${
                            registered
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : buttonBg
                        }`}
                    >
                        {registered ? '‚úîÔ∏è Participaci√≥n Registrada' : buttonText}
                    </button>
                </div>
            );
        };

        const SurveyListStep = ({ teacherData, courses, initialCompleted, onLogout, onSurveyClick }) => {
            const registeredClicks = useMemo(() => new Set(initialCompleted), [initialCompleted]);
            const periodInfo = useMemo(() => getEficaciaSurveyPeriod(), []);
            
            return (
                <div className="animate-fadeIn">
                    <div className="flex justify-between items-center mb-6">
                        <div className="text-left">
                            <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Encuestas Pendientes</h2>
                            <p className="text-gray-600 mt-1">
                                Hola, <strong>{teacherData.fullName}</strong>.
                            </p>
                        </div>
                        <button onClick={onLogout} className="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    <div className="space-y-6">
                        {periodInfo.active && (
                            <SurveyCard
                                survey={{ type: 'eficacia', periodInfo }}
                                teacherData={teacherData}
                                onSurveyClick={onSurveyClick}
                                registered={registeredClicks.has(`eficacia-${periodInfo.id}`)}
                            />
                        )}
                    
                        {courses.length > 0 ? courses.map(course => {
                            const uniqueId = `opinion-${course.id}`;
                            return (
                                <SurveyCard
                                    key={course.id}
                                    survey={{ type: 'opinion', course }}
                                    teacherData={teacherData}
                                    onSurveyClick={onSurveyClick}
                                    registered={registeredClicks.has(uniqueId)}
                                />
                            );
                        }) : (
                             <div className="text-center bg-blue-50 text-blue-800 p-6 rounded-lg">
                                <div className="text-5xl mb-3">üëç</div>
                                <p className="font-semibold">No tienes encuestas de opini√≥n pendientes.</p>
                                <p>¬°Gracias por mantenerte al d√≠a!</p>
                             </div>
                        )}
                    </div>
                </div>
            );
        };

        const SurveyApp = () => {
            const [step, setStep] = useState('loading');
            const [error, setError] = useState(null);
            const [isRedirecting, setIsRedirecting] = useState(false);
            const [appData, setAppData] = useState({
                teacherData: null,
                courses: [],
                completedSurveys: []
            });
            
            const handleLogin = useCallback(async (response) => {
                if (window.google && response.credential) {
                    google.accounts.id.cancel();
                    const decodedToken = JSON.parse(atob(response.credential.split('.')[1]));
                    if (!decodedToken || !decodedToken.email) {
                        setError("No se pudo obtener el correo del usuario.");
                        setStep('login');
                        return;
                    }

                    if (!decodedToken.email.endsWith('@itdurango.edu.mx')) {
                        setError("Por favor, inicie sesi√≥n con una cuenta institucional (@itdurango.edu.mx).");
                        setStep('login');
                        if (window.google) google.accounts.id.disableAutoSelect();
                        return;
                    }
                    
                    const teacherData = await fetchCourseData(decodedToken.email);
                    if (teacherData) {
                        sessionManager.save({ ...teacherData, email: decodedToken.email });
                    }
                }
            }, []);

            const fetchCourseData = useCallback(async (email) => {
                setError(null);
                try {
                    const data = await getCoursesByEmail(email);
                    if (data.teacherData) {
                        setAppData({
                            teacherData: { ...data.teacherData, email },
                            courses: data.courses || [],
                            completedSurveys: data.completedSurveys || []
                        });
                        setStep('list');
                        return data.teacherData;
                    } else {
                        throw new Error('No se encontraron cursos activos para su cuenta.');
                    }
                } catch (err) {
                    setError(err.message || 'Ocurri√≥ un error al buscar. Intente de nuevo.');
                    sessionManager.clear();
                    setStep('login');
                    return null;
                }
            }, [handleLogin]);

            useEffect(() => {
                const session = sessionManager.load();
                if (session && session.email) {
                    fetchCourseData(session.email);
                } else {
                    setStep('login');
                }
            }, [fetchCourseData]);

            const handleLogout = () => {
                sessionManager.clear();
                if (window.google) {
                    google.accounts.id.disableAutoSelect();
                }
                window.location.reload();
            };
            
            const handleSurveyClick = async (recordData, surveyUrl) => {
                setIsRedirecting(true);
                try {
                    await recordSurveyClick(recordData);
                    window.location.href = surveyUrl;
                } catch (error) {
                    console.error("Error al registrar y redirigir:", error);
                    alert("No se pudo registrar su participaci√≥n. Por favor, intente de nuevo.");
                    setIsRedirecting(false);
                }
            };
            
            const renderContent = () => {
                if (step === 'loading') {
                    return (
                        <div className="flex justify-center items-center h-64">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-800"></div>
                        </div>
                    );
                }
                
                if (step === 'login') {
                    return <LoginStep onLogin={handleLogin} error={error} />;
                }
                
                if (step === 'list' && appData.teacherData) {
                    return <SurveyListStep 
                                teacherData={appData.teacherData} 
                                courses={appData.courses} 
                                initialCompleted={appData.completedSurveys}
                                onLogout={handleLogout} 
                                onSurveyClick={handleSurveyClick}
                            />;
                }

                return <LoginStep onLogin={handleLogin} error={"Ocurri√≥ un error inesperado."} />;
            };

            return (
                <React.Fragment>
                    {isRedirecting && <RedirectingOverlay />}
                    <main className="container mx-auto px-4 py-8 sm:py-12">
                        <div className="max-w-3xl mx-auto">
                            <a href="index.html" className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-8">
                                ‚Üê Volver al Portal Principal
                            </a>
                            <div className="bg-white rounded-lg shadow-xl p-6 sm:p-8">
                               {renderContent()}
                            </div>
                        </div>
                    </main>
                </React.Fragment>
            );
        };
        
        window.addEventListener('load', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<SurveyApp />);
        });
    </script>

</body>
</html>