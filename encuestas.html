<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas de Opini√≥n - ITD</title>
    <meta name="description" content="Participa en las encuestas de opini√≥n y eficacia para evaluar los cursos de actualizaci√≥n docente del ITD. Tu retroalimentaci√≥n es importante.">
    <meta name="keywords" content="encuestas ITD, evaluaci√≥n de cursos, opini√≥n docente, eficacia cursos, mejora continua">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" 
                     alt="TecNM" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
                
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">
                        ENCUESTAS DE OPINI√ìn Y EFICACIA
                    </h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">
                        Desarrollo Acad√©mico
                    </p>
                </div>
                
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" 
                     alt="ITD" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-semibold text-sm sm:text-base mb-2">
                ¬© Coordinaci√≥n de Actualizaci√≥n Docente
            </p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState } = React;
        
        // =============================================================================
        // CONFIGURACI√ìN DE ENCUESTAS
        // =============================================================================
        const SURVEY_CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwaCOFUQFQnvuCEVJU33uNsILIGaVTuv_aREuMdqxrsKYAZ7dtYNtWxX3LdqwP614i6/exec',
            opinion: {
                url: 'https://docs.google.com/forms/d/e/1FAIpQLSdc2Y4o4vE-Oq-Q1Fm4iNqPz9m1G7U_x3pT9o2W0k_y8Y5h9w/viewform',
                courseNameEntryId: 'entry.152060533',
                departmentEntryId: 'entry.1854497676'
            },
            eficacia: {
                url: '#', // <-- URL BASE DE LA ENCUESTA DE EFICACIA (PENDIENTE)
                courseNameEntryId: 'entry.XXXXXXXXX',
                departmentEntryId: 'entry.XXXXXXXXX'
            }
        };

        const CURP_REGEX = /^[A-Z]{4}\d{6}[HM][A-Z]{5}[0-9A-Z]\d$/;

        // =============================================================================
        // API SERVICE
        // =============================================================================
        const getCoursesForSurvey = async (curp) => {
            const url = new URL(SURVEY_CONFIG.APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getCoursesForSurvey');
            url.searchParams.append('curp', curp.toUpperCase());
            url.searchParams.append('_', Date.now().toString());

            const response = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
            const result = await response.json();

            if (result.success && result.data) {
                return result.data;
            } else {
                throw new Error(result.message || 'No se pudieron cargar los datos.');
            }
        };

        // =============================================================================
        // COMPONENTES DE LA UI
        // =============================================================================

        const CurpInputStep = ({ onSubmit, isLoading, error, curp, setCurp }) => {
            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(curp);
            };

            return (
                <div className="animate-fadeIn">
                    <div className="text-center mb-6">
                        <div className="text-6xl mb-4">‚úçÔ∏è</div>
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Identificaci√≥n del Docente</h2>
                        <p className="text-gray-600 mt-2 max-w-2xl mx-auto">
                            Por favor, ingrese su CURP para encontrar las encuestas que tiene pendientes.
                        </p>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="max-w-md mx-auto">
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                                {error}
                            </div>
                        )}
                        <div className="mb-4">
                            <label htmlFor="curp" className="block text-sm font-medium text-gray-700 mb-1">CURP</label>
                            <input
                                type="text"
                                id="curp"
                                value={curp}
                                onChange={(e) => setCurp(e.target.value.toUpperCase())}
                                className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Ingrese su CURP de 18 caracteres"
                                required
                                maxLength="18"
                            />
                        </div>
                        <button
                            type="submit"
                            disabled={isLoading || !curp || curp.length !== 18 || !CURP_REGEX.test(curp)}
                            className="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {isLoading && <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>}
                            {isLoading ? 'Buscando...' : 'Buscar mis Encuestas'}
                        </button>
                    </form>
                </div>
            );
        };
        
        const SurveyListStep = ({ teacherData, courses, onReset }) => {
            const generateSurveyUrl = (type, courseName) => {
                const config = SURVEY_CONFIG[type];
                if (!config.url || config.url === '#') return '#';

                const url = new URL(config.url);
                url.searchParams.set(config.courseNameEntryId, courseName);
                url.searchParams.set(config.departmentEntryId, teacherData.department);
                
                return url.toString();
            };

            return (
                <div className="animate-fadeIn">
                    <div className="text-center mb-6">
                        <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Encuestas Pendientes</h2>
                        <p className="text-gray-600 mt-2">
                            Hola, <strong>{teacherData.fullName}</strong>. Seleccione una encuesta para continuar.
                        </p>
                    </div>

                    {courses.length > 0 ? (
                        <div className="space-y-6">
                            {courses.map(course => (
                                <div key={course.id} className="bg-white p-4 sm:p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
                                    <h3 className="text-lg font-bold text-indigo-900 mb-3">{course.name}</h3>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <a
                                            href={generateSurveyUrl('opinion', course.name)}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md transition-colors"
                                        >
                                            üí¨ Responder Encuesta de Opini√≥n
                                        </a>
                                        <a
                                            href={generateSurveyUrl('eficacia', course.name)}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition-colors"
                                        >
                                            üìà Responder Encuesta de Eficacia
                                        </a>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                         <div className="text-center bg-green-50 text-green-800 p-6 rounded-lg">
                            <div className="text-5xl mb-3">üéâ</div>
                            <p className="font-semibold">¬°Felicidades!</p>
                            <p>No tienes encuestas pendientes en este momento.</p>
                         </div>
                    )}
                    
                    <div className="mt-8 text-center">
                        <button onClick={onReset} className="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                            Buscar con otro CURP
                        </button>
                    </div>
                </div>
            );
        };

        // =============================================================================
        // COMPONENTE PRINCIPAL DE LA APLICACI√ìN
        // =============================================================================
        const SurveyApp = () => {
            const [step, setStep] = useState('input'); // 'input' o 'list'
            const [curp, setCurp] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [teacherData, setTeacherData] = useState(null);
            const [pendingCourses, setPendingCourses] = useState([]);

            const handleCurpSubmit = async (submittedCurp) => {
                if (!CURP_REGEX.test(submittedCurp)) {
                    setError("El formato del CURP no es v√°lido.");
                    return;
                }
                
                setIsLoading(true);
                setError(null);

                try {
                    const data = await getCoursesForSurvey(submittedCurp);
                    if (data.courses && data.teacherData) {
                        setTeacherData(data.teacherData);
                        setPendingCourses(data.courses);
                        setStep('list');
                    } else {
                        setError('No se encontraron cursos activos para el CURP proporcionado. Por favor, verif√≠quelo.');
                    }
                } catch (err) {
                    setError(err.message || 'Ocurri√≥ un error al buscar. Intente de nuevo.');
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleReset = () => {
                setStep('input');
                setCurp('');
                setError(null);
                setTeacherData(null);
                setPendingCourses([]);
            };

            return (
                <main className="container mx-auto px-4 py-8 sm:py-12">
                    <div className="max-w-3xl mx-auto">
                        <a href="index.html" className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-8">
                            ‚Üê Volver al Portal Principal
                        </a>
                        
                        <div className="bg-white rounded-lg shadow-xl p-6 sm:p-8">
                           {step === 'input' ? (
                               <CurpInputStep
                                   onSubmit={handleCurpSubmit}
                                   isLoading={isLoading}
                                   error={error}
                                   curp={curp}
                                   setCurp={setCurp}
                               />
                           ) : (
                               <SurveyListStep
                                   teacherData={teacherData}
                                   courses={pendingCourses}
                                   onReset={handleReset}
                               />
                           )}
                        </div>
                    </div>
                </main>
            );
        };
        
        // =============================================================================
        // RENDERIZADO DE LA APLICACI√ìN
        // =============================================================================
        window.addEventListener('load', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<SurveyApp />);
            } else {
                console.error('No se encontr√≥ el elemento root');
            }
        });
    </script>

</body>
</html>