<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas de Opini√≥n - ITD</title>
    <meta name="description" content="Participa en las encuestas de opini√≥n y eficacia para evaluar los cursos de actualizaci√≥n docente del ITD. Tu retroalimentaci√≥n es importante.">
    <meta name="keywords" content="encuestas ITD, evaluaci√≥n de cursos, opini√≥n docente, eficacia cursos, mejora continua">
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" 
                     alt="TecNM" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
                
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">
                        ENCUESTAS DE OPINI√ìn Y EFICACIA
                    </h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">
                        Desarrollo Acad√©mico
                    </p>
                </div>
                
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" 
                     alt="ITD" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-semibold text-sm sm:text-base mb-2">
                ¬© Coordinaci√≥n de Actualizaci√≥n Docente
            </p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        
        // =============================================================================
        // == üìù CONFIGURACI√ìN DE ENCUESTAS üìù ==
        // =============================================================================
        //
        // üëá ¬°ATENCI√ìN! AQU√ç PUEDES CAMBIAR LAS URLS DE TUS ENCUESTAS CADA PERIODO.
        //    Solo necesitas reemplazar el valor dentro de las comillas '...' por el nuevo
        //    enlace de tu formulario de Google.
        //
        //    IMPORTANTE: Tambi√©n necesitar√°s los IDs de las preguntas. Para obtenerlos:
        //    1. Abre tu formulario de Google y haz clic en los 3 puntos (‚ãÆ).
        //    2. Selecciona "Obtener enlace pre-rellenado".
        //    3. Llena los campos de ejemplo (ej: "Curso Demo", "Departamento Demo").
        //    4. Haz clic en "Obtener enlace".
        //    5. El enlace se ver√° as√≠: ...&entry.12345=Curso+Demo&entry.67890=Departamento...
        //       - 'entry.12345' es el courseNameEntryId
        //       - 'entry.67890' es el departmentEntryId
        //
        const SURVEY_CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwaCOFUQFQnvuCEVJU33uNsILIGaVTuv_aREuMdqxrsKYAZ7dtYNtWxX3LdqwP614i6/exec',

            // --- ENCUESTA DE OPINI√ìN (POR CURSO) ---
            opinion: {
                url: 'https://forms.gle/BBLvYmwzQDbFESXF7',
                courseNameEntryId: 'entry.152060533',
                departmentEntryId: 'entry.1854497676'
            },

            // --- ENCUESTA DE EFICACIA (GENERAL, POR PERIODO) ---
            eficacia: {
                url: 'https://forms.gle/G1HUp2thYPbvy7t49', 
                // Esta encuesta solo pide nombre completo y departamento.
                fullNameEntryId: 'entry.198393507',
                departmentEntryId: 'entry.864708779'
            }
        };

        // =============================================================================
        // UTILIDADES
        // =============================================================================
        const jwt_decode = (token) => {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        };
        
        const getEficaciaSurveyPeriod = () => {
            const now = new Date();
            const month = now.getMonth(); // 0 = Enero, 4 = Mayo, 6 = Julio, 10 = Noviembre
            const day = now.getDate();
            const year = now.getFullYear();

            // Periodo 1: 15 de Mayo a 14 de Julio
            const isPeriod1 = (month === 4 && day >= 15) || (month === 5) || (month === 6 && day <= 14);
            // Periodo 2: 15 de Noviembre a 14 de Enero del siguiente a√±o
            const isPeriod2 = (month === 10 && day >= 15) || (month === 11) || (month === 0 && day <= 14);

            if (isPeriod1) return { active: true, id: `EFICACIA_${year}_PERIODO_1`, name: `Periodo Mayo-Julio ${year}` };
            if (isPeriod2) {
                const periodYear = month === 11 ? year : year - 1;
                return { active: true, id: `EFICACIA_${periodYear}_PERIODO_2`, name: `Periodo Noviembre ${periodYear} - Enero ${periodYear + 1}` };
            }
            
            return { active: false, id: null, name: null };
        };


        // =============================================================================
        // API SERVICE
        // =============================================================================
        const getCoursesByEmail = async (email) => {
            const url = new URL(SURVEY_CONFIG.APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getCoursesForSurveyByEmail');
            url.searchParams.append('email', email);
            url.searchParams.append('_', Date.now().toString());

            const response = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
            const result = await response.json();

            if (result.success && result.data) {
                return result.data;
            } else {
                throw new Error(result.message || 'No se pudieron cargar los datos.');
            }
        };
        
        const recordSurveyClick = async (data) => {
            try {
                const response = await fetch(SURVEY_CONFIG.APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'submitSurveyRecord', ...data })
                });
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Error al registrar la participaci√≥n.');
                }
                 return true;
            } catch (error) {
                console.warn("Advertencia: No se pudo registrar el clic de la encuesta.", error);
                return false;
            }
        };

        // =============================================================================
        // COMPONENTES DE LA UI
        // =============================================================================

        const LoginStep = ({ onLogin, error }) => {
            const googleButtonRef = useRef(null);

            const initializeGoogleSignIn = useCallback(() => {
                if (window.google) {
                    google.accounts.id.initialize({
                        client_id: SURVEY_CONFIG.GOOGLE_CLIENT_ID,
                        callback: onLogin,
                        login_uri: window.location.origin,
                        auto_select: true
                    });
                    
                    if (googleButtonRef.current && !googleButtonRef.current.hasChildNodes()) {
                        google.accounts.id.renderButton(
                            googleButtonRef.current,
                            { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
                        );
                    }
                    google.accounts.id.prompt((notification) => {
                      if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        // El prompt no se mostr√≥, as√≠ que podemos manejarlo si es necesario
                      }
                    });
                }
            }, [onLogin]);

            useEffect(() => {
                const checkGoogle = setInterval(() => {
                    if (window.google) {
                        clearInterval(checkGoogle);
                        initializeGoogleSignIn();
                    }
                }, 100);

                return () => clearInterval(checkGoogle);
            }, [initializeGoogleSignIn]);
            
            return (
                <div className="animate-fadeIn text-center">
                    <div className="text-6xl mb-4">‚úçÔ∏è</div>
                    <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Bienvenido/a al Sistema de Encuestas</h2>
                    <p className="text-gray-600 mt-2 max-w-2xl mx-auto">
                        Por favor, inicie sesi√≥n con su cuenta institucional para acceder a sus encuestas pendientes.
                    </p>
                    
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-6 text-left" role="alert">
                            <strong className="font-bold">Error de Autenticaci√≥n</strong>
                            <span className="block sm:inline ml-2">{error}</span>
                        </div>
                    )}
                    
                    <div className="mt-8 flex justify-center">
                        <div ref={googleButtonRef}></div>
                    </div>

                    <div className="mt-6 bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 rounded-md text-left max-w-lg mx-auto">
                        <h4 className="font-bold">üîí Su Privacidad es Importante</h4>
                        <p className="text-sm mt-1">
                            Su correo se utiliza √∫nicamente para identificar sus cursos. Las respuestas que env√≠e en los formularios son <strong>completamente an√≥nimas</strong>. No se recopila ni almacena ning√∫n dato personal.
                        </p>
                    </div>
                </div>
            );
        };
        
        const EficaciaSurveyCard = ({ teacherData, onParticipationChange }) => {
            const [loggingClick, setLoggingClick] = useState(false);
            const [isRegistered, setIsRegistered] = useState(false);
            const periodInfo = useMemo(() => getEficaciaSurveyPeriod(), []);

            if (!periodInfo.active) {
                return null;
            }

            const generateSurveyUrl = () => {
                const config = SURVEY_CONFIG.eficacia;
                if (!config.url || config.url === '#') return '#';

                const url = new URL(config.url);
                url.searchParams.set(config.fullNameEntryId, teacherData.fullName);
                url.searchParams.set(config.departmentEntryId, teacherData.department);
                
                return url.toString();
            };

            const handleSurveyClick = async () => {
                if (loggingClick || isRegistered) return;
                
                setLoggingClick(true);
                const success = await recordSurveyClick({
                    teacherName: teacherData.fullName,
                    teacherEmail: teacherData.email,
                    department: teacherData.department,
                    courseId: periodInfo.id,
                    courseName: `Encuesta General de Eficacia (${periodInfo.name})`,
                    surveyType: 'Eficacia'
                });

                if (success) {
                    setIsRegistered(true);
                    onParticipationChange(periodInfo.id);
                }
                setLoggingClick(false);
            };

            return (
                <div className="animate-fadeIn bg-gradient-to-r from-green-50 to-teal-50 p-4 sm:p-6 rounded-lg shadow-md border-l-4 border-green-500 mb-6">
                    <h3 className="text-lg font-bold text-green-900 mb-2">Encuesta General de Eficacia</h3>
                    <p className="text-sm text-gray-700 mb-4">
                        Esta encuesta eval√∫a el impacto de los cursos tomados durante el periodo <strong>{periodInfo.name}</strong>. Solo necesita responderla una vez.
                    </p>
                    <a
                        href={generateSurveyUrl()}
                        target="_blank"
                        rel="noopener noreferrer"
                        onClick={handleSurveyClick}
                        className={`w-full text-center font-semibold py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2 ${
                            isRegistered || loggingClick
                                ? 'bg-gray-300 text-gray-600 cursor-default pointer-events-none' 
                                : 'bg-green-600 hover:bg-green-700 text-white'
                        } ${loggingClick ? 'opacity-75' : ''}`}
                    >
                        {loggingClick && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>}
                        {isRegistered ? '‚úîÔ∏è Participaci√≥n Registrada' : 'üìà Responder Encuesta de Eficacia'}
                    </a>
                </div>
            );
        };
        
        const SurveyListStep = ({ teacherData, courses, onLogout }) => {
            const [loggingClicks, setLoggingClicks] = useState([]); // <- Cambiado a un array
            const [registeredClicks, setRegisteredClicks] = useState([]);

            const handleParticipationChange = useCallback((uniqueId) => {
                setRegisteredClicks(prev => [...prev, uniqueId]);
            }, []);

            const generateOpinionSurveyUrl = (courseName) => {
                const config = SURVEY_CONFIG.opinion;
                if (!config.url || config.url === '#') return '#';

                const url = new URL(config.url);
                url.searchParams.set(config.courseNameEntryId, courseName);
                url.searchParams.set(config.departmentEntryId, teacherData.department);
                
                return url.toString();
            };
            
            const handleRecordOpinionClick = useCallback(async (course) => {
                const uniqueId = `opinion-${course.id}`;
                if (loggingClicks.includes(uniqueId) || registeredClicks.includes(uniqueId)) return;
                
                setLoggingClicks(prev => [...prev, uniqueId]);
                try {
                    const success = await recordSurveyClick({
                        teacherName: teacherData.fullName,
                        teacherEmail: teacherData.email,
                        department: teacherData.department,
                        courseId: course.id,
                        courseName: course.name,
                        surveyType: 'Opinion'
                    });

                    if (success) {
                        handleParticipationChange(uniqueId);
                    }
                } finally {
                    setLoggingClicks(prev => prev.filter(id => id !== uniqueId));
                }
            }, [loggingClicks, registeredClicks, teacherData, handleParticipationChange]);

            return (
                <div className="animate-fadeIn">
                    <div className="flex justify-between items-center mb-6">
                        <div className="text-left">
                            <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Encuestas Pendientes</h2>
                            <p className="text-gray-600 mt-1">
                                Hola, <strong>{teacherData.fullName}</strong>.
                            </p>
                        </div>
                        <button onClick={onLogout} className="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    <EficaciaSurveyCard teacherData={teacherData} onParticipationChange={handleParticipationChange} />
                    
                    {courses.length > 0 ? (
                        <div className="space-y-6">
                            {courses.map(course => {
                                const opinionId = `opinion-${course.id}`;
                                const isOpinionRegistered = registeredClicks.includes(opinionId);
                                const isOpinionLogging = loggingClicks.includes(opinionId);
                                const isOpinionDisabled = isOpinionRegistered || isOpinionLogging;

                                return (
                                <div key={course.id} className="bg-white p-4 sm:p-6 rounded-lg shadow-md border-l-4 border-indigo-500">
                                    <h3 className="text-lg font-bold text-indigo-900 mb-3">{course.name}</h3>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <a
                                            href={generateOpinionSurveyUrl(course.name)}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            onClick={() => handleRecordOpinionClick(course)}
                                            className={`w-full text-center font-semibold py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2 ${
                                                isOpinionDisabled
                                                    ? 'bg-gray-300 text-gray-600 cursor-default pointer-events-none' 
                                                    : 'bg-blue-600 hover:bg-blue-700 text-white'
                                            } ${isOpinionLogging ? 'opacity-75' : ''}`}
                                        >
                                            {isOpinionLogging && <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>}
                                            {isOpinionRegistered ? '‚úîÔ∏è Participaci√≥n Registrada' : 'üí¨ Responder Encuesta de Opini√≥n'}
                                        </a>
                                    </div>
                                </div>
                                );
                            })}
                        </div>
                    ) : (
                         <div className="text-center bg-blue-50 text-blue-800 p-6 rounded-lg">
                            <div className="text-5xl mb-3">üëç</div>
                            <p className="font-semibold">No tienes encuestas de opini√≥n pendientes.</p>
                            <p>¬°Gracias por mantenerte al d√≠a!</p>
                         </div>
                    )}
                </div>
            );
        };

        // =============================================================================
        // COMPONENTE PRINCIPAL DE LA APLICACI√ìN
        // =============================================================================
        const SurveyApp = () => {
            const [step, setStep] = useState('login');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const [teacherData, setTeacherData] = useState(null);
            const [pendingCourses, setPendingCourses] = useState([]);
            
            const handleEmailSubmit = useCallback(async (email) => {
                setIsLoading(true);
                setError(null);

                try {
                    const data = await getCoursesByEmail(email);
                    if (data.courses && data.teacherData) {
                        setTeacherData({ ...data.teacherData, email });
                        setPendingCourses(data.courses);
                        setStep('list');
                    } else {
                        setError('No se encontraron cursos activos para su cuenta. Si cree que esto es un error, contacte a la coordinaci√≥n.');
                        setStep('login');
                    }
                } catch (err) {
                    setError(err.message || 'Ocurri√≥ un error al buscar. Intente de nuevo.');
                    setStep('login');
                } finally {
                    setIsLoading(false);
                }
            }, []);

            const handleLogin = useCallback(async (response) => {
                if (window.google) {
                    google.accounts.id.cancel(); 
                }

                const decodedToken = jwt_decode(response.credential);
                if (!decodedToken || !decodedToken.email) {
                    setError("No se pudo obtener el correo del usuario.");
                    setStep('login');
                    return;
                }

                if (!decodedToken.email.endsWith('@itdurango.edu.mx')) {
                    setError("Por favor, inicie sesi√≥n con una cuenta institucional (@itdurango.edu.mx).");
                    setStep('login');
                    if (window.google) google.accounts.id.disableAutoSelect();
                    return;
                }

                handleEmailSubmit(decodedToken.email);
            }, [handleEmailSubmit]);

            const handleLogout = () => {
                setStep('login');
                setError(null);
                setTeacherData(null);
                setPendingCourses([]);
                if (window.google) {
                    google.accounts.id.disableAutoSelect();
                }
                window.location.reload();
            };
            
            const renderContent = () => {
                if (isLoading) {
                    return (
                        <div className="flex justify-center items-center h-64">
                            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-800"></div>
                        </div>
                    );
                }
                
                switch (step) {
                    case 'login':
                        return <LoginStep onLogin={handleLogin} error={error} />;
                    case 'list':
                        return <SurveyListStep teacherData={teacherData} courses={pendingCourses} onLogout={handleLogout} />;
                    default:
                        return <LoginStep onLogin={handleLogin} error={error} />;
                }
            };

            return (
                <main className="container mx-auto px-4 py-8 sm:py-12">
                    <div className="max-w-3xl mx-auto">
                        <a href="index.html" className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-8">
                            ‚Üê Volver al Portal Principal
                        </a>
                        
                        <div className="bg-white rounded-lg shadow-xl p-6 sm:p-8">
                           {renderContent()}
                        </div>
                    </div>
                </main>
            );
        };
        
        // =============================================================================
        // RENDERIZADO DE LA APLICACI√ìN
        // =============================================================================
        window.addEventListener('load', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<SurveyApp />);
            } else {
                console.error('No se encontr√≥ el elemento root');
            }
        });
    </script>

</body>
</html>
