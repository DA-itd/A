<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuestas de Opinión - ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }
        .course-item {
            transition: all 0.2s ease-in-out;
        }
        .course-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" 
                     alt="TecNM" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
                
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">
                        ENCUESTAS DE OPINIÓN
                    </h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">
                        Desarrollo Académico
                    </p>
                    <p class="text-xs sm:text-sm text-blue-600">
                        TecNM - Instituto Tecnológico de Durango
                    </p>
                </div>
                
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" 
                     alt="ITD" 
                     class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-semibold text-sm sm:text-base mb-2">
                © Coordinación de Actualización Docente
            </p>
            <p class="text-xs sm:text-sm opacity-90">
                M.C. Alejandro Calderón Rentería
            </p>
            <p class="text-xs sm:text-sm opacity-75 mt-1">
                Todos los derechos reservados 2024
            </p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // =============================================================================
        // CONFIGURACIÓN Y CONSTANTES
        // =============================================================================
        const COURSES_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSAe4dmVN4CArjEy_lvI5qrXf16naxZLO1lAxGm2Pj4TrdnoebBg03Vv4-DCXciAkHJFiZaBMKletUs/pub?gid=0&single=true&output=csv';
        const CURP_REGEX = /^[A-Z]{4}\d{6}[HM][A-Z]{5}[0-9A-Z]\d$/;

        // =============================================================================
        // FUNCIONES DE UTILIDAD Y API
        // =============================================================================
        const parseCSVLine = (line) => {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && inQuotes && line[i+1] === '"') { current += '"'; i++; }
                else if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else { current += char; }
            }
            result.push(current.trim());
            return result;
        };
        const cleanCSVValue = (val) => {
            let cleaned = val.trim();
            if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                cleaned = cleaned.substring(1, cleaned.length - 1).replace(/""/g, '"');
            }
            return cleaned;
        };
        const getCourses = async () => {
            try {
                const response = await fetch(`${COURSES_CSV_URL}&_=${Date.now()}`);
                const csvText = await response.text();
                return csvText.trim().split(/\r?\n/).slice(1).filter(l => l.trim()).map(line => {
                    const v = parseCSVLine(line);
                    return { id: cleanCSVValue(v[0]), name: cleanCSVValue(v[1]), dates: cleanCSVValue(v[2]), period: cleanCSVValue(v[3]) };
                });
            } catch (error) { console.error("Error al obtener cursos:", error); return []; }
        };
        
        const getRegistrationByCurp = async (curp) => {
            const APPS_SCRIPT_URL = window.CONFIG?.APPS_SCRIPT_URL;
            if (!APPS_SCRIPT_URL) throw new Error("URL no configurada");
            
            try {
                const url = new URL(APPS_SCRIPT_URL);
                url.searchParams.append('action', 'lookupByCurp');
                url.searchParams.append('curp', curp.toUpperCase());
                url.searchParams.append('_', Date.now().toString());
                
                const response = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
                const result = await response.json();

                if (result?.success && result.data?.registeredCourses) {
                    return result.data.registeredCourses;
                }
                return [];
            } catch (error) {
                console.error("Error al buscar CURP:", error);
                return [];
            }
        };

        const submitSurveyRecord = async (data) => {
            const APPS_SCRIPT_URL = window.CONFIG?.APPS_SCRIPT_URL;
            if (!APPS_SCRIPT_URL) throw new Error("URL no configurada");
            
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'cors', redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'submitSurveyRecord', ...data })
            });
            const result = await response.json();
            if (result?.success) return result;
            throw new Error(result.message || 'Error al registrar encuesta');
        };

        // =============================================================================
        // COMPONENTES DE LA UI
        // =============================================================================
        const Spinner = ({ className }) => (
            <div className={`animate-spin rounded-full border-t-2 border-b-2 h-5 w-5 ${className}`}></div>
        );
        
        const SurveyApp = () => {
            const [allCourses, setAllCourses] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            const [step, setStep] = useState('curp_input'); // 'curp_input', 'course_list'
            const [curp, setCurp] = useState('');
            const [curpError, setCurpError] = useState(null);
            const [isCheckingCurp, setIsCheckingCurp] = useState(false);
            const [userCourses, setUserCourses] = useState([]);
            const [submittingCourse, setSubmittingCourse] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const coursesData = await getCourses();
                        setAllCourses(coursesData);
                    } catch (err) {
                        setError("No se pudieron cargar los datos de los cursos.");
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchData();
            }, []);

            const handleCurpSearch = async (e) => {
                e.preventDefault();
                setError(null);
                setCurpError(null);
                const upperCurp = curp.toUpperCase();
                if (!CURP_REGEX.test(upperCurp)) {
                    setCurpError("Formato de CURP inválido. Deben ser 18 caracteres.");
                    return;
                }
                setIsCheckingCurp(true);
                try {
                    const registeredCourseIds = await getRegistrationByCurp(upperCurp);
                    if (registeredCourseIds.length > 0) {
                        const foundCourses = allCourses.filter(c => registeredCourseIds.includes(c.id));
                        setUserCourses(foundCourses);
                    } else {
                        setUserCourses([]);
                    }
                    setStep('course_list');
                } catch (err) {
                    setError(err instanceof Error ? err.message : "Error al buscar sus cursos.");
                } finally {
                    setIsCheckingCurp(false);
                }
            };

            const handleSurveyRedirect = async (course) => {
                setError(null);
                setSubmittingCourse(course);
                try {
                    await submitSurveyRecord({
                        timestamp: new Date().toISOString(),
                        courseId: course.id,
                        courseName: course.name,
                        surveyUrl: `https://forms.gle/vP4Gk3oWz2qjYx8w9?entry.180439634=${encodeURIComponent(course.name)}`
                    });
                    window.location.href = `https://forms.gle/vP4Gk3oWz2qjYx8w9?entry.180439634=${encodeURIComponent(course.name)}`;
                } catch (err) {
                    setError(err instanceof Error ? err.message : "Error desconocido al procesar la encuesta.");
                    setSubmittingCourse(null);
                }
            };

            const handleReset = () => {
                setStep('curp_input');
                setCurp('');
                setUserCourses([]);
                setError(null);
                setCurpError(null);
                setSubmittingCourse(null);
            };

            const renderContent = () => {
                if (isLoading) {
                    return (
                        <div className="flex justify-center items-center h-40">
                            <Spinner className="border-blue-800 h-12 w-12" />
                        </div>
                    );
                }

                if (step === 'curp_input') {
                    return (
                        <form onSubmit={handleCurpSearch} className="space-y-4">
                            <div>
                                <label htmlFor="curp-input" className="block text-sm font-medium text-gray-700 mb-1">
                                    Ingrese su CURP para ver sus cursos
                                </label>
                                <input
                                    id="curp-input" type="text" value={curp}
                                    onChange={(e) => setCurp(e.target.value)}
                                    placeholder="18 caracteres" maxLength="18" autoFocus
                                    className="w-full px-4 py-2 uppercase border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                />
                                {curpError && <p className="text-red-500 text-xs mt-1">{curpError}</p>}
                            </div>
                            <button
                                type="submit" disabled={isCheckingCurp}
                                className="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-colors disabled:opacity-70"
                            >
                                {isCheckingCurp ? <Spinner className="border-white" /> : "Buscar Cursos"}
                            </button>
                        </form>
                    );
                }

                if (step === 'course_list') {
                    return (
                        <div>
                            <button onClick={handleReset} className="text-sm text-blue-600 hover:underline mb-4">
                                ← Buscar otro CURP
                            </button>
                            {userCourses.length > 0 ? (
                                <div className="space-y-4">
                                    <h3 className="text-lg font-semibold text-gray-700">Seleccione un curso para evaluar:</h3>
                                    {userCourses.map(course => (
                                        <button
                                            key={course.id}
                                            onClick={() => handleSurveyRedirect(course)}
                                            disabled={!!submittingCourse}
                                            className="course-item w-full text-left p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-indigo-50 flex justify-between items-center disabled:opacity-70 disabled:cursor-wait"
                                        >
                                            <div>
                                                <p className="font-bold text-indigo-800">{course.name}</p>
                                                <p className="text-sm text-gray-500">{course.period.replace(/_/g, ' ')}</p>
                                            </div>
                                            {submittingCourse?.id === course.id ? <Spinner className="border-indigo-600" /> : <span className="text-xl">→</span>}
                                        </button>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center p-8 bg-gray-100 rounded-lg">
                                    <p className="font-semibold text-gray-700">No se encontraron cursos.</p>
                                    <p className="text-gray-500 mt-1">No hay cursos registrados con el CURP proporcionado.</p>
                                </div>
                            )}
                        </div>
                    );
                }
            };
            
            return (
                <div className="container mx-auto px-4 py-8 sm:py-12">
                    <div className="max-w-2xl mx-auto">
                        <a href="index.html" className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-6">
                            ← Volver al Portal Principal
                        </a>
                        <div className="bg-white rounded-lg shadow-md p-6 sm:p-8 animate-fadeIn">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-4">📊</div>
                                <h2 className="text-2xl sm:text-3xl font-bold text-gray-800">Evaluación de Cursos</h2>
                                <p className="text-gray-600 mt-2">
                                    {step === 'curp_input' 
                                        ? 'Identifíquese para encontrar los cursos que ha tomado.'
                                        : 'Seleccione el curso que desea evaluar.'
                                    }
                                </p>
                            </div>
                            {error && (
                                <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md">
                                    <p>{error}</p>
                                </div>
                            )}
                            {renderContent()}
                        </div>
                    </div>
                </div>
            );
        };
        
        // =============================================================================
        // RENDERIZADO DE LA APLICACIÓN
        // =============================================================================
    </script>
    <script>
        window.addEventListener('load', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(
                    React.createElement(React.StrictMode, null,
                        React.createElement(SurveyApp, null)
                    )
                );
            } else {
                console.error('No se encontró el elemento root');
            }
        });
    </script>

    <!-- ========================================================================== -->
    <!-- CONFIGURACIÓN: Coloque aquí la URL de su Google Apps Script              -->
    <!-- ========================================================================== -->
    <script>
        window.CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycby_ESgq4InYsgJMqbsJz_je6M62PQ8uFFwiNwrHUuPt-131BxiiesiXf4wuEORrr7Cd4A/exec'
        };
    </script>
    <!-- ========================================================================== -->

</body>
</html>