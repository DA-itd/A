<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- React y Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>

    <script type="text/babel">
        // =============================================================================
        // CONFIGURACI√ìN
        // =============================================================================
        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec',
            ALLOWED_DOMAIN: 'itdurango.edu.mx'
        };

        // =============================================================================
        // GESTI√ìN DE SESI√ìN
        // =============================================================================
        const sessionManager = {
            save: (data) => localStorage.setItem('stats_session', JSON.stringify(data)),
            load: () => {
                try {
                    const session = localStorage.getItem('stats_session');
                    return session ? JSON.parse(session) : null;
                } catch (e) {
                    return null;
                }
            },
            clear: () => localStorage.removeItem('stats_session')
        };
        
        // =============================================================================
        // SERVICIOS API
        // =============================================================================
        const fetchData = async (token) => {
            const url = new URL(CONFIG.APPS_SCRIPT_URL);
            url.searchParams.append('action', 'getStatisticsData');
            url.searchParams.append('id_token', token);
            
            const response = await fetch(url.toString(), { method: 'GET' });
            if (!response.ok) throw new Error('Error de red al conectar con el servidor.');
            
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Error desconocido del servidor.');
            
            return result.data;
        };
        
        const generateReport = async (token) => {
             const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action: 'generateStatsReport', id_token: token })
            });
            
            if (!response.ok) throw new Error('Error de red al generar reporte.');
            
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'No se pudo generar el reporte.');
            
            return result.message;
        };

        // =============================================================================
        // COMPONENTES UI
        // =============================================================================
        
        const LoginScreen = ({ onLogin, error }) => {
            const googleButtonRef = React.useRef(null);

            React.useEffect(() => {
                const initGoogle = () => {
                    if (window.google && window.google.accounts) {
                        try {
                            window.google.accounts.id.initialize({
                                client_id: CONFIG.GOOGLE_CLIENT_ID,
                                callback: onLogin
                            });
                            if (googleButtonRef.current) {
                                window.google.accounts.id.renderButton(
                                    googleButtonRef.current, 
                                    { theme: "filled_blue", size: "large", text: "continue_with", shape: "rectangular" }
                                );
                            }
                        } catch (e) {
                            console.error("Error initializing Google Sign-In:", e);
                        }
                    }
                };

                // Intentar inicializar inmediatamente o esperar un poco si la librer√≠a no ha cargado
                if (window.google) {
                    initGoogle();
                } else {
                    const interval = setInterval(() => {
                        if (window.google) {
                            clearInterval(interval);
                            initGoogle();
                        }
                    }, 500);
                    return () => clearInterval(interval);
                }
            }, [onLogin]);

            return (
                <div className="text-center animate-fadeIn py-10">
                    <div className="text-6xl mb-4">üîê</div>
                    <h2 className="text-2xl font-bold text-gray-800">Acceso Restringido</h2>
                    <p className="text-gray-600 mt-2 max-w-lg mx-auto">
                        Este panel contiene informaci√≥n estad√≠stica. Por favor, inicie sesi√≥n con su cuenta institucional (@itdurango.edu.mx) para continuar.
                    </p>
                    {error && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-6 inline-block text-left">
                            <strong className="font-bold">Error: </strong>
                            <span className="block sm:inline">{error}</span>
                        </div>
                    )}
                    <div className="mt-8 flex justify-center min-h-[50px]" ref={googleButtonRef}></div>
                </div>
            );
        };
        
        const StatCard = ({ title, value, icon, color }) => (
            <div className={`bg-white p-6 rounded-xl shadow-lg border-l-4 ${color} animate-fadeIn hover:shadow-xl transition-shadow`}>
                <div className="flex items-center">
                    <div className="text-4xl mr-4 select-none">{icon}</div>
                    <div>
                        <p className="text-3xl font-bold text-gray-800">{value}</p>
                        <p className="text-sm text-gray-500 font-medium uppercase tracking-wide">{title}</p>
                    </div>
                </div>
            </div>
        );

        // Renombrado a DashboardChart para evitar conflicto con la clase global Chart
        const DashboardChart = ({ type, data, options, title }) => {
            const chartRef = React.useRef(null);
            const chartInstance = React.useRef(null);

            React.useEffect(() => {
                if (chartRef.current) {
                    // Destruir instancia previa si existe
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    // Verificar que Chart.js est√© cargado
                    if (window.Chart) {
                        try {
                            const ctx = chartRef.current.getContext('2d');
                            chartInstance.current = new window.Chart(ctx, { type, data, options });
                        } catch (err) {
                            console.error("Error creating chart:", err);
                        }
                    }
                }
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [type, data, options]);

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg animate-fadeIn h-full flex flex-col">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">{title}</h3>
                    <div className="flex-grow relative min-h-[300px]">
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, stats, onLogout, onGenerateReport }) => {
             const [isGenerating, setIsGenerating] = React.useState(false);
             const [reportStatus, setReportStatus] = React.useState('');

             const handleGenerate = async () => {
                 setIsGenerating(true);
                 setReportStatus('Generando y enviando reporte... ‚è≥');
                 try {
                     const message = await onGenerateReport();
                     setReportStatus(`‚úÖ ${message}`);
                 } catch (e) {
                     setReportStatus(`‚ùå Error: ${e.message}`);
                 } finally {
                     setIsGenerating(false);
                     // Limpiar mensaje despu√©s de 5 segundos
                     setTimeout(() => setReportStatus(''), 8000);
                 }
             };

            // Datos para las gr√°ficas
            const genderData = React.useMemo(() => ({
                labels: Object.keys(stats.distribucionGenero),
                datasets: [{
                    data: Object.values(stats.distribucionGenero),
                    backgroundColor: ['#3b82f6', '#ec4899', '#a855f7', '#10b981'],
                    borderWidth: 1
                }]
            }), [stats.distribucionGenero]);

            const typeData = React.useMemo(() => ({
                labels: Object.keys(stats.distribucionTipo),
                datasets: [{
                    label: 'Inscripciones',
                    data: Object.values(stats.distribucionTipo),
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: 'rgb(99, 102, 241)',
                    borderWidth: 1
                }]
            }), [stats.distribucionTipo]);
            
            const topDeptData = React.useMemo(() => ({
                labels: stats.topDepartamentos.map(d => d[0]),
                datasets: [{
                    label: 'Inscripciones',
                    data: stats.topDepartamentos.map(d => d[1]),
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(139, 92, 246, 0.7)'
                    ],
                    borderWidth: 1
                }]
            }), [stats.topDepartamentos]);
            
             const topCourseData = React.useMemo(() => ({
                labels: stats.topCursos.map(d => d[0].length > 40 ? d[0].substring(0, 40) + '...' : d[0]),
                datasets: [{
                    label: 'Inscritos',
                    data: stats.topCursos.map(d => d[1]),
                    backgroundColor: 'rgba(236, 72, 153, 0.7)',
                    borderColor: 'rgb(236, 72, 153)',
                    borderWidth: 1
                }]
            }), [stats.topCursos]);

            return (
                <div className="space-y-8 pb-12">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-600">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800">Dashboard de Resultados</h2>
                            <p className="text-gray-600">Hola, <strong>{user.name}</strong>.</p>
                        </div>
                        <button 
                            onClick={onLogout} 
                            className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold text-sm transition-colors"
                        >
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <StatCard title="Inscripciones Activas" value={stats.totalInscripciones} icon="üìù" color="border-blue-500" />
                        <StatCard title="Docentes Participantes" value={`${stats.coberturaDocente.actualizados}`} icon="üë©‚Äçüè´" color="border-green-500" />
                        <StatCard title="% Cobertura Estimada" value={`${stats.coberturaDocente.porcentaje}%`} icon="üéØ" color="border-purple-500" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                       <DashboardChart 
                           type="doughnut" 
                           data={genderData} 
                           title="Distribuci√≥n por G√©nero" 
                           options={{ responsive: true, maintainAspectRatio: false }} 
                       />
                       <DashboardChart 
                           type="bar" 
                           data={typeData} 
                           title="Tipo de Curso" 
                           options={{ 
                               responsive: true, 
                               maintainAspectRatio: false,
                               indexAxis: 'y',
                               plugins: { legend: { display: false } }
                           }} 
                       />
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                       <DashboardChart 
                           type="bar" 
                           data={topDeptData} 
                           title="Top 5 Departamentos" 
                           options={{ 
                               responsive: true, 
                               maintainAspectRatio: false,
                               plugins: { legend: { display: false } }
                           }} 
                       />
                       <DashboardChart 
                           type="bar" 
                           data={topCourseData} 
                           title="Cursos M√°s Demandados" 
                           options={{ 
                               responsive: true, 
                               maintainAspectRatio: false,
                               indexAxis: 'y',
                               plugins: { legend: { display: false } }
                           }} 
                       />
                    </div>
                    
                    <div className="bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-8 rounded-xl shadow-xl text-center">
                        <div className="text-4xl mb-4">üìÑ</div>
                        <h3 className="text-2xl font-bold mb-2">Reporte Ejecutivo</h3>
                        <p className="text-indigo-100 mb-6 max-w-2xl mx-auto">
                            Genere un reporte detallado en PDF con la lista de participantes y estad√≠sticas clave. 
                            El documento se enviar√° autom√°ticamente a su correo: <strong>{user.email}</strong>
                        </p>
                        
                        <div className="flex flex-col items-center gap-4">
                            <button 
                                onClick={handleGenerate} 
                                disabled={isGenerating} 
                                className={`px-8 py-3 bg-white text-indigo-600 font-bold rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all ${isGenerating ? 'opacity-75 cursor-wait' : ''}`}
                            >
                                {isGenerating ? 'Generando...' : '‚ú® Generar y Enviar Reporte'}
                            </button>
                            
                            {reportStatus && (
                                <div className={`px-4 py-2 rounded-lg text-sm font-semibold ${reportStatus.includes('‚ùå') ? 'bg-red-500' : 'bg-green-500'} bg-opacity-20 border border-white border-opacity-30`}>
                                    {reportStatus}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [error, setError] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [stats, setStats] = React.useState(null);

            const handleLogin = React.useCallback(async (response) => {
                setError(null);
                setLoading(true);
                
                try {
                    const token = response.credential;
                    // Decodificar JWT simple (solo para extraer email, validaci√≥n real en backend)
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    const decodedToken = JSON.parse(jsonPayload);

                    if (!decodedToken.email.endsWith(`@${CONFIG.ALLOWED_DOMAIN}`)) {
                        throw new Error(`Acceso denegado. Debe usar una cuenta institucional (@${CONFIG.ALLOWED_DOMAIN}).`);
                    }
                    
                    // Obtener datos
                    const statsData = await fetchData(token);
                    
                    const userData = {
                        name: decodedToken.name,
                        email: decodedToken.email,
                        picture: decodedToken.picture,
                        token: token
                    };
                    
                    setStats(statsData);
                    setUser(userData);
                    sessionManager.save(userData);
                    
                } catch(e) {
                    console.error("Login error:", e);
                    setError(e.message);
                    setUser(null);
                    sessionManager.clear();
                } finally {
                    setLoading(false);
                }
            }, []);
            
            const handleLogout = () => {
                setUser(null);
                setStats(null);
                sessionManager.clear();
                if(window.google && window.google.accounts) {
                    window.google.accounts.id.disableAutoSelect();
                }
                // Recargar para limpiar estado limpiamente
                window.location.reload();
            };
            
            const handleGenerateReport = React.useCallback(async () => {
                if(!user?.token) throw new Error("Su sesi√≥n ha expirado. Por favor ingrese de nuevo.");
                return await generateReport(user.token);
            }, [user]);

            React.useEffect(() => {
                const checkSession = async () => {
                    const session = sessionManager.load();
                    if (session && session.token) {
                        // Si hay sesi√≥n guardada, intentamos re-autenticar/cargar datos
                        await handleLogin({ credential: session.token });
                    } else {
                        // Si no hay sesi√≥n, terminamos carga para mostrar login
                        setLoading(false);
                    }
                };
                
                checkSession();
                
                // Timeout de seguridad por si algo se cuelga
                const safetyTimeout = setTimeout(() => {
                    setLoading((currentLoading) => {
                        if (currentLoading) {
                            console.warn("Force loading stop due to timeout");
                            return false;
                        }
                        return currentLoading;
                    });
                }, 8000); // 8 segundos max de carga inicial
                
                return () => clearTimeout(safetyTimeout);
            }, [handleLogin]);

            // Renderizado condicional
            if (loading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[60vh]">
                        <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                        <p className="text-blue-800 font-semibold animate-pulse">Cargando datos...</p>
                    </div>
                );
            }

            return (
                <main className="container mx-auto px-4 py-8 sm:py-12">
                    <div className="max-w-6xl mx-auto">
                        <a href="index.html" className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline mb-8 transition-colors">
                            ‚Üê Volver al Portal Principal
                        </a>
                        
                        {!user ? (
                            <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-10 max-w-2xl mx-auto border-t-4 border-indigo-500">
                                <LoginScreen onLogin={handleLogin} error={error} />
                            </div>
                        ) : stats ? (
                            <Dashboard 
                                user={user} 
                                stats={stats} 
                                onLogout={handleLogout} 
                                onGenerateReport={handleGenerateReport} 
                            />
                        ) : (
                            <div className="text-center bg-red-50 p-8 rounded-lg border border-red-200">
                                <p className="text-red-600 text-lg font-semibold mb-2">Error al cargar estad√≠sticas</p>
                                <p className="text-red-500 mb-4">{error || "No se pudieron recuperar los datos. Intente m√°s tarde."}</p>
                                <button onClick={handleLogout} className="text-sm underline text-red-700 hover:text-red-900">Volver a intentar</button>
                            </div>
                        )}
                    </div>
                </main>
            );
        };
        
        // Inicializaci√≥n
        window.addEventListener('load', () => {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            }
            
            const yearSpan = document.getElementById('copyright-year');
            if (yearSpan) {
                yearSpan.textContent = `Todos los derechos reservados ${new Date().getFullYear()}`;
            }
        });
    </script>
</body>
</html>
