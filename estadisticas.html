<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png">
    
    <!-- React y Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-gray-100 to-gray-200 min-h-screen text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://cdn.jsdelivr.net/gh/DA-itd/web/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 object-contain">
                <div class="text-center flex-1">
                    <h1 class="text-lg sm:text-2xl font-bold text-blue-900">ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm text-blue-700 font-semibold">Actualizaci√≥n Docente ITD</p>
                </div>
                <img src="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <footer class="bg-gray-800 text-white text-center py-6 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-bold text-sm">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
            <p class="text-xs opacity-75 mt-1">Instituto Tecnol√≥gico de Durango</p>
        </div>
    </footer>

    <!-- L√ìGICA REACT -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            // URL del Script de Google Apps (backend)
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec',
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
        };

        // --- COMPONENTES VISUALES ---

        const KpiCard = ({ title, value, icon, color }) => (
            <div className={`bg-white p-6 rounded-xl shadow-md border-l-4 ${color} flex items-center justify-between transform transition hover:scale-105`}>
                <div>
                    <p className="text-sm text-gray-500 font-semibold uppercase tracking-wider">{title}</p>
                    <p className="text-3xl font-bold text-gray-800 mt-1">{value}</p>
                </div>
                <div className="text-4xl opacity-30 grayscale">{icon}</div>
            </div>
        );

        const Dashboard = ({ data, availableYears, selectedPeriod, onPeriodChange, user, onLogout }) => {
            const chartsRef = useRef({});

            useEffect(() => {
                if (!data) return;

                // Limpiar gr√°ficas previas
                Object.values(chartsRef.current).forEach(chart => chart && chart.destroy());

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                };

                // 1. Gr√°fica por Departamento (Barras)
                // El backend ahora devuelve arrays [nombre, cantidad]
                const deptLabels = data.topDepartamentos.map(d => d[0]);
                const deptValues = data.topDepartamentos.map(d => d[1]);

                const ctxDept = document.getElementById('chartDept')?.getContext('2d');
                if (ctxDept) {
                    chartsRef.current.dept = new Chart(ctxDept, {
                        type: 'bar',
                        data: {
                            labels: deptLabels,
                            datasets: [{
                                label: 'Participantes',
                                data: deptValues,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                // 2. Gr√°fica por G√©nero (Doughnut)
                const genderLabels = Object.keys(data.distribucionGenero);
                const genderValues = Object.values(data.distribucionGenero);

                const ctxGender = document.getElementById('chartGender')?.getContext('2d');
                if (ctxGender) {
                    chartsRef.current.gender = new Chart(ctxGender, {
                        type: 'doughnut',
                        data: {
                            labels: genderLabels,
                            datasets: [{
                                data: genderValues,
                                backgroundColor: ['#3B82F6', '#EC4899', '#9CA3AF'],
                                borderWidth: 0
                            }]
                        },
                        options: commonOptions
                    });
                }

                // 3. Top Cursos (Horizontal Bar)
                const courseLabels = data.topCursos.map(c => c[0].length > 25 ? c[0].substring(0, 25) + '...' : c[0]);
                const courseValues = data.topCursos.map(c => c[1]);
                
                const ctxCourses = document.getElementById('chartCourses')?.getContext('2d');
                if (ctxCourses) {
                    chartsRef.current.courses = new Chart(ctxCourses, {
                        type: 'bar',
                        data: {
                            labels: courseLabels,
                            datasets: [{
                                label: 'Inscritos',
                                data: courseValues,
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderRadius: 4,
                                indexAxis: 'y',
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            plugins: { legend: { display: false } }
                        }
                    });
                }

                return () => Object.values(chartsRef.current).forEach(c => c && c.destroy());
            }, [data]);

            return (
                <div className="animate-fadeIn container mx-auto px-4 py-8 max-w-7xl">
                    {/* Header del Dashboard */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-gray-800">Tablero de Control</h2>
                            <p className="text-gray-600">Bienvenido, {user.name}</p>
                        </div>
                        <div className="flex gap-2 items-center">
                            <label className="text-sm font-semibold text-gray-600">Periodo:</label>
                            <select 
                                value={selectedPeriod}
                                onChange={(e) => onPeriodChange(e.target.value)}
                                className="bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                {availableYears.map(year => (
                                    <option key={year} value={year}>{year === 'ACTUAL' ? 'Ciclo Actual' : `Ciclo ${year}`}</option>
                                ))}
                            </select>
                            <button onClick={onLogout} className="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 font-bold transition shadow-sm ml-2">
                                Salir
                            </button>
                        </div>
                    </div>

                    {/* KPIs */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <KpiCard title="Total Inscripciones" value={data.totalInscripciones} icon="üë•" color="border-blue-500" />
                        <KpiCard title="Cobertura Docente" value={`${data.coberturaDocente?.porcentaje}%`} icon="üìä" color="border-green-500" />
                        <KpiCard title="Cursos Ofertados" value={data.historicalTrend?.[selectedPeriod === 'ACTUAL' ? new Date().getFullYear() : selectedPeriod]?.cursos || data.topCursos.length} icon="üìö" color="border-purple-500" />
                    </div>

                    {/* Gr√°ficas Principales */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-lg font-bold text-gray-700 mb-4">Participaci√≥n por Departamento (Top 5)</h3>
                            <div className="h-64 relative"><canvas id="chartDept"></canvas></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-lg font-bold text-gray-700 mb-4">Distribuci√≥n por G√©nero</h3>
                            <div className="h-64 relative"><canvas id="chartGender"></canvas></div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-md">
                        <h3 className="text-lg font-bold text-gray-700 mb-4">Top Cursos M√°s Solicitados</h3>
                        <div className="h-80 relative"><canvas id="chartCourses"></canvas></div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, error }) => {
            const btnRef = useRef(null);

            useEffect(() => {
                if (window.google && btnRef.current) {
                    window.google.accounts.id.initialize({
                        client_id: CONFIG.GOOGLE_CLIENT_ID,
                        callback: onLogin
                    });
                    window.google.accounts.id.renderButton(btnRef.current, {
                        theme: "filled_blue", size: "large", shape: "rectangular", width: 250
                    });
                }
            }, [onLogin]);

            return (
                <div className="flex flex-col items-center justify-center py-20 animate-fadeIn px-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full">
                        <div className="text-6xl mb-4">üîí</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Acceso Restringido</h2>
                        <p className="text-gray-600 mb-8">
                            Esta secci√≥n es exclusiva para administradores. Por favor, inicie sesi√≥n.
                        </p>
                        
                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-6 border border-red-200">
                                {error}
                            </div>
                        )}
                        
                        <div className="flex justify-center" ref={btnRef}></div>
                        
                        <div className="mt-8 pt-6 border-t border-gray-100">
                            <a href="index.html" className="text-blue-600 hover:underline text-sm font-semibold">
                                ‚Üê Volver al inicio
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-96 animate-fadeIn">
                <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
                <p className="text-gray-600 font-semibold animate-pulse">Cargando datos del servidor...</p>
            </div>
        );

        // --- COMPONENTE PRINCIPAL (APP) ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [statsResponse, setStatsResponse] = useState(null);
            const [selectedPeriod, setSelectedPeriod] = useState('ACTUAL');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleLogin = async (response) => {
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    setUser({
                        name: payload.name,
                        email: payload.email,
                        picture: payload.picture,
                        token: response.credential
                    });
                    setError(null);
                } catch (e) {
                    console.error(e);
                    setError("Error al procesar la autenticaci√≥n.");
                }
            };

            useEffect(() => {
                if (user) {
                    fetchStatistics(selectedPeriod);
                }
            }, [user, selectedPeriod]);

            const fetchStatistics = async (period) => {
                setLoading(true);
                setError(null);
                try {
                    // Llamada al script de Google Apps
                    // Se env√≠a el token para que el backend pueda validar si es necesario
                    const url = `${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}&id_token=${user.token}`;
                    
                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        setStatsResponse(result);
                    } else {
                        setError(result.message || "No se pudieron cargar las estad√≠sticas. Verifique permisos.");
                    }
                } catch (err) {
                    console.error(err);
                    setError("Error de conexi√≥n con el servidor. Intente m√°s tarde.");
                } finally {
                    setLoading(false);
                }
            };

            if (!user) {
                return <LoginScreen onLogin={handleLogin} error={error} />;
            }

            if (loading && !statsResponse) {
                return <LoadingScreen />;
            }

            if (error) {
                return (
                    <div className="container mx-auto p-8 text-center">
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded shadow-md inline-block max-w-2xl">
                            <h3 className="font-bold text-lg mb-2">Error de Carga</h3>
                            <p>{error}</p>
                            <button 
                                onClick={() => setUser(null)}
                                className="mt-4 bg-white border border-red-300 text-red-700 px-4 py-2 rounded hover:bg-red-50 transition"
                            >
                                Volver a intentar
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <Dashboard 
                    data={statsResponse ? statsResponse.data : null} 
                    availableYears={statsResponse ? statsResponse.availableYears : ['ACTUAL']}
                    selectedPeriod={selectedPeriod}
                    onPeriodChange={setSelectedPeriod}
                    user={user} 
                    onLogout={() => setUser(null)} 
                />
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
