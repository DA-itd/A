<change>
<file>estadisticas.html</file>
<description>Frontend corregido: Se elimin√≥ el texto residual superior. Se ajust√≥ el layout: Cursos (Ancho total con etiquetas internas), Departamentos (Ancho total), G√©nero + Tipo (Juntos), Hist√≥rico (Ancho total). Configuraci√≥n de Chart.js optimizada para etiquetas.</description>
<content><![CDATA[
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>

<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">

<!-- React y Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js y Plugin de Etiquetas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- Librer√≠as para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
    /* Animaciones */
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Scrollbar personalizado */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #999; }

    /* Modal PDF */
    .pdf-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; backdrop-filter: blur(4px);
    }
    
    .pdf-modal {
        background: white; padding: 40px 60px; border-radius: 16px;
        text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        max-width: 400px; border-top: 6px solid #1B396A;
    }
    
    .pdf-spinner {
        width: 60px; height: 60px;
        border: 5px solid #e5e7eb; border-top-color: #1B396A;
        border-radius: 50%; animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    /* Modal Preview */
    .preview-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.85);
        display: flex; flex-direction: column;
        z-index: 10000;
    }

    .preview-header {
        background: #1B396A; color: white; padding: 15px 30px;
        display: flex; justify-content: space-between; align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    .preview-body {
        flex: 1; overflow: auto; padding: 20px;
        display: flex; justify-content: center;
        background: #525659;
    }

    .preview-body iframe {
        background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        max-width: 100%; height: 100%; border: none;
    }
    
    /* Utilidades */
    .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
</style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen text-gray-800 flex flex-col">
code
Code
<!-- HEADER WEB -->
<header id="web-header" class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
    <div class="container mx-auto px-4 py-4 sm:py-6 flex items-center justify-between gap-4">
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
        <div class="text-center flex-1 px-2 sm:px-4">
            <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
            <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
        </div>
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
    </div>
</header>

<!-- ENLACE DE NAVEGACI√ìN -->
<div id="back-link" class="container mx-auto px-4 py-4">
    <a href="index.html" 
       class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-bold transition-colors">
        ‚Üê Volver al Portal Principal
    </a>
</div>

<!-- CONTENEDOR PRINCIPAL DE REACT -->
<div id="root" class="flex-grow flex flex-col">
    <div class="flex justify-center items-center h-64 flex-grow">
        <div class="text-center">
            <div class="animate-spin h-12 w-12 border-4 border-[#1B396A] rounded-full border-t-transparent mx-auto mb-4"></div>
            <p class="text-gray-600 font-semibold text-lg">Inicializando sistema...</p>
        </div>
    </div>
</div>

<!-- FOOTER WEB -->
<footer id="web-footer" class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
    <div class="container mx-auto px-4">
         <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
         <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
         <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
    </div>
</footer>

<!-- SCRIPT DE INICIALIZACI√ìN -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var yearEl = document.getElementById('copyright-year');
        if (yearEl) {
            yearEl.textContent = new Date().getFullYear();
        }
    });
</script>

<!-- APLICACI√ìN REACT -->
<script type="text/babel">
    const React = window.React;
    const ReactDOM = window.ReactDOM;

    // ====================================================================
    // CONFIGURACI√ìN GLOBAL
    // ====================================================================
    const CONFIG = {
        GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
    };

    // Colores Institucionales y Vibrantes para Gr√°ficas
    const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
    const VIBRANT_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#E91E63', '#009688'];
    
    // ====================================================================
    // UTILIDADES DE TEXTO
    // ====================================================================
    
    const shortenLabel = (label) => {
        if (!label) return '';
        return label
            .replace(/DEPARTAMENTO DE /gi, 'D. ')
            .replace(/DEPARTAMENTO/gi, 'D.')
            .replace(/DIVISION DE ESTUDIOS DE /gi, 'Div. ')
            .replace(/DIVISION DE /gi, 'Div. ')
            .replace(/CENTRO DE INFORMACI√ìN/gi, 'C. Informaci√≥n')
            .replace(/CENTRO DE /gi, 'C. ')
            .replace(/INGENIER√çA/gi, 'Ing.')
            .replace(/CIENCIAS/gi, 'Cs.')
            .replace(/ECONOMICO-ADMINISTRATIVAS/gi, 'Eco-Admin')
            .trim();
    };
    
    const getChartHeight = (count) => Math.max(400, count * 28) + "px";

    // ====================================================================
    // COMPONENTE: Login (Pantalla de Acceso)
    // ====================================================================
    const Login = ({ onLogin, loginError }) => {
        const googleButtonRef = React.useRef(null);

        React.useEffect(() => {
            let intervalId;
            const initGoogle = () => {
                if (window.google && window.google.accounts && googleButtonRef.current) {
                    try {
                        window.google.accounts.id.initialize({ 
                            client_id: CONFIG.GOOGLE_CLIENT_ID, 
                            callback: onLogin 
                        });
                        window.google.accounts.id.renderButton(googleButtonRef.current, { 
                            theme: "outline", 
                            size: "large", 
                            text: "signin_with", 
                            shape: "rectangular", 
                            logo_alignment: "left"
                        });
                        return true;
                    } catch (e) { return false; }
                }
                return false;
            };
            
            if (!initGoogle()) { 
                intervalId = setInterval(() => { if (initGoogle()) clearInterval(intervalId); }, 500); 
            }
            return () => { if(intervalId) clearInterval(intervalId); };
        }, [onLogin]);

        return (
            <div className="flex flex-col justify-center items-center py-20 animate-fadeIn px-4 flex-grow">
                <div className="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border-t-8 border-[#9D2449]">
                    <div className="text-5xl mb-6">üîí</div>
                    <h2 className="text-3xl font-bold text-[#1B396A] mb-2">Acceso Restringido</h2>
                    <p className="text-gray-500 mb-8 text-sm font-medium uppercase tracking-wide">Estad√≠sticas Institucionales</p>
                    {loginError && (<div className="mb-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm font-bold">{loginError}</div>)}
                    <div className="flex justify-center min-h-[50px]" ref={googleButtonRef}></div>
                </div>
            </div>
        );
    };

    // ====================================================================
    // COMPONENTE: ChartBox (Contenedor de Gr√°fica)
    // ====================================================================
    const ChartBox = ({ type, data, title, id, horizontal = false, shortenLabels = false, minHeight = "350px", insideLabels = false }) => {
        const chartRef = React.useRef(null);
        const canvasRef = React.useRef(null);

        React.useEffect(() => {
            if (!canvasRef.current || !data || Object.keys(data).length === 0) return;
            if (typeof window.Chart === 'undefined') return;
            
            if (chartRef.current) chartRef.current.destroy();

            const ctx = canvasRef.current.getContext('2d');
            const isHistory = id === 'chartHistory';
            const isPie = type === 'pie' || type === 'doughnut';
            
            let config = {
                type: isHistory ? 'line' : type,
                data: { labels: [], datasets: [] },
                plugins: window.ChartDataLabels ? [window.ChartDataLabels] : [],
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    indexAxis: horizontal ? 'y' : 'x',
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    scales: isPie ? {} : { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                color: '#374151',
                                font: { size: 11, weight: '600' },
                                autoSkip: false, 
                                mirror: insideLabels && horizontal, // Etiquetas DENTRO de la barra si se solicita
                                z: insideLabels ? 1 : 0, // Asegurar que el texto quede encima
                                callback: function(value, index) { 
                                    if (this.getLabelForValue(value)) {
                                        // Si insideLabels es true, devolvemos el texto. Si es n√∫mero, solo enteros.
                                        return this.getLabelForValue(value); 
                                    }
                                    if (value % 1 === 0) return value; 
                                } 
                            },
                            grid: { color: '#e5e7eb', borderDash: [5, 5], display: !insideLabels }
                        },
                        x: {
                            beginAtZero: true, 
                            ticks: { 
                                color: '#374151',
                                font: { size: 11, weight: '600' }
                            },
                            grid: { display: false }
                        }
                    },
                    plugins: { 
                        datalabels: {
                            display: true, 
                            align: isHistory ? 'top' : (horizontal ? 'end' : 'top'),
                            anchor: isHistory ? 'center' : (horizontal ? 'end' : 'end'),
                            backgroundColor: isHistory ? 'rgba(255,255,255,0.9)' : (isPie ? 'rgba(0,0,0,0.6)' : 'transparent'),
                            borderRadius: 4,
                            color: isHistory ? '#1B396A' : (isPie ? '#fff' : '#374151'),
                            font: { weight: 'bold', size: 11 },
                            padding: 4,
                            formatter: (value) => Math.round(value),
                            offset: 4,
                            clip: false
                        },
                        legend: { 
                            display: isPie || isHistory, 
                            position: 'bottom',
                            labels: { color: '#374151', font: { size: 12, weight: '600' }, padding: 20, usePointStyle: true }
                        },
                        tooltip: { backgroundColor: 'rgba(27, 57, 106, 0.9)', padding: 12, cornerRadius: 8 }
                    },
                    layout: { padding: { top: 25, right: 40, left: 10, bottom: 10 } }
                }
            };
            
            // Configuraci√≥n espec√≠fica para cuando queremos etiquetas DENTRO de las barras (Cursos m√°s demandados)
            if (insideLabels && horizontal) {
                 config.options.scales = {
                     x: { beginAtZero: true, display: false }, // Ocultar valores
                     y: { 
                         ticks: { 
                             color: '#FFFFFF', // Texto blanco
                             font: {size:12, weight:'bold'}, 
                             mirror: true, // Dentro de la barra
                             padding: -10, // Ajuste de posici√≥n
                             z: 10
                         },
                         grid: { display: false }
                     }
                 };
            } else if (!isPie) {
                if (horizontal) {
                     config.options.scales = {
                         x: { beginAtZero: true, display: false }, 
                         y: { ticks: { color: '#374151', font: {size:11, weight:'600'}, autoSkip: false } }
                     };
                } else {
                     config.options.scales = {
                         y: { beginAtZero: true, ticks: { color: '#374151', autoSkip: false } },
                         x: { ticks: { color: '#374151', font: {size:11, weight:'600'}, autoSkip: false } }
                     };
                }
            }
            
            if (isPie) config.options.layout.padding = 20;

            // Datos
            if (isHistory) {
                const years = Object.keys(data).sort((a,b) => parseInt(a) - parseInt(b));
                config.data = {
                    labels: years,
                    datasets: [
                        { 
                            label: 'Docentes Inscritos', 
                            data: years.map(y => data[y]?.registros || 0), 
                            borderColor: '#36A2EB', 
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#36A2EB',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            borderWidth: 3
                        },
                        { 
                            label: 'Cursos Ofertados', 
                            data: years.map(y => data[y]?.cursos || 0), 
                            borderColor: '#FF6384', 
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#FF6384',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            borderWidth: 3
                        }
                    ]
                };
            } else {
                const rawLabels = Object.keys(data);
                const displayLabels = rawLabels.map(l => shortenLabels ? shortenLabel(l) : l);
                
                config.data = {
                    labels: displayLabels,
                    datasets: [{ 
                        label: title.replace(/[üìöüë•üè¢üìãüìàüè´]/g, '').trim(), 
                        data: Object.values(data), 
                        backgroundColor: isPie ? INSTITUTIONAL_COLORS : VIBRANT_COLORS,
                        borderColor: isPie ? '#ffffff' : VIBRANT_COLORS,
                        borderWidth: isPie ? 2 : 1,
                        borderRadius: isPie ? 0 : 6
                    }]
                };
            }

            chartRef.current = new window.Chart(ctx, config);
            
            return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [data, type, title, horizontal, id, shortenLabels, insideLabels]);

        return (
            <div 
                id={`chartBox-${id}`}
                className="bg-white p-5 rounded-xl shadow-md h-full flex flex-col border border-gray-100 transition-all hover:shadow-lg" 
                style={{ minHeight }}
            >
                <h3 className="text-gray-700 font-bold mb-4 text-center text-base border-b border-gray-100 pb-3 flex items-center justify-center gap-2">
                    {title}
                </h3>
                <div className="flex-1 relative w-full h-full" style={{ minHeight: '200px' }}>
                    <canvas ref={canvasRef} id={id}></canvas>
                </div>
            </div>
        );
    };

    // ====================================================================
    // COMPONENTE: Dashboard (Vista Principal)
    // ====================================================================
    const Dashboard = ({ user, onLogout }) => {
        const [stats, setStats] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [period, setPeriod] = React.useState('ACTUAL');
        const [availableYears, setAvailableYears] = React.useState([]);
        const [pdfState, setPdfState] = React.useState({ generating: false, preview: null, blob: null });

        React.useEffect(() => {
            let isMounted = true;
            setLoading(true);
            setError(null);

            fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`)
                .then(r => { 
                    if(!r.ok) throw new Error(`Error HTTP: ${r.status}`); 
                    return r.json(); 
                })
                .then(res => {
                    if (!isMounted) return;
                    if (res.success) {
                        setStats(res.data);
                        if (res.availableYears) setAvailableYears(res.availableYears);
                    } else throw new Error(res.message || "No se pudieron cargar los datos.");
                })
                .catch(err => { if (isMounted) setError(err.message); })
                .finally(() => { if (isMounted) setLoading(false); });

            return () => { isMounted = false; };
        }, [period]);

        const captureElement = async (elementId) => {
            const element = document.getElementById(elementId);
            if (!element) return null;
            try {
                return (await html2canvas(element, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#ffffff', logging: false, ignoreElements: (el) => el.tagName === 'BUTTON' })).toDataURL('image/png');
            } catch (err) { return null; }
        };

        const generatePDF = async () => {
            setPdfState({ generating: true, preview: null, blob: null });
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('portrait', 'mm', 'letter'); 
                const W = pdf.internal.pageSize.getWidth();
                const H = pdf.internal.pageSize.getHeight();
                const M = 10;
                
                const addHeader = () => {
                    pdf.setFillColor(27, 57, 106); pdf.rect(0, 0, W, 20, 'F');
                    pdf.setFontSize(15); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(255, 255, 255); pdf.text('INSTITUTO TECNOLOGICO DE DURANGO', W/2, 9, { align: 'center' });
                    pdf.setFontSize(10); pdf.setFont('helvetica', 'normal'); pdf.text('Reporte Estadistico - Actualizacion Docente', W/2, 15, { align: 'center' });
                };
                const addFooter = (pageNo, pageCount) => {
                    pdf.setFillColor(27, 57, 106); pdf.rect(0, H - 10, W, 10, 'F');
                    pdf.setFontSize(8); pdf.setTextColor(255); pdf.text('Coordinacion de Actualizacion Docente - ITD', M, H - 4);
                    pdf.text(`Pagina ${pageNo} de ${pageCount}`, W - M, H - 4, { align: 'right' });
                };

                addHeader();
                let y = 30; pdf.setTextColor(0); pdf.setFontSize(11); pdf.text(`PERIODO: ${period}`, M, y); 
                pdf.setFontSize(9); pdf.setTextColor(100); pdf.text(`Generado: ${new Date().toLocaleDateString()}`, W-M, y, { align: 'right' }); 
                y += 10;

                const kpis = [{v:stats.totalInscripciones,l:'Inscritos'},{v:stats.coberturaDocente?.actualizados||0,l:'Unicos'},{v:stats.coberturaDocente?.recurrentes||0,l:'Recurrentes'},{v:(stats.coberturaDocente?.porcentaje||0)+'%',l:'Cobertura (417)'}];
                const kw = (W-(M*2)-15)/4;
                kpis.forEach((k, i) => {
                    const x = M+(i*(kw+5)); pdf.setFillColor(245,245,245); pdf.roundedRect(x,y,kw,16,2,2,'F');
                    pdf.setFontSize(14); pdf.setTextColor(0); pdf.text(String(k.v), x+kw/2, y+7, {align:'center'});
                    pdf.setFontSize(7); pdf.setTextColor(100); pdf.text(k.l, x+kw/2, y+12, {align:'center'});
                });
                y += 25;

                // Captura en paralelo
                const [imgC, imgD, imgG, imgF, imgT, imgH] = await Promise.all([
                    captureElement('chartBox-chartCourses'), 
                    captureElement('chartBox-chartDepts'),
                    captureElement('chartBox-chartGender'),
                    captureElement('chartBox-chartFreq'),
                    captureElement('chartBox-chartType'), 
                    captureElement('chartBox-chartHistory')
                ]);
                
                // Pagina 1
                if (imgC) pdf.addImage(imgC, 'PNG', M, y, W*0.9, 80); y += 85;
                if (imgD) pdf.addImage(imgD, 'PNG', M, y, W*0.9, 80); y += 85;
                
                // Nueva Pagina
                pdf.addPage(); addHeader(); y = 30;
                
                // Fila G√©nero + Tipo
                if (imgG) pdf.addImage(imgG, 'PNG', M, y, (W/2)-M-2, 60);
                if (imgT) pdf.addImage(imgT, 'PNG', (W/2)+2, y, (W/2)-M-2, 60);
                y += 65;

                // Fila Frecuencia
                if (imgF) pdf.addImage(imgF, 'PNG', M, y, W-2*M, 70); y += 75;
                
                // Fila Hist√≥rico
                if (imgH) pdf.addImage(imgH, 'PNG', M, y, W-2*M, 60);

                const pageCount = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) { pdf.setPage(i); addFooter(i, pageCount); }

                const blob = pdf.output('blob'); setPdfState({ generating: false, preview: URL.createObjectURL(blob), blob: blob, filename: `Reporte_${period}.pdf` });
            } catch (e) { alert('Error PDF'); setPdfState({ generating: false, preview: null, blob: null }); }
        };

        if (loading && !stats) return <div className="flex justify-center items-center h-96 flex-grow"><div className="animate-spin h-16 w-16 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div>;
        if (error) return <div className="text-center py-20 text-red-600 font-bold">Error: {error}<br/><button onClick={()=>window.location.reload()} className="underline">Recargar</button></div>;
        if (!stats) return null;

        const kpiList = [
            { icon: "üìù", val: stats.totalInscripciones, label: "Inscripciones Totales", color: "border-[#1B396A]" },
            { icon: "üë©‚Äçüè´", val: stats.coberturaDocente?.actualizados || 0, label: "Docentes √önicos", color: "border-[#D4AF37]" },
            { icon: "üîÅ", val: stats.coberturaDocente?.recurrentes || 0, label: "Recurrentes (>1 Curso)", color: "border-[#9D2449]" },
            { icon: "üéØ", val: `${stats.coberturaDocente?.porcentaje || 0}%`, label: "Cobertura (Base 417)", color: "border-gray-500" }
        ];

        return (
            <div className="container mx-auto px-4 py-6 max-w-7xl animate-fadeIn flex-grow">
                {pdfState.generating && <div className="pdf-overlay"><div className="pdf-modal"><div className="pdf-spinner"></div><p>Generando PDF...</p></div></div>}
                {pdfState.preview && <div className="preview-overlay"><div className="preview-header"><h3>Vista Previa</h3><div><button onClick={()=>{const l=document.createElement('a');l.href=pdfState.preview;l.download=`Reporte_${period}.pdf`;l.click();}} className="bg-green-500 text-white px-4 py-2 rounded mr-2 font-bold">Descargar</button><button onClick={()=>{URL.revokeObjectURL(pdfState.preview);setPdfState({generating:false,preview:null});}} className="bg-gray-500 text-white px-4 py-2 rounded font-bold">Cerrar</button></div></div><div className="preview-body"><iframe src={pdfState.preview} title="PDF Preview"></iframe></div></div>}
                
                <div className="bg-white rounded-xl shadow p-4 mb-6 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#9D2449] gap-4">
                    <div className="flex-1"><h2 className="text-xl font-bold text-[#1B396A]">Dashboard</h2><p className="text-sm font-bold text-gray-500">Usuario: {user.name}</p></div>
                    <div className="flex gap-3"><select value={period} onChange={(e) => setPeriod(e.target.value)} className="border p-2 rounded font-bold"><option value="ACTUAL">üü¢ Periodo Actual</option>{availableYears.filter(y => y !== 'ACTUAL').map(y => <option key={y} value={y}>üìÖ Hist√≥rico {y}</option>)}</select><button onClick={generatePDF} className="bg-[#1B396A] text-white px-5 py-2 rounded font-bold shadow">Reporte PDF</button><button onClick={onLogout} className="bg-white border px-4 py-2 rounded text-gray-700">Salir</button></div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    {kpiList.map((k, idx) => (<div key={idx} className={`bg-white p-5 rounded-xl shadow border-b-4 ${k.color} flex items-center gap-4 transition hover:-translate-y-1`><div className="text-3xl">{k.icon}</div><div><div className="text-2xl font-black">{k.val}</div><div className="text-xs font-bold text-gray-500 uppercase">{k.label}</div></div></div>))}
                </div>

                {/* Fila 1: Cursos (Ancho total - Labels dentro) */}
                <div className="grid grid-cols-1 gap-6 mb-6"><div className="w-full"><ChartBox type="bar" data={Object.fromEntries(stats.topCursos||[])} title="üìö Cursos M√°s Demandados" id="chartCourses" horizontal={true} minHeight={getChartHeight(stats.topCursos?.length||0)} insideLabels={true} /></div></div>

                {/* Fila 2: Departamentos (Ancho total) */}
                <div className="grid grid-cols-1 gap-6 mb-6"><div className="w-full"><ChartBox type="bar" data={Object.fromEntries(stats.topDepartamentos||[])} title="üè¢ Participaci√≥n por Departamento" id="chartDepts" horizontal={true} shortenLabels={true} minHeight={getChartHeight(stats.topDepartamentos?.length||0)} /></div></div>

                {/* Fila 3: G√©nero + Tipo de Curso */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <ChartBox type="doughnut" data={stats.distribucionGenero} title="üë• G√©nero" id="chartGender" minHeight="400px" />
                    <ChartBox type="bar" data={stats.distribucionTipo} title="üè´ Tipo de Curso" id="chartType" horizontal={false} minHeight="400px" />
                </div>

                {/* Fila 4: Frecuencia por Docente */}
                <div className="grid grid-cols-1 gap-6 mb-6"><div className="w-full"><ChartBox type="bar" data={stats.frecuenciaParticipacion} title="üìã Cursos por Docente" id="chartFreq" horizontal={false} minHeight="400px" /></div></div>
                
                {/* Fila 5: Hist√≥rico (Ancho total) */}
                <div className="mb-6"><ChartBox type="line" data={stats.historicalTrend||{}} title="üìà Evoluci√≥n Hist√≥rica" id="chartHistory" minHeight="380px" /></div>
            </div>
        );
    };
    
    const App = () => {
        const [user, setUser] = React.useState(null);
        const [loginError, setLoginError] = React.useState(null);
        const handleLogin = (res) => { try { const p = JSON.parse(atob(res.credential.split('.')[1])); setUser({ name: p.name, email: p.email }); } catch (e) { setLoginError("Error de acceso."); } };
        return user ? <Dashboard user={user} onLogout={() => setUser(null)} /> : <Login onLogin={handleLogin} loginError={loginError} />;
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
]]></content>
</change>
