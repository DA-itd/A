<!DOCTYPE html>
<html lang="es">
<head>
   <script async src="https://www.googletagmanager.com/gtag/js?id=G-V2V4CT2C69"></script>
<script src="ga.js"></script>
    
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">

<!-- React y Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js y Plugin de Etiquetas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- Librer√≠as para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Librer√≠a para Word/DOCX - versi√≥n 8 con UMD estable -->
<script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
    /* Animaciones */
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Scrollbar personalizado */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #999; }

    /* Modal PDF y Loaders */
    .pdf-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex; justify-content: center; align-items: center;
        z-index: 9999; backdrop-filter: blur(4px);
    }
    
    .pdf-modal {
        background: white; padding: 40px 60px; border-radius: 16px;
        text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        max-width: 400px; border-top: 6px solid #1B396A;
    }
    
    /* RELOJ DE ESPERA (Loader) */
    .loader-spinner {
        width: 64px;
        height: 64px;
        border: 4px solid #1B396A; /* Aro exterior azul */
        border-radius: 50%;
        position: relative;
        margin: 0 auto 20px;
        background: rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Punto central */
    .loader-spinner::before {
        content: '';
        position: absolute;
        width: 8px; height: 8px;
        background: #1B396A;
        border-radius: 50%;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
    }

    /* Manecilla giratoria */
    .loader-spinner::after {
        content: '';
        position: absolute;
        width: 4px; height: 24px;
        background: #9D2449; /* Color guinda para la manecilla */
        top: 50%; left: 50%;
        margin-left: -2px; /* Centrar horizontalmente */
        margin-top: -24px; /* Mover arriba para que pivote desde el centro */
        transform-origin: bottom center;
        border-radius: 2px;
        animation: spin 2s linear infinite;
    }
    
    /* Utilidades */
    .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
</style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen text-gray-800 flex flex-col">

<!-- HEADER WEB -->
<header id="web-header" class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
    <div class="container mx-auto px-4 py-4 sm:py-6 flex items-center justify-between gap-4">
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
        <div class="text-center flex-1 px-2 sm:px-4">
            <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
            <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
        </div>
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
    </div>
</header>

<!-- ENLACE DE NAVEGACI√ìN -->
<div id="back-link" class="container mx-auto px-4 py-4">
    <a href="index.html" 
       class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-bold transition-colors">
        ‚Üê Volver al Portal Principal
    </a>
</div>

<!-- CONTENEDOR PRINCIPAL DE REACT -->
<div id="root" class="flex-grow flex flex-col">
    <!-- Loader Inicial (HTML puro para feedback inmediato) -->
    <div class="flex justify-center items-center h-64 flex-grow">
        <div class="text-center">
            <div class="loader-spinner"></div>
            <p class="text-gray-600 font-semibold text-lg">Inicializando sistema...</p>
        </div>
    </div>
</div>

<!-- FOOTER WEB -->
<footer id="web-footer" class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
    <div class="container mx-auto px-4">
         <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
         <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
         <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
    </div>
</footer>

<!-- SCRIPT DE INICIALIZACI√ìN -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var yearEl = document.getElementById('copyright-year');
        if (yearEl) {
            yearEl.textContent = new Date().getFullYear();
        }
    });
</script>

<!-- APLICACI√ìN REACT -->
<script type="text/babel">
    const React = window.React;
    const ReactDOM = window.ReactDOM;

    // ====================================================================
    // CONFIGURACI√ìN GLOBAL
    // ====================================================================
    const CONFIG = {
        GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
        APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
    };

    // Colores Institucionales y Vibrantes
    const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
    const VIBRANT_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#E91E63', '#009688'];
    const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';
    const GUINDA_COLOR = '#9D2449';
    const BLUE_COLOR = '#1B396A';
    
    // ====================================================================
    // UTILIDADES
    // ====================================================================
    
    const shortenLabel = (label) => {
        if (!label) return '';
        return label
            .replace(/DEPARTAMENTO DE /gi, 'DEPTO. ')
            .replace(/DEPARTAMENTO/gi, 'DEPTO.')
            .replace(/DIVISION DE ESTUDIOS DE /gi, 'DIV. ')
            .replace(/DIVISION DE /gi, 'DIV. ')
            .replace(/CENTRO DE INFORMACI√ìN/gi, 'C. Informaci√≥n')
            .replace(/CENTRO DE /gi, 'C. ')
            .replace(/INGENIER√çA/gi, 'ING.')
            .replace(/CIENCIAS/gi, 'CIENCIAS.')
            .replace(/ECONOMICO-ADMINISTRATIVAS/gi, 'ECO-ADMIN')
            .trim();
    };
    
    const getChartHeight = (count) => Math.max(400, count * 35) + "px"; // Aumentado ligeramente el alto por barra

    const getImageDataFromURL = (url) => {
        return new Promise((resolve) => {
            const img = new Image(); img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas'); canvas.width = img.width; canvas.height = img.height;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0);
                try { resolve(canvas.toDataURL('image/png')); } catch (e) { resolve(null); }
            };
            img.onerror = () => resolve(null); img.src = url;
        });
    };

    // ====================================================================
    // COMPONENTE: Login
    // ====================================================================
    const Login = ({ onLogin, loginError }) => {
        const googleButtonRef = React.useRef(null);

        React.useEffect(() => {
            let intervalId;
            const initGoogle = () => {
                if (window.google && window.google.accounts && googleButtonRef.current) {
                    try {
                        window.google.accounts.id.initialize({ 
                            client_id: CONFIG.GOOGLE_CLIENT_ID, 
                            callback: onLogin 
                        });
                        window.google.accounts.id.renderButton(googleButtonRef.current, { 
                            theme: "outline", size: "large", text: "signin_with", shape: "rectangular", logo_alignment: "left"
                        });
                        return true;
                    } catch (e) { return false; }
                }
                return false;
            };
            
            if (!initGoogle()) { 
                intervalId = setInterval(() => { if (initGoogle()) clearInterval(intervalId); }, 500); 
            }
            return () => { if(intervalId) clearInterval(intervalId); };
        }, [onLogin]);

        return (
            <div className="flex flex-col justify-center items-center py-20 animate-fadeIn px-4 flex-grow">
                <div className="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border-t-8 border-[#9D2449]">
                    <img src={ITD_LOGO_URL} alt="Logo ITD" className="h-24 mx-auto mb-6 object-contain" />
                    <h2 className="text-3xl font-bold text-[#1B396A] mb-2">Acceso Restringido</h2>
                    <p className="text-gray-500 mb-8 text-sm font-medium uppercase tracking-wide">Estad√≠sticas Institucionales</p>
                    {loginError && (<div className="mb-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-sm font-bold">{loginError}</div>)}
                    <div className="flex justify-center min-h-[50px]" ref={googleButtonRef}></div>
                </div>
            </div>
        );
    };

    // ====================================================================
    // COMPONENTE: ChartBox
    // ====================================================================
    const ChartBox = ({ type, data, title, id, horizontal = false, shortenLabels = false, minHeight = "350px", isHistory = false, customColors = null }) => {
        const chartRef = React.useRef(null);
        const canvasRef = React.useRef(null);
        const [menuOpen, setMenuOpen] = React.useState(false);
        const menuRef = React.useRef(null);

        React.useEffect(() => {
            const handleClickOutside = (event) => {
                if (menuRef.current && !menuRef.current.contains(event.target)) {
                    setMenuOpen(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => {
                document.removeEventListener("mousedown", handleClickOutside);
            };
        }, []);

        React.useEffect(() => {
            if (!canvasRef.current || !data) return;
            if (typeof window.Chart === 'undefined') return;
            
            if (chartRef.current) chartRef.current.destroy();

            const ctx = canvasRef.current.getContext('2d');
            const isPie = type === 'pie' || type === 'doughnut';
            
            // Preparar datos
            let chartDataConfig = {};

            if (isHistory) {
                // Modo historial: 'data' ya viene preparada desde el componente padre
                chartDataConfig = data;
            } else {
                // Modo est√°ndar: 'data' es un objeto clave-valor simple
                const rawLabels = Object.keys(data);
                const displayLabels = rawLabels.map(l => shortenLabels ? shortenLabel(l) : l);
                
                // Determinaci√≥n de colores
                const bgColors = customColors || (isPie ? INSTITUTIONAL_COLORS : VIBRANT_COLORS);
                const borderColors = isPie ? '#ffffff' : (customColors || VIBRANT_COLORS);

                chartDataConfig = {
                    labels: displayLabels,
                    datasets: [{ 
                        label: title.replace(/[üìöüë•üè¢üìãüìàüè´üë®‚Äçüè´]/g, '').trim(), 
                        data: Object.values(data), 
                        backgroundColor: bgColors,
                        borderColor: borderColors,
                        borderWidth: isPie ? 2 : 1,
                        borderRadius: isPie ? 0 : 6,
                        barPercentage: 0.6,
                        maxBarThickness: 50
                    }]
                };
            }

            const totalValues = isPie ? chartDataConfig.datasets[0].data.reduce((acc, curr) => acc + (typeof curr === 'number' ? curr : 0), 0) : 0;

            let config = {
                type: type,
                data: chartDataConfig,
                plugins: window.ChartDataLabels ? [window.ChartDataLabels] : [],
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    indexAxis: horizontal ? 'y' : 'x',
                    animation: { duration: 600, easing: 'easeOutQuart' },
                    scales: isPie ? {} : { 
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                color: '#374151',
                                font: { size: 11, weight: '600' },
                                autoSkip: false,
                                padding: 10,
                                callback: function(value) { 
                                    if (this.getLabelForValue && !isHistory && horizontal) {
                                        // Auto-wrap para etiquetas largas
                                        const label = this.getLabelForValue(value);
                                        // Aumentado el l√≠mite de caracteres antes de cortar l√≠nea para aprovechar el ancho completo
                                        const charLimit = 80; 
                                        if (typeof label === 'string' && label.length > charLimit) {
                                            const words = label.split(' ');
                                            const lines = [];
                                            let currentLine = words[0];
                                            for (let i = 1; i < words.length; i++) {
                                                if (currentLine.length + words[i].length < charLimit) {
                                                    currentLine += ' ' + words[i];
                                                } else {
                                                    lines.push(currentLine);
                                                    currentLine = words[i];
                                                }
                                            }
                                            lines.push(currentLine);
                                            return lines;
                                        }
                                        return label;
                                    }
                                    if (value % 1 === 0) return value; 
                                } 
                            },
                            grid: { color: '#e5e7eb', borderDash: [5, 5], display: !horizontal }
                        },
                        x: {
                            beginAtZero: true, 
                            ticks: { 
                                color: '#374151',
                                font: { size: 11, weight: '600' }
                            },
                            grid: { display: false }
                        }
                    },
                    plugins: { 
                        datalabels: {
                            display: true, 
                            align: isHistory ? 'top' : (horizontal ? 'end' : 'top'),
                            anchor: isHistory ? 'center' : (horizontal ? 'end' : 'end'),
                            backgroundColor: isHistory ? 'white' : (isPie ? 'rgba(0,0,0,0.6)' : 'transparent'),
                            borderRadius: 4,
                            color: isHistory ? '#1B396A' : (isPie ? '#fff' : '#374151'),
                            font: { weight: 'bold', size: 10 },
                            padding: 2,
                            formatter: (value) => {
                                if (isHistory) return value > 0 ? value : '';
                                if (totalValues > 0) {
                                    const percentage = ((value / totalValues) * 100).toFixed(1);
                                    if(percentage < 3 && !horizontal) return value;
                                    return `${value} (${percentage}%)`;
                                }
                                return value;
                            },
                            offset: 4,
                            clip: false
                        },
                        legend: { 
                            display: isPie || isHistory, 
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8
                            }
                        }
                    },
                    layout: { padding: { top: 25, right: 25, left: horizontal ? 10 : 10, bottom: 10 } }
                }
            };

            if (!isPie && horizontal) {
                config.options.scales.x.display = false;
            }
            if (isPie) config.options.layout.padding = 20;

            chartRef.current = new window.Chart(ctx, config);
            return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [data, type, title, horizontal, id, shortenLabels, isHistory, customColors]);

        const downloadSingleChart = (format) => {
            setMenuOpen(false);
            // Peque√±o delay para que se cierre el men√∫ antes de capturar
            setTimeout(async () => {
                const element = document.getElementById(`chartBox-${id}`);
                if (!element) return;

                try {
                    // Escala 4 para m√°xima calidad ‚Äî apto para presentaciones
                    const canvas = await html2canvas(element, { 
                        scale: 4, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        imageTimeout: 20000,
                        removeContainer: true,
                        ignoreElements: (el) => el.id === `menu-btn-${id}` 
                    });

                    // Cargar Logo
                    const logoData = await getImageDataFromURL(ITD_LOGO_URL);
                    const cleanTitle = title.replace(/[\u{1F300}-\u{1FFFF}]/gu, '').replace(/[üìöüë•üè¢üìãüìàüè´üë®‚Äçüè´]/g, '').trim();

                    if (format === 'png') {
                        // Encabezado proporcional al ancho del canvas para alta resoluci√≥n
                        const scale = canvas.width / 1200; // referencia 1200px
                        const headerHeight = Math.round(260 * scale);
                        const margin = Math.round(40 * scale);
                        const finalCanvas = document.createElement('canvas');
                        const ctx = finalCanvas.getContext('2d');
                        finalCanvas.width = canvas.width;
                        finalCanvas.height = canvas.height + headerHeight;

                        // Fondo Blanco
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                        // Franja azul superior
                        ctx.fillStyle = BLUE_COLOR;
                        ctx.fillRect(0, 0, finalCanvas.width, Math.round(headerHeight * 0.68));

                        // Logo (izquierda y derecha)
                        if (logoData) {
                            const img = new Image();
                            img.src = logoData;
                            await new Promise(r => img.onload = r);
                            const lh = Math.round(100 * scale);
                            const lw = Math.round((img.width / img.height) * lh);
                            const yLogo = Math.round(((headerHeight * 0.68) - lh) / 2);
                            ctx.drawImage(img, margin, yLogo, lw, lh);
                            ctx.drawImage(img, finalCanvas.width - margin - lw, yLogo, lw, lh);
                        }

                        // Texto: Instituto
                        ctx.textAlign = 'center';
                        ctx.fillStyle = '#ffffff';
                        ctx.font = `bold ${Math.round(36 * scale)}px Helvetica, Arial, sans-serif`;
                        ctx.fillText('INSTITUTO TECNOL√ìGICO DE DURANGO', finalCanvas.width / 2, Math.round(70 * scale));

                        // Texto: Subt√≠tulo
                        ctx.font = `${Math.round(22 * scale)}px Helvetica, Arial, sans-serif`;
                        ctx.fillText('Coordinaci√≥n de Actualizaci√≥n Docente', finalCanvas.width / 2, Math.round(110 * scale));

                        // L√≠nea guinda
                        ctx.strokeStyle = GUINDA_COLOR;
                        ctx.lineWidth = Math.round(4 * scale);
                        ctx.beginPath();
                        ctx.moveTo(margin, Math.round(headerHeight * 0.68) + Math.round(4 * scale));
                        ctx.lineTo(finalCanvas.width - margin, Math.round(headerHeight * 0.68) + Math.round(4 * scale));
                        ctx.stroke();

                        // T√≠tulo de la gr√°fica (sobre fondo blanco)
                        ctx.fillStyle = BLUE_COLOR;
                        ctx.font = `bold ${Math.round(28 * scale)}px Helvetica, Arial, sans-serif`;
                        ctx.fillText(cleanTitle, finalCanvas.width / 2, Math.round(headerHeight * 0.68) + Math.round(48 * scale));

                        // Gr√°fica
                        ctx.drawImage(canvas, 0, headerHeight);

                        const link = document.createElement('a');
                        link.download = `${cleanTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                        link.href = finalCanvas.toDataURL('image/png');
                        link.click();

                    } else if (format === 'pdf') {
                        const { jsPDF } = window.jspdf;
                        
                        // Siempre landscape para gr√°ficas ‚Äî m√°s espacio y mejor para presentaciones
                        const pdf = new jsPDF('landscape', 'mm', 'letter');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const margin = 10;
                        const headerEnd = 32;
                        const footerStart = pdfHeight - 12;

                        // Encabezado blanco con logos y l√≠nea guinda
                        pdf.setFillColor(255, 255, 255);
                        pdf.rect(0, 0, pdfWidth, headerEnd, 'F');

                        if (logoData) {
                            const imgProps = pdf.getImageProperties(logoData);
                            const lh = headerEnd - 4;
                            const lw = (imgProps.width / imgProps.height) * lh;
                            pdf.addImage(logoData, 'PNG', margin, 2, lw, lh);
                            pdf.addImage(logoData, 'PNG', pdfWidth - margin - lw, 2, lw, lh);
                        }

                        pdf.setFontSize(15);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(27, 57, 106);
                        pdf.text('INSTITUTO TECNOL√ìGICO DE DURANGO', pdfWidth / 2, 14, { align: 'center' });
                        pdf.setFontSize(9);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(100, 100, 100);
                        pdf.text('Coordinaci√≥n de Actualizaci√≥n Docente', pdfWidth / 2, 21, { align: 'center' });

                        // L√≠nea gruesa guinda al final del encabezado
                        pdf.setDrawColor(157, 36, 73);
                        pdf.setLineWidth(1.5);
                        pdf.line(0, headerEnd, pdfWidth, headerEnd);

                        pdf.setLineWidth(0.5);
                        pdf.setFontSize(13);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(27, 57, 106);
                        pdf.text(cleanTitle, pdfWidth / 2, headerEnd + 9, { align: 'center' });

                        // Imagen con ratio correcto
                        const imgData = canvas.toDataURL('image/jpeg', 1.0);
                        const imgProps2 = pdf.getImageProperties(imgData);
                        const ratio = imgProps2.width / imgProps2.height;
                        const availW = pdfWidth - margin * 2;
                        const availH = footerStart - headerEnd - 14;
                        let fw = availW, fh = fw / ratio;
                        if (fh > availH) { fh = availH; fw = fh * ratio; }
                        const fx = (pdfWidth - fw) / 2;
                        const fy = headerEnd + 13 + (availH - fh) / 2;
                        pdf.addImage(imgData, 'JPEG', fx, fy, fw, fh);

                        // Pie de p√°gina azul
                        pdf.setFillColor(27, 57, 106);
                        pdf.rect(0, footerStart, pdfWidth, 12, 'F');
                        pdf.setFontSize(8);
                        pdf.setTextColor(255, 255, 255);
                        const dateStr = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
                        pdf.text(`Generado: ${dateStr}`, margin, footerStart + 7);
                        pdf.text('Generado en: Coordinaci√≥n de Actualizaci√≥n Docente ‚Äî ITD', pdfWidth - margin, footerStart + 7, { align: 'right' });

                        pdf.save(`${cleanTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                    }
                } catch (err) {
                    console.error("Error descargando gr√°fica", err);
                    alert("Error al generar la descarga.");
                }
            }, 100);
        };

        return (
            <div id={`chartBox-${id}`} className="bg-white p-5 rounded-xl shadow-md h-full flex flex-col border border-gray-100 transition-all hover:shadow-lg relative" style={{ minHeight }}>
                <div className="flex justify-between items-center border-b border-gray-100 pb-3 mb-4">
                    <div className="w-8"></div> 
                    <h3 className="text-gray-700 font-bold text-center text-base flex items-center justify-center gap-2 flex-grow">
                        {title}
                    </h3>
                    <div className="relative" ref={menuRef}>
                        <button 
                            id={`menu-btn-${id}`}
                            onClick={() => setMenuOpen(!menuOpen)}
                            className="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 focus:outline-none transition-colors"
                            title="Opciones de descarga"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                        </button>
                        {menuOpen && (
                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-50 border border-gray-200 animate-fadeIn">
                                <div className="py-1">
                                    <button 
                                        onClick={() => downloadSingleChart('png')}
                                        className="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-[#1B396A]"
                                    >
                                        <span className="mr-2">üñºÔ∏è</span> Descargar PNG
                                    </button>
                                    <button 
                                        onClick={() => downloadSingleChart('pdf')}
                                        className="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-[#1B396A]"
                                    >
                                        <span className="mr-2">üìÑ</span> Descargar PDF
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
                <div className="flex-1 relative w-full h-full" style={{ minHeight: '200px' }}><canvas ref={canvasRef} id={id}></canvas></div>
            </div>
        );
    };

    // ====================================================================
    // COMPONENTE: Dashboard (L√≥gica principal)
    // ====================================================================
    const Dashboard = ({ user, onLogout }) => {
        const [statsData, setStatsData] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [generatingPDF, setGeneratingPDF] = React.useState(false);
        const [period, setPeriod] = React.useState("ACTUAL");
        const [availableYears, setAvailableYears] = React.useState([]);

        React.useEffect(() => {
            fetchData();
        }, [period]);

        const fetchData = async () => {
            setLoading(true);
            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`);
                const result = await response.json();
                if (result.success) {
                    setStatsData(result.data);
                    if(result.availableYears) setAvailableYears(result.availableYears);
                } else {
                    alert("Error obteniendo datos: " + result.message);
                }
            } catch (error) {
                console.error("Error:", error);
            } finally {
                setLoading(false);
            }
        };

        const generatePDF = async () => {
            setGeneratingPDF(true);
            await new Promise(resolve => setTimeout(resolve, 600));

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'letter');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 12;
                const contentWidth = pdfWidth - (margin * 2);
                const headerH = 24;
                const footerH = 14;
                const bodyTop = headerH + 4;
                const bodyBottom = pdfHeight - footerH - 4;
                const bodyHeight = bodyBottom - bodyTop;

                // Captura elemento manteniendo proporciones reales
                const captureElement = async (elementId) => {
                    const el = document.getElementById(elementId);
                    if (!el) return null;
                    const canvas = await html2canvas(el, {
                        scale: 4,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        imageTimeout: 20000,
                        removeContainer: true
                    });
                    return { dataUrl: canvas.toDataURL('image/jpeg', 1.0), w: canvas.width, h: canvas.height };
                };

                // A√±ade imagen respetando ratio; retorna la altura MM usada
                const placeImage = (doc, imgObj, x, yStart, maxW, maxH) => {
                    if (!imgObj) return 0;
                    const ratio = imgObj.w / imgObj.h;
                    let w = maxW;
                    let h = w / ratio;
                    if (h > maxH) { h = maxH; w = h * ratio; }
                    const xCentered = x + (maxW - w) / 2;
                    doc.addImage(imgObj.dataUrl, 'JPEG', xCentered, yStart, w, h);
                    return h;
                };

                const addHeader = async (doc) => {
                    const logo = await getImageDataFromURL(ITD_LOGO_URL);
                    // Fondo blanco
                    doc.setFillColor(255, 255, 255);
                    doc.rect(0, 0, pdfWidth, headerH, 'F');
                    if (logo) {
                        const imgProps = doc.getImageProperties(logo);
                        const lh = headerH - 4;
                        const lw = (imgProps.width / imgProps.height) * lh;
                        doc.addImage(logo, 'PNG', margin, 2, lw, lh);
                        doc.addImage(logo, 'PNG', pdfWidth - margin - lw, 2, lw, lh);
                    }
                    doc.setFontSize(13);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(27, 57, 106);
                    doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pdfWidth / 2, 11, { align: "center" });
                    doc.setFontSize(8.5);
                    doc.setFont("helvetica", "normal");
                    doc.setTextColor(100, 100, 100);
                    doc.text("Reporte Estad√≠stico de Actualizaci√≥n Docente", pdfWidth / 2, 18, { align: "center" });
                    // L√≠nea gruesa guinda al final del encabezado
                    doc.setDrawColor(157, 36, 73);
                    doc.setLineWidth(1.5);
                    doc.line(0, headerH, pdfWidth, headerH);
                };

                const addFooter = (doc, pageNum, total) => {
                    // Franja azul en el pie
                    doc.setFillColor(27, 57, 106);
                    doc.rect(0, pdfHeight - footerH, pdfWidth, footerH, 'F');
                    doc.setFontSize(8);
                    doc.setTextColor(255, 255, 255);
                    const date = new Date().toLocaleDateString('es-MX');
                    doc.text(`Generado: ${date}  |  P√°gina ${pageNum} de ${total}`, margin, pdfHeight - 4);
                    doc.text(`Generado en: Coordinaci√≥n de Actualizaci√≥n Docente ‚Äî ITD`, pdfWidth - margin, pdfHeight - 4, { align: "right" });
                };

                const newPage = async (doc, pageNum, total) => {
                    addFooter(doc, pageNum, total);
                    doc.addPage();
                    await addHeader(doc);
                };

                const totalPages = 5;
                let pageNum = 1;
                await addHeader(pdf);

                // --- P√°gina 1: KPIs ---
                const kpiImg = await captureElement('kpi-section');
                placeImage(pdf, kpiImg, margin, bodyTop, contentWidth, 38);
                await newPage(pdf, pageNum++, totalPages);

                // --- P√°gina 2: Top Cursos ---
                placeImage(pdf, await captureElement('chartBox-topCursos'), margin, bodyTop, contentWidth, bodyHeight);
                await newPage(pdf, pageNum++, totalPages);

                // --- P√°gina 3: Top Departamentos ---
                placeImage(pdf, await captureElement('chartBox-topDeptos'), margin, bodyTop, contentWidth, bodyHeight);
                await newPage(pdf, pageNum++, totalPages);

                // --- P√°gina 4: G√©nero + Tipo + Frecuencia ---
                const halfW = (contentWidth - 6) / 2;
                const g3Img = await captureElement('chartBox-genero');
                const g4Img = await captureElement('chartBox-tipo');
                const g5Img = await captureElement('chartBox-frecuencia');
                const h3 = placeImage(pdf, g3Img, margin, bodyTop, halfW, bodyHeight * 0.46);
                const h4 = placeImage(pdf, g4Img, margin + halfW + 6, bodyTop, halfW, bodyHeight * 0.46);
                const topSectionH = Math.max(h3, h4);
                placeImage(pdf, g5Img, margin, bodyTop + topSectionH + 6, contentWidth, bodyHeight - topSectionH - 6);
                await newPage(pdf, pageNum++, totalPages);

                // --- P√°gina 5: Hist√≥rico + Docentes por A√±o ---
                const g6Img = await captureElement('chartBox-historico');
                const g7Img = await captureElement('chartBox-docentesYear');
                const h6 = placeImage(pdf, g6Img, margin, bodyTop, contentWidth, bodyHeight * 0.47);
                placeImage(pdf, g7Img, margin, bodyTop + h6 + 6, contentWidth, bodyHeight * 0.47);
                addFooter(pdf, pageNum, totalPages);

                pdf.save(`Reporte_Estadistico_${period}.pdf`);
            } catch (err) {
                console.error("Error generando PDF:", err);
                alert("Error al generar el PDF: " + err.message);
            } finally {
                setGeneratingPDF(false);
            }
        };

        const generateWord = async () => {
            if (!statsData) { alert("No hay datos cargados a√∫n."); return; }
            setGeneratingPDF(true);

            try {
                // docx v8 expone todo en window.docx
                const docxLib = window.docx;
                if (!docxLib) throw new Error("Librer√≠a docx no cargada. Verifica tu conexi√≥n.");

                const {
                    Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell,
                    AlignmentType, HeadingLevel, WidthType, BorderStyle, ShadingType
                } = docxLib;

                const dateStr = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });

                const cellBorder = { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" };
                const borders = { top: cellBorder, bottom: cellBorder, left: cellBorder, right: cellBorder, insideH: cellBorder, insideV: cellBorder };

                // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const sep = () => new Paragraph({
                    border: { bottom: { style: BorderStyle.SINGLE, size: 4, color: "9D2449", space: 1 } },
                    spacing: { before: 60, after: 180 }
                });

                const title = (text) => new Paragraph({
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 0, after: 80 },
                    children: [new TextRun({ text, bold: true, color: "1B396A", font: "Arial", size: 36 })]
                });

                const subtitle = (text) => new Paragraph({
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 0, after: 80 },
                    children: [new TextRun({ text, bold: true, color: "9D2449", font: "Arial", size: 26 })]
                });

                const caption = (text) => new Paragraph({
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 0, after: 320 },
                    children: [new TextRun({ text, color: "888888", font: "Arial", size: 20 })]
                });

                const heading = (text) => new Paragraph({
                    spacing: { before: 320, after: 120 },
                    children: [new TextRun({ text, bold: true, color: "1B396A", font: "Arial", size: 28 })],
                    border: { bottom: { style: BorderStyle.SINGLE, size: 2, color: "D5E8F0", space: 1 } }
                });

                const spacer = () => new Paragraph({ spacing: { before: 40, after: 40 } });

                // Tabla de 2 columnas: etiqueta / valor
                const kpiTable = (rows) => new Table({
                    width: { size: 9360, type: WidthType.DXA },
                    columnWidths: [5760, 3600],
                    rows: rows.map(([label, value]) => new TableRow({
                        children: [
                            new TableCell({
                                borders,
                                width: { size: 5760, type: WidthType.DXA },
                                shading: { fill: "EEF4FB", type: ShadingType.CLEAR },
                                margins: { top: 100, bottom: 100, left: 160, right: 160 },
                                children: [new Paragraph({ children: [new TextRun({ text: String(label), font: "Arial", size: 22, color: "374151" })] })]
                            }),
                            new TableCell({
                                borders,
                                width: { size: 3600, type: WidthType.DXA },
                                shading: { fill: "FFFFFF", type: ShadingType.CLEAR },
                                margins: { top: 100, bottom: 100, left: 160, right: 160 },
                                verticalAlign: "center",
                                children: [new Paragraph({
                                    alignment: AlignmentType.RIGHT,
                                    children: [new TextRun({ text: String(value), font: "Arial", size: 24, bold: true, color: "9D2449" })]
                                })]
                            })
                        ]
                    }))
                });

                // Tabla de datos con encabezado azul
                const dataTable = (headers, rows, colWidths) => new Table({
                    width: { size: colWidths.reduce((a, b) => a + b, 0), type: WidthType.DXA },
                    columnWidths: colWidths,
                    rows: [
                        new TableRow({
                            tableHeader: true,
                            children: headers.map((h, i) => new TableCell({
                                borders,
                                width: { size: colWidths[i], type: WidthType.DXA },
                                shading: { fill: "1B396A", type: ShadingType.CLEAR },
                                margins: { top: 100, bottom: 100, left: 160, right: 160 },
                                children: [new Paragraph({ children: [new TextRun({ text: h, bold: true, color: "FFFFFF", font: "Arial", size: 20 })] })]
                            }))
                        }),
                        ...rows.map((row, ri) => new TableRow({
                            children: row.map((cell, i) => new TableCell({
                                borders,
                                width: { size: colWidths[i], type: WidthType.DXA },
                                shading: { fill: ri % 2 === 0 ? "FFFFFF" : "F8F9FA", type: ShadingType.CLEAR },
                                margins: { top: 80, bottom: 80, left: 160, right: 160 },
                                children: [new Paragraph({ children: [new TextRun({ text: String(cell), font: "Arial", size: 20, color: "374151" })] })]
                            }))
                        }))
                    ]
                });

                // ‚îÄ‚îÄ Contenido ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const children = [];

                // Portada
                children.push(spacer(), spacer(), spacer());
                children.push(title("INSTITUTO TECNOL√ìGICO DE DURANGO"));
                children.push(subtitle("Coordinaci√≥n de Actualizaci√≥n Docente"));
                children.push(spacer());
                children.push(sep());
                children.push(subtitle("Reporte Estad√≠stico"));
                children.push(caption(`Generado el ${dateStr}`));

                // 1. KPIs
                children.push(heading("1. Indicadores Clave de Desempe√±o"));
                children.push(kpiTable([
                    ["Total de Inscripciones", statsData.totalInscripciones ?? "‚Äî"],
                    ["Docentes √önicos Actualizados", statsData.coberturaDocente?.actualizados ?? "‚Äî"],
                    ["Cobertura de Plantilla Docente", statsData.coberturaDocente?.porcentaje != null ? `${statsData.coberturaDocente.porcentaje}%` : "‚Äî"],
                ]));
                children.push(spacer());

                // 2. Top Cursos
                if (statsData.topCursos?.length) {
                    children.push(heading("2. Cursos M√°s Demandados (Top 10)"));
                    children.push(dataTable(
                        ["#", "Nombre del Curso", "Inscripciones"],
                        statsData.topCursos.slice(0, 10).map(([nombre, n], i) => [`${i + 1}`, nombre, n]),
                        [600, 6960, 1800]
                    ));
                    children.push(spacer());
                }

                // 3. Departamentos
                if (statsData.topDepartamentos?.length) {
                    children.push(heading("3. Participaci√≥n por Departamento"));
                    children.push(dataTable(
                        ["#", "Departamento", "Total"],
                        statsData.topDepartamentos.map(([dept, n], i) => [`${i + 1}`, dept, n]),
                        [600, 6960, 1800]
                    ));
                    children.push(spacer());
                }

                // 4. G√©nero
                if (statsData.distribucionGenero) {
                    children.push(heading("4. Distribuci√≥n por G√©nero"));
                    children.push(kpiTable(Object.entries(statsData.distribucionGenero)));
                    children.push(spacer());
                }

                // 5. Tipo de Curso
                if (statsData.distribucionTipo) {
                    children.push(heading("5. Tipo de Curso"));
                    children.push(kpiTable(Object.entries(statsData.distribucionTipo)));
                    children.push(spacer());
                }

                // 6. Frecuencia
                if (statsData.frecuenciaParticipacion) {
                    children.push(heading("6. Cursos por Docente (Frecuencia de Participaci√≥n)"));
                    children.push(dataTable(
                        ["Cursos Tomados", "N√∫mero de Docentes"],
                        Object.entries(statsData.frecuenciaParticipacion),
                        [4680, 4680]
                    ));
                    children.push(spacer());
                }

                // 7. Hist√≥rico
                if (statsData.historicalTrend) {
                    children.push(heading("7. Evoluci√≥n Hist√≥rica por A√±o"));
                    const years = Object.keys(statsData.historicalTrend).sort();
                    children.push(dataTable(
                        ["A√±o", "Cursos Ofertados", "Total Docentes"],
                        years.map(y => [y, statsData.historicalTrend[y]?.cursos ?? 0, statsData.historicalTrend[y]?.registros ?? 0]),
                        [2340, 3510, 3510]
                    ));
                    children.push(spacer());
                }

                // Pie
                children.push(sep());
                children.push(new Paragraph({
                    alignment: AlignmentType.CENTER,
                    children: [new TextRun({ text: "M.C. Alejandro Calder√≥n Renter√≠a ‚Äî Coordinaci√≥n de Actualizaci√≥n Docente", font: "Arial", size: 18, color: "888888" })]
                }));

                // ‚îÄ‚îÄ Generar documento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const doc = new Document({
                    creator: "ITD - Desarrollo Acad√©mico",
                    title: "Reporte Estad√≠stico de Actualizaci√≥n Docente",
                    styles: {
                        default: {
                            document: { run: { font: "Arial", size: 22 } }
                        }
                    },
                    sections: [{
                        properties: {
                            page: {
                                size: { width: 12240, height: 15840 },
                                margin: { top: 1080, right: 1080, bottom: 1080, left: 1080 }
                            }
                        },
                        children
                    }]
                });

                const blob = await Packer.toBlob(doc);
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `Reporte_Estadistico_${period}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error("Error generando Word:", err);
                alert("Error al generar el documento Word:\n" + err.message);
            } finally {
                setGeneratingPDF(false);
            }
        };

        const generateCourseEvolutionData = () => {
            if (!statsData || !statsData.periodTrend || !statsData.historicalTrend) return { labels: [], datasets: [] };
            
            const pTrend = statsData.periodTrend;
            const hTrend = statsData.historicalTrend;
            
            const sortedYears = Object.keys(hTrend).sort();
            
            const labels = [];
            const dataValues = [];
            const bgColors = [];

            sortedYears.forEach(year => {
                const total = hTrend[year]?.cursos || 0;
                const ene = pTrend[`${year}-Enero`]?.cursos || 0;
                const jun = pTrend[`${year}-Junio`]?.cursos || 0;
                const ago = pTrend[`${year}-Agosto`]?.cursos || 0;

                labels.push(`Total '${year.substring(2)}`, 'Ene', 'Jun', 'Ago');
                dataValues.push(total, ene, jun, ago);
                
                bgColors.push('#1e3a8a'); // Navy para Total
                bgColors.push('#f472b6'); // Pink para Ene
                bgColors.push('#3b82f6'); // Blue para Jun
                bgColors.push('#fbbf24'); // Yellow para Ago
            });

            return {
                labels: labels,
                datasets: [{
                    label: 'Cursos Ofertados',
                    data: dataValues,
                    backgroundColor: bgColors,
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.8
                }]
            };
        };

        const generateTeacherEvolutionData = () => {
            if (!statsData || !statsData.historicalTrend) return { labels: [], datasets: [] };
            
            const years = Object.keys(statsData.historicalTrend).sort();
            const colors = ['#4f46e5', '#06b6d4', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981']; 
            
            return {
                labels: years,
                datasets: [{
                    label: 'Total Docentes',
                    data: years.map(y => statsData.historicalTrend[y].registros),
                    backgroundColor: years.map((_, i) => colors[i % colors.length]),
                    borderRadius: 6,
                    barPercentage: 0.5,
                    maxBarThickness: 50
                }]
            };
        };

        // --- RELOJ DE CARGA (LOADER) ---
        if (loading) {
            return (
                <div className="flex justify-center items-center h-full flex-col">
                    <div className="loader-spinner"></div>
                    <p className="text-[#1B396A] font-bold text-lg animate-pulse">Cargando estad√≠sticas...</p>
                </div>
            );
        }

        return (
            <div className="p-6 max-w-7xl mx-auto animate-fadeIn relative">
                {/* Modal de Generando PDF */}
                {generatingPDF && (
                    <div className="pdf-overlay">
                        <div className="pdf-modal">
                            <div className="loader-spinner"></div>
                            <h3 className="text-xl font-bold text-gray-800 mb-2">Generando Reporte</h3>
                            <p className="text-gray-500">Por favor espere, procesando datos...</p>
                        </div>
                    </div>
                )}

                {/* Encabezado del Dashboard */}
                <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-white p-6 rounded-xl shadow-md border-l-4 border-[#1B396A]">
                    <div>
                        <h2 className="text-2xl md:text-3xl font-bold text-gray-800">
                            Dashboard Estrat√©gico
                        </h2>
                        <p className="text-gray-500 mt-1">
                            An√°lisis de datos de actualizaci√≥n docente. Usuario: <span className="font-semibold text-[#1B396A]">{user.name}</span>
                        </p>
                    </div>
                    <div className="flex gap-3">
                        <div className="relative">
                            <select 
                                value={period} 
                                onChange={(e) => setPeriod(e.target.value)}
                                className="appearance-none bg-gray-50 border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-[#1B396A] font-bold cursor-pointer hover:bg-gray-100 transition-colors shadow-sm"
                            >
                                <option value="ACTUAL">üü¢ Periodo Actual</option>
                                {availableYears.map(y => <option key={y} value={y}>üìÖ A√±o {y}</option>)}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                        <button onClick={generatePDF} className="bg-[#9D2449] hover:bg-[#801d3a] text-white font-bold py-2 px-6 rounded-lg shadow transition-all transform hover:scale-105 flex items-center gap-2">
                            <span>üìÑ</span> PDF
                        </button>
                        <button onClick={generateWord} className="bg-[#1B396A] hover:bg-[#142b52] text-white font-bold py-2 px-6 rounded-lg shadow transition-all transform hover:scale-105 flex items-center gap-2">
                            <span>üìù</span> Word
                        </button>
                        <button onClick={onLogout} className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">
                            Salir
                        </button>
                    </div>
                </div>

                {/* KPIs (Modificado: 3 columnas, eliminado Cursos Activos) */}
                <div id="kpi-section" className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-blue-600 flex items-center justify-between">
                        <div>
                            <p className="text-gray-500 text-xs font-bold uppercase tracking-wider">Total Inscripciones</p>
                            <p className="text-3xl font-bold text-gray-800 mt-1">{statsData.totalInscripciones}</p>
                        </div>
                        <div className="text-3xl bg-blue-100 p-3 rounded-full text-blue-600">üìù</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-green-500 flex items-center justify-between">
                        <div>
                            <p className="text-gray-500 text-xs font-bold uppercase tracking-wider">Docentes √önicos</p>
                            <p className="text-3xl font-bold text-gray-800 mt-1">{statsData.coberturaDocente.actualizados}</p>
                        </div>
                        <div className="text-3xl bg-green-100 p-3 rounded-full text-green-600">üë•</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-yellow-500 flex items-center justify-between">
                        <div>
                            <p className="text-gray-500 text-xs font-bold uppercase tracking-wider">Cobertura Plantilla</p>
                            <p className="text-3xl font-bold text-gray-800 mt-1">{statsData.coberturaDocente.porcentaje}%</p>
                        </div>
                        <div className="text-3xl bg-yellow-100 p-3 rounded-full text-yellow-600">üè´</div>
                    </div>
                </div>

                {/* Secci√≥n Principal de Gr√°ficas: AHORA CADA UNA EN SU PROPIA FILA (Full Width) */}
                <div className="mb-8 space-y-8">
                    {/* Top Cursos - ANCHO COMPLETO */}
                    <div className="w-full">
                        <ChartBox 
                            id="topCursos"
                            type="bar" 
                            title="üìö Cursos M√°s Demandados" 
                            data={Object.fromEntries(statsData.topCursos.slice(0, 10))} 
                            horizontal={true}
                            minHeight={getChartHeight(10)}
                        />
                    </div>
                    
                    {/* Top Departamentos - ANCHO COMPLETO */}
                    <div className="w-full">
                        <ChartBox 
                            id="topDeptos"
                            type="bar" 
                            title="üè¢ Participaci√≥n por Departamento" 
                            data={Object.fromEntries(statsData.topDepartamentos)} 
                            shortenLabels={true}
                            horizontal={true}
                            minHeight={getChartHeight(statsData.topDepartamentos.length)}
                        />
                    </div>
                </div>

                {/* Secci√≥n Secundaria */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div className="md:col-span-1">
                        <ChartBox 
                            id="genero" 
                            type="doughnut" 
                            title="üë• Distribuci√≥n por G√©nero" 
                            data={statsData.distribucionGenero}
                            customColors={['#36A2EB', '#FF6384']} // Azul y Rosa
                        />
                    </div>
                    <div className="md:col-span-1">
                        <ChartBox 
                            id="tipo" 
                            type="pie" 
                            title="üìã Tipo de Curso" 
                            data={statsData.distribucionTipo}
                            customColors={['#10b981', '#f59e0b']} // Esmeralda y √Åmbar
                        />
                    </div>
                    <div className="md:col-span-1">
                        <ChartBox id="frecuencia" type="bar" title="üìà Cursos por Docente" data={statsData.frecuenciaParticipacion} />
                    </div>
                </div>

                {/* Evoluci√≥n Hist√≥rica */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <ChartBox 
                        id="historico"
                        type="bar" 
                        title="üìÖ Cursos Ofertados (Periodos vs Total Anual)" 
                        data={generateCourseEvolutionData()} 
                        isHistory={true}
                    />
                    <ChartBox 
                        id="docentesYear"
                        type="bar" 
                        title="üë®‚Äçüè´ Total Docentes por A√±o" 
                        data={generateTeacherEvolutionData()} 
                        isHistory={true}
                    />
                </div>
            </div>
        );
    };

    // ====================================================================
    // COMPONENTE PRINCIPAL: App
    // ====================================================================
    const App = () => {
        const [user, setUser] = React.useState(null);
        const [loginError, setLoginError] = React.useState('');

        const handleLogin = (response) => {
            try {
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                if (['alejandro.calderon@itdurango.edu.mx', 'desarrollo.academico@itdurango.edu.mx'].includes(payload.email)) {
                    setUser({ name: payload.name, email: payload.email, picture: payload.picture });
                } else {
                    setLoginError("Acceso denegado: Cuenta no autorizada para ver estad√≠sticas.");
                }
            } catch (error) {
                setLoginError("Error de autenticaci√≥n.");
            }
        };

        const handleLogout = () => {
            setUser(null);
            setLoginError('');
            if (window.google) window.google.accounts.id.disableAutoSelect();
        };

        if (!user) return <Login onLogin={handleLogin} loginError={loginError} />;
        return <Dashboard user={user} onLogout={handleLogout} />;
    };

    // Renderizado
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
