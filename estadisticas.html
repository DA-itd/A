<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Elementos exclusivos de impresi√≥n */
        .print-header-element, .print-footer-element { display: none; }

      <!-- INSTRUCCIONES: Reemplaza la secci√≥n @media print { ... } en tu archivo estadisticas.html con este c√≥digo -->

<style>
/* ====================================================================== */
/* SECCI√ìN DE IMPRESI√ìN OPTIMIZADA - VERSI√ìN CORREGIDA V2 */
/* ====================================================================== */
@media print {
    @page { 
        size: letter portrait; 
        margin: 0.5cm 0.8cm;
    }
    
    body { 
        background: white !important; 
        color: black !important; 
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important; 
        padding-top: 0px !important; 
        padding-bottom: 40px !important;
        font-size: 8.5pt !important;
    }
    
    /* Ocultar elementos innecesarios */
    header, footer, #back-link, .no-print, button, select, 
    #dashboard-header-controls, .print-hide { 
        display: none !important; 
    }
    
    /* ============================================ */
    /* ENCABEZADO COMPACTO */
    /* ============================================ */
    .print-header-element { 
        display: flex !important; 
        justify-content: space-between; 
        align-items: center; 
        position: static !important; 
        height: 45px; 
        background: white;
        border-bottom: 1px solid #1B396A; 
        padding: 5px 10px;
        margin-bottom: 8px;
    }
    .print-header-element img { 
        height: 38px; 
        object-fit: contain; 
    }
    .print-header-element .text-center { 
        flex: 1; 
        padding: 0 15px; 
    }
    .print-header-element h1 { 
        font-size: 9.5pt !important; 
        font-weight: 900 !important; 
        margin: 0; 
        color: #1B396A; 
        line-height: 1.1; 
    }
    .print-header-element h2 { 
        font-size: 8pt !important; 
        font-weight: bold !important; 
        margin: 2px 0 0 0; 
        color: #333 !important; 
        text-transform: uppercase; 
    }
    
    /* ============================================ */
    /* PIE DE P√ÅGINA */
    /* ============================================ */
    .print-footer-element { 
        display: flex !important; 
        justify-content: space-between;
        position: fixed; 
        bottom: 0; 
        left: 0; 
        width: 100%; 
        font-size: 7pt; 
        color: #555; 
        padding: 5px 10px;
        background: white; 
        border-top: 1px solid #eee; 
        z-index: 9999;
    }
    .print-footer-element::after {
        content: "P√°g. " counter(page);
    }
    
    /* ============================================ */
    /* CONTENEDOR PRINCIPAL */
    /* ============================================ */
    #dashboard-content { 
        width: 100% !important; 
        max-width: 100% !important;
        margin: 0 !important; 
        padding: 0 5px !important;
        padding-bottom: 35px !important;
    }
    
    /* ============================================ */
    /* KPIs EN UNA SOLA FILA COMPACTA */
    /* ============================================ */
    .md\:grid-cols-4 { 
        display: flex !important; 
        flex-wrap: nowrap !important;
        gap: 4px !important;
        justify-content: space-between;
        margin-bottom: 8px !important; 
        page-break-inside: avoid !important;
    }
    .md\:grid-cols-4 > div { 
        flex: 1 !important;
        border: 1px solid #ddd !important; 
        padding: 4px 6px !important; 
        margin: 0 !important;
        min-height: 38px !important; 
        max-height: 38px !important;
    }
    .md\:grid-cols-4 > div .text-3xl {
        font-size: 1.0rem !important; 
    }
    .md\:grid-cols-4 > div .text-2xl {
        font-size: 0.95rem !important; 
        margin: 1px 0 !important;
    }
    .md\:grid-cols-4 > div .text-\[10px\] {
        font-size: 6.5pt !important; 
    }
    
    /* ============================================ */
    /* RESETEAR CLASES DE ALTURA WEB */
    /* ============================================ */
    .h-96, .h-full, .flex-1 {
        height: auto !important; 
        min-height: 0 !important;
        flex: none !important;
    }
    
    /* ============================================ */
    /* CONTENEDORES DE GR√ÅFICAS - SIN BORDES */
    /* ============================================ */
    .bg-white, .shadow-md, .shadow-xl { 
        box-shadow: none !important; 
        border: none !important;
        padding: 3px !important; 
        break-inside: avoid !important; 
        page-break-inside: avoid !important;
    }
    
    /* ============================================ */
    /* ESTRUCTURA DE GRIDS - FORZAR LAYOUT CORRECTO */
    /* ============================================ */
    
    /* Todos los grids principales */
    #dashboard-content > .grid {
        display: grid !important;
        gap: 6px !important;
        margin-bottom: 6px !important;
        page-break-inside: avoid !important;
    }
    
    /* PRIMER GRID: Cursos + G√©nero (2 columnas) */
    #dashboard-content > .grid:nth-of-type(1) {
        grid-template-columns: 58% 40% !important;
        height: 230px !important;
    }
    
    #dashboard-content > .grid:nth-of-type(1) > div:nth-child(1) {
        grid-column: 1 / 2 !important;
        height: 230px !important;
    }
    
    #dashboard-content > .grid:nth-of-type(1) > div:nth-child(2) {
        grid-column: 2 / 3 !important;
        height: 230px !important;
    }
    
    /* SEGUNDO GRID: Departamentos + Tipo (2 columnas) */
    #dashboard-content > .grid:nth-of-type(2) {
        grid-template-columns: 68% 30% !important;
        min-height: 260px !important;
    }
    
    /* Departamentos con leyenda */
    #dashboard-content > .grid:nth-of-type(2) > div:nth-child(1) {
        grid-column: 1 / 2 !important;
        display: flex !important;
        flex-direction: column !important;
        height: auto !important;
    }
    
    /* √Årea de gr√°fica de departamentos */
    #dashboard-content > .grid:nth-of-type(2) > div:nth-child(1) > div:first-child {
        height: 200px !important;
        flex-shrink: 0 !important;
    }
    
    /* Tipo de curso */
    #dashboard-content > .grid:nth-of-type(2) > div:nth-child(2) {
        grid-column: 2 / 3 !important;
        height: 200px !important;
    }
    
    /* GR√ÅFICA HIST√ìRICA: Ancho completo, despu√©s del segundo grid */
    #dashboard-content > .mb-8 {
        width: 100% !important;
        height: 200px !important;
        margin-bottom: 6px !important;
        page-break-before: auto !important;
        page-break-inside: avoid !important;
    }
    
    /* ============================================ */
    /* WRAPPERS DE GR√ÅFICAS */
    /* ============================================ */
    .chart-container-wrapper { 
        height: 100% !important; 
        width: 100% !important;
        padding: 3px !important; 
        box-shadow: none !important;
        border: none !important;
        page-break-inside: avoid !important;
        overflow: hidden !important;
    }
    
    /* Contenedor interno de canvas */
    .chart-container-wrapper > div {
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* √Årea del canvas espec√≠ficamente */
    .chart-container-wrapper .relative {
        flex: 1 !important;
        min-height: 0 !important;
        height: calc(100% - 22px) !important;
    }
    
    /* ============================================ */
    /* CANVAS - MANTENER PROPORCIONES */
    /* ============================================ */
    canvas { 
        max-width: 100% !important; 
        max-height: 100% !important; 
        width: 100% !important;
        height: 100% !important;
        display: block !important;
    }
    
    /* ============================================ */
    /* LEYENDA DE DEPARTAMENTOS COMPACTA */
    /* ============================================ */
    .bg-gray-50.p-4 {
        padding: 5px !important; 
        max-height: 50px !important; 
        min-height: 0 !important;
        overflow: hidden !important;
        border: none !important;
        background: #f9fafb !important;
        border-top: 1px solid #e5e7eb !important;
        flex-shrink: 0 !important;
    }
    .bg-gray-50.p-4 .text-xs {
        font-size: 6pt !important; 
        line-height: 1.15 !important;
    }
    .bg-gray-50.p-4 .grid {
        grid-template-columns: 1fr 1fr 1fr !important; 
        gap: 2px !important;
    }
    .bg-gray-50.p-4 p {
        margin-bottom: 2px !important;
    }
    
    /* ============================================ */
    /* T√çTULOS DE GR√ÅFICAS */
    /* ============================================ */
    .bg-white h3, .chart-container-wrapper h3 {
        font-size: 8.5pt !important; 
        margin-bottom: 2px !important; 
        margin-top: 0 !important;
        padding: 0 !important;
        font-weight: bold !important;
        color: #1f2937 !important;
    }
    
    /* ============================================ */
    /* AJUSTES FINALES PARA COMPACTACI√ìN */
    /* ============================================ */
    * {
        line-height: 1.15 !important; 
    }
    
    .py-8, .py-6, .py-4 {
        padding-top: 2px !important; 
        padding-bottom: 2px !important; 
    }
    
    .my-8, .my-6, .my-4 {
        margin-top: 4px !important; 
        margin-bottom: 4px !important; 
    }
    
    /* Forzar todas las columnas web a auto */
    .lg\:col-span-7, .lg\:col-span-5, 
    .lg\:col-span-9, .lg\:col-span-3 {
        grid-column: auto !important;
    }
    
    /* Prevenir desbordamiento */
    #dashboard-content, #dashboard-content * {
        overflow: visible !important;
        max-width: 100% !important;
    }
    
    /* Asegurar que el segundo grid no fuerce salto */
    #dashboard-content > .grid:nth-of-type(2) {
        page-break-after: avoid !important;
    }
    
    /* Forzar hist√≥rica a estar en la misma o siguiente p√°gina sin cortes */
    #dashboard-content > .mb-8:last-of-type {
        page-break-before: auto !important;
        margin-top: 6px !important;
    }
}

/* ====================================================================== */
/* FIN SECCI√ìN DE IMPRESI√ìN */
/* ====================================================================== */
</style>

<!-- 
INSTRUCCIONES DE IMPLEMENTACI√ìN:

1. Abre tu archivo estadisticas.html
2. Busca la secci√≥n "@media print {"
3. Reemplaza TODO desde "@media print {" hasta el "}" de cierre
4. Pega este c√≥digo completo
5. Guarda y prueba

CORRECCIONES APLICADAS:
‚úÖ Grid selectores espec√≠ficos usando nth-of-type(1) y nth-of-type(2)
‚úÖ Alturas fijas para evitar colapsos (230px, 200px)
‚úÖ Proporciones de columnas balanceadas (58%-40%, 68%-30%)
‚úÖ Hist√≥rica con altura controlada (200px) y sin saltos de p√°gina forzados
‚úÖ Leyenda de departamentos limitada a 50px m√°ximo
‚úÖ KPIs con altura m√°xima de 38px
‚úÖ Eliminaci√≥n de overlapping mediante overflow: hidden

RESULTADO ESPERADO:
- P√°gina 1: Encabezado + KPIs + Cursos/G√©nero + Departamentos/Tipo
- P√°gina 2: Evoluci√≥n Hist√≥rica completa sin cortes
-->
</style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen text-gray-800">

    <div class="print-header-element container mx-auto">
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM">
        <div class="text-center">
            <h1>INSTITUTO TECNOL√ìGICO DE DURANGO</h1>
            <h2>COORDINACI√ìN DE ACTUALIZACI√ìN DOCENTE</h2>
        </div>
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD">
    </div>

    <header class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A] no-print">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>
    
    <div id="back-link" class="container mx-auto px-4 py-4 no-print">
        <a href="index.html" 
           onclick="event.preventDefault(); window.location.href = 'index.html';" 
           class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-bold transition-colors">
            ‚Üê Volver al Portal Principal
        </a>
    </div>

    <div id="root">
        <div class="flex justify-center items-center h-64">
            <div class="text-center">
                <div class="animate-spin h-10 w-10 border-4 border-[#1B396A] rounded-full border-t-transparent mx-auto mb-4"></div>
                <p class="text-gray-600 font-semibold">Cargando sistema...</p>
            </div>
        </div>
    </div>

    <footer class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449] no-print">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>
    
    <div class="print-footer-element">
        <span>¬© Coordinaci√≥n de Actualizaci√≥n Docente | Reporte Generado: <script>document.write(new Date().toLocaleDateString());</script></span>
        </div>

    <script type="text/babel">
        // FIX CR√çTICO: Acceso seguro a React y ReactDOM
        const React = window.React;
        const ReactDOM = window.ReactDOM;

        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
        };

        const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
        const VIBRANT_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#6A4C93', '#F15BB5', '#E9C46A', '#2A9D8F', '#E76F51'];
        
        const DEPT_ACRONYMS = { "SISTEMAS Y COMPUTACION": "DSC", "CIENCIAS ECONOMICO-ADMINISTRATIVAS": "DCEA", "INGENIER√çA QU√çMICA-BIOQU√çMICA": "DIQB", "QUIMICA-BIOQUIMICA": "DIQB", "CIENCIAS DE LA TIERRA": "DCT", "CIENCIAS BASICAS": "DCB", "METAL-MEC√ÅNICA": "DMM", "METAL MECANICA": "DMM", "INGENIER√çA INDUSTRIAL": "DII", "INDUSTRIAL": "DII", "INGENIER√çA EL√âCTRICA Y ELECTR√ìNICA": "DIEE", "ELECTRICA Y ELECTRONICA": "DIEE", "POSGRADO E INVESTIGACION": "DEPI", "ADMINISTRATIVO": "ADMON", "EXTERNO": "EXT", "DESARROLLO ACAD√âMICO": "DDA", "GESTION TECNOLOGICA": "DGT" };
        const getAcronym = (fullName) => { if(!fullName) return "ND"; const nameUpper = fullName.toUpperCase().replace('DEPARTAMENTO DE ', '').replace('DIVISION DE ESTUDIOS DE ', '').replace('CENTRO DE ', ''); for (const [key, val] of Object.entries(DEPT_ACRONYMS)) { if (nameUpper.includes(key)) return val; } const words = nameUpper.split(' '); if(words.length > 1) return words.map(w => w[0]).join('').substring(0,4); return nameUpper.substring(0, 4) + "."; };
        
        const splitLabel = (label, maxLength = 30) => { 
            if (!label || label.length <= maxLength) return label; 
            const words = label.split(' '); 
            const lines = []; 
            let currentLine = words[0]; 
            for (let i = 1; i < words.length; i++) { 
                if (currentLine.length + 1 + words[i].length <= maxLength) { 
                    currentLine += " " + words[i]; 
                } else { 
                    lines.push(currentLine); 
                    currentLine = words[i]; 
                } 
            } 
            lines.push(currentLine); 
            return lines; 
        };

        const Login = ({ onLogin, loginError }) => {
            const googleButtonRef = React.useRef(null);

            React.useEffect(() => {
                let intervalId;
                const initGoogle = () => {
                    if (window.google && window.google.accounts && googleButtonRef.current) {
                        try {
                            window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin });
                            window.google.accounts.id.renderButton(googleButtonRef.current, { theme: "outline", size: "large", text: "signin_with" });
                            return true;
                        } catch (e) { console.error("Error initializing Google Sign-In", e); return false; }
                    }
                    return false;
                };
                if (!initGoogle()) { intervalId = setInterval(() => { if (initGoogle()) clearInterval(intervalId); }, 500); }
                return () => { if(intervalId) clearInterval(intervalId); };
            }, [onLogin]);

            return (
                <div className="flex flex-col justify-center items-center py-20 animate-fadeIn px-4">
                    <div className="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 p-10 rounded-xl shadow-lg text-center max-w-md w-full border-t-4 border-[#9D2449]">
                        <div className="text-4xl mb-4">üîí</div>
                        <h2 className="text-2xl font-bold text-[#9D2449] mb-4">Acceso Restringido</h2>
                        <p className="text-gray-600 mb-8 font-bold">Inicie sesi√≥n con su cuenta institucional.</p>
                        {loginError && <div className="mb-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">{loginError}</div>}
                        <div className="flex justify-center min-h-[50px]" ref={googleButtonRef}></div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [stats, setStats] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [period, setPeriod] = React.useState('ACTUAL');
            const [availableYears, setAvailableYears] = React.useState([]);

            React.useEffect(() => {
                let isMounted = true;
                setLoading(true);
                setError(null);

                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`)
                    .then(r => { if(!r.ok) throw new Error(`Error HTTP: ${r.status}`); return r.json(); })
                    .then(res => {
                        if (!isMounted) return;
                        if (res.success) {
                            setStats(res.data);
                            if (res.availableYears) setAvailableYears(res.availableYears);
                        } else throw new Error(res.message || "Error de datos.");
                    })
                    .catch(err => { if (isMounted) setError(err.message); })
                    .finally(() => { if (isMounted) setLoading(false); });

                return () => { isMounted = false; };
            }, [period]);

            const processedDepts = React.useMemo(() => {
                if (!stats?.topDepartamentos) return { chartData: {}, legend: [] };
                const chartData = {}; const legend = [];
                stats.topDepartamentos.forEach(([name, count]) => {
                    const acronym = getAcronym(name);
                    chartData[acronym] = count;
                    legend.push({ acronym, name });
                });
                return { chartData, legend };
            }, [stats]);

            if (loading && !stats) return <div className="flex justify-center items-center h-96"><div className="animate-spin h-16 w-16 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div>;
            if (error) return <div className="flex justify-center items-center py-20"><div className="text-red-600 font-bold text-xl">Error: {error} <br/><button onClick={()=>window.location.reload()} className="text-sm text-blue-600 underline mt-2">Recargar</button></div></div>;
            if (!stats) return null;

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl animate-fadeIn" id="dashboard-content">
                    <div id="dashboard-header-controls" className="bg-white rounded-xl shadow-sm p-4 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#9D2449] gap-4 no-print">
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-[#1B396A]">Dashboard de Resultados</h2>
                            <p className="text-sm text-gray-500 font-bold">Usuario: <span className="font-extrabold text-gray-700">{user.name}</span></p>
                        </div>
                        <div className="flex items-center gap-4">
                            <select value={period} onChange={(e) => setPeriod(e.target.value)} className="bg-white border border-gray-300 text-gray-700 text-sm rounded-md font-bold block p-1.5 outline-none focus:ring-2 focus:ring-[#1B396A]">
                                <option value="ACTUAL">üü¢ Periodo Actual</option>
                                {availableYears.filter(y => y !== 'ACTUAL').map(year => <option key={year} value={year}>üìÖ Hist√≥rico {year}</option>)}
                            </select>
                            <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition flex items-center gap-2"><span>üñ®Ô∏è</span> Imprimir Reporte</button>
                            <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm font-bold text-gray-700 border border-gray-300 transition">Cerrar Sesi√≥n</button>
                        </div>
                    </div>
                    
                    {loading && <div className="flex justify-center items-center h-20 text-blue-600 font-bold">Cargando datos...</div>}


                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        {[
                            { icon: "üìù", val: stats.totalInscripciones, label: "Docentes Inscritos", color: "border-[#1B396A]" },
                            { icon: "üë©‚Äçüè´", val: stats.coberturaDocente.actualizados, label: "Docentes √önicos", color: "border-[#D4AF37]" },
                            { icon: "üîÅ", val: stats.coberturaDocente.recurrentes, label: "Docentes Recurrentes", color: "border-[#9D2449]" },
                            { icon: "üéØ", val: `${stats.coberturaDocente.porcentaje}%`, label: "Cobertura Estimada", color: "border-gray-500" }
                        ].map((kpi, idx) => (
                            <div key={idx} className={`bg-white p-5 rounded-xl shadow-md border-b-4 ${kpi.color} flex items-center gap-3`}>
                                <div className="text-3xl">{kpi.icon}</div>
                                <div><div className="text-2xl font-bold text-gray-800">{kpi.val}</div><div className="text-[10px] font-bold text-gray-500 uppercase">{kpi.label}</div></div>
                            </div>
                        ))}
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 my-8">
                        <div class="lg:col-span-7 h-96 chart-container-wrapper"><StatsChart type="bar" data={Object.fromEntries(stats.topCursos||[])} title="Cursos M√°s Demandados" id="chartCourse" horizontal={true} /></div>
                        <div class="lg:col-span-5 h-96 chart-container-wrapper"><StatsChart type="doughnut" data={stats.distribucionGenero} title="Distribuci√≥n por G√©nero" id="chartGen" /></div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
                        <div class="lg:col-span-9 h-full flex flex-col bg-white rounded-xl shadow-md border-t-4 border-[#1B396A]">
                            <div class="p-6 flex-1 h-96 chart-container-wrapper"><StatsChart type="bar" data={processedDepts.chartData} title="Top 5 Departamentos" id="chartDept" horizontal={true} /></div>
                            <div class="bg-gray-50 p-4 border-t border-gray-200 rounded-b-xl print-hide">
                                <p class="text-xs font-bold text-gray-500 mb-2 uppercase">Leyenda:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs text-gray-600 max-h-32 overflow-y-auto custom-scrollbar">
                                    {processedDepts.legend.map((item, idx) => <div key={idx} class="flex items-start gap-2"><span class="font-bold text-[#1B396A] min-w-[35px]">{item.acronym}:</span><span class="truncate" title={item.name}>{item.name}</span></div>)}
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-3 h-full"><div class="h-96 chart-container-wrapper"><StatsChart type="bar" data={stats.distribucionTipo} title="Tipo de Curso" id="chartType" horizontal={false} /></div></div>
                    </div>

                     <div class="mb-8 h-96 chart-container-wrapper">
                        <StatsChart type="line" data={stats.historicalTrend || {}} title="Evoluci√≥n Hist√≥rica" id="chartHistory" horizontal={false} />
                    </div>
                </div>
            );
        };
        
        const StatsChart = ({ type, data, title, id, horizontal = false }) => {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (!canvasRef.current || !data) return;
                if (typeof window.Chart === 'undefined') return;
                
                if(window.ChartDataLabels) {
                    if (!window.Chart.registry.plugins.get('datalabels')) {
                         window.Chart.register(window.ChartDataLabels);
                    }
                }
                
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                const isHistory = id === 'chartHistory';
                const isPie = type === 'pie' || type === 'doughnut';
                
                // Determinamos el tama√±o de fuente para impresi√≥n/pantalla de manera segura
                const isPrinting = window.matchMedia && window.matchMedia('print').matches;
                const printFontSize = 8;
                const screenFontSize = 10;
                const pieLabelFontSize = isPrinting ? 8 : 12;
                const historyLabelFontSize = isPrinting ? 7 : 11;
                
                let config = {
                    type: isHistory ? 'line' : type,
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false, 
                        indexAxis: horizontal ? 'y' : 'x',
                        
                        // CONFIGURACI√ìN DE ESCALAS PARA IMPRESI√ìN (Texto m√°s peque√±o y claro)
                        scales: isPie ? {} : { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    stepSize: 1, 
                                    color: '#000000', // Texto negro
                                    font: { 
                                        size: isPrinting ? printFontSize : screenFontSize, /* Tama√±o de impresi√≥n */
                                        weight: 'bold' 
                                    },
                                },
                                barPercentage: horizontal ? 0.9 : 1, 
                                categoryPercentage: horizontal ? 0.9 : 1 
                            },
                            x: isPie ? {} : {
                                beginAtZero: true, 
                                ticks: { 
                                    stepSize: 1,
                                    color: '#000000',
                                    font: { 
                                        size: isPrinting ? printFontSize : screenFontSize, /* Tama√±o de impresi√≥n */
                                        weight: 'bold' 
                                    },
                                },
                                barPercentage: horizontal ? 0.9 : 1, 
                                categoryPercentage: horizontal ? 0.9 : 1 
                            }
                        },
                        plugins: { 
                            legend: { 
                                display: isPie || isHistory, 
                                position: 'bottom', 
                                labels: { 
                                    color: '#000000', // Texto de leyenda negro
                                    font: {
                                        size: pieLabelFontSize, /* Ajustado para impresi√≥n */
                                        weight: 'bold'
                                    }
                                }
                            }, 
                            datalabels: { display: false } 
                        },
                        layout: {
                            padding: isHistory ? { top: 30 } : 0 
                        }
                    }
                };
                
                // Ajuste espec√≠fico para barras horizontales (Cursos m√°s demandados y Top 5 Deptos)
                if (horizontal) {
                    // Forzar a que las etiquetas de cursos/departamentos sean legibles
                    config.options.scales.y.ticks.autoSkip = false;
                    config.options.scales.y.ticks.maxRotation = 0;
                    config.options.scales.y.ticks.minRotation = 0;
                }
                
                // Ajuste espec√≠fico para Doughnut (para asegurar la leyenda)
                if (isPie) {
                    config.options.plugins.datalabels = { 
                        display: true, 
                        color: '#fff',
                        formatter: (value, context) => {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return percentage + '%';
                        },
                        font: {
                            weight: 'bold',
                            size: pieLabelFontSize 
                        }
                    };
                }


                if (isHistory) {
                    // Configuraci√≥n espec√≠fica para Evoluci√≥n Hist√≥rica
                    const years = Object.keys(data).sort((a,b) => parseInt(a) - parseInt(b));
                    config.data = {
                        labels: years,
                        datasets: [
                            { 
                                label: 'Docentes Inscritos', 
                                data: years.map(y => data[y].registros), 
                                borderColor: '#36A2EB', 
                                backgroundColor: '#36A2EB', 
                                tension: 0.3,
                                datalabels: { align: 'end', anchor: 'end' }
                            },
                            { 
                                label: '# Cursos', 
                                data: years.map(y => data[y].cursos), 
                                borderColor: '#FF6384', 
                                backgroundColor: '#FF6384', 
                                tension: 0.3,
                                datalabels: { align: 'end', anchor: 'end', offset: 4 }
                            }
                        ]
                    };
                    // Activar DataLabels para esta gr√°fica espec√≠fica con alta visibilidad
                    config.options.plugins.datalabels = { 
                        display: true, 
                        color: '#444',
                        font: {
                            weight: 'bold',
                            size: historyLabelFontSize
                        },
                        backgroundColor: 'rgba(255, 255, 255, 0.7)',
                        borderRadius: 4,
                        padding: 4
                    };
                } else {
                    const labels = Object.keys(data);
                    config.data = {
                        labels: labels.map(l => horizontal ? splitLabel(l, 30) : l),
                        datasets: [{ label: title, data: Object.values(data), backgroundColor: isPie ? INSTITUTIONAL_COLORS : VIBRANT_COLORS }]
                    };
                }

                chartRef.current = new window.Chart(ctx, config);
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, title, horizontal, id]);

            return (
                <div className="bg-white p-4 rounded-xl shadow-md h-full flex flex-col border border-gray-100">
                    <h3 className="text-gray-700 font-bold mb-2 text-center">{title}</h3>
                    <div className="flex-1 relative min-h-[200px]"><canvas ref={canvasRef} id={id}></canvas></div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [loginError, setLoginError] = React.useState(null);
            const handleLogin = (res) => {
                try {
                    const p = JSON.parse(atob(res.credential.split('.')[1]));
                    setUser({ name: p.name, email: p.email });
                } catch (e) { setLoginError("Error de acceso."); }
            };
            // Se elimin√≥ el ';' al final de la l√≠nea return para mayor compatibilidad con JSX/Babel
            return user ? <Dashboard user={user} onLogout={() => setUser(null)} /> : <Login onLogin={handleLogin} loginError={loginError} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        document.addEventListener('DOMContentLoaded', () => { const el = document.getElementById('copyright-year'); if(el) el.textContent = new Date().getFullYear(); });
    </script>
</body>
</html>
