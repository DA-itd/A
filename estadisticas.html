<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- React y Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <!-- Plugin para etiquetas de datos en gr√°ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Librer√≠as para Reportes (PDF y Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1B396A; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #9D2449; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body strong { color: #1B396A; }
        /* Scrollbar para la leyenda */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #999; }
    </style>
</head>
<!-- FONDO C√ÅLIDO APLICADO -->
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>
    
    <div id="back-link" class="container mx-auto px-4 py-4">
        <a href="index.html" class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-bold transition-colors">
            ‚Üê Volver al Portal Principal
        </a>
    </div>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
        };

        const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
        const VIBRANT_COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#8AC926', '#1982C4', '#6A4C93', '#F15BB5', '#E9C46A', '#2A9D8F', '#E76F51'
        ];

        // Mapeo de Departamentos a Siglas
        const DEPT_ACRONYMS = {
            "SISTEMAS Y COMPUTACION": "DSC",
            "CIENCIAS ECONOMICO-ADMINISTRATIVAS": "DCEA",
            "INGENIER√çA QU√çMICA-BIOQU√çMICA": "DIQB",
            "QUIMICA-BIOQUIMICA": "DIQB",
            "CIENCIAS DE LA TIERRA": "DCT",
            "CIENCIAS BASICAS": "DCB",
            "METAL-MEC√ÅNICA": "DMM",
            "METAL MECANICA": "DMM",
            "INGENIER√çA INDUSTRIAL": "DII",
            "INDUSTRIAL": "DII",
            "INGENIER√çA EL√âCTRICA Y ELECTR√ìNICA": "DIEE",
            "ELECTRICA Y ELECTRONICA": "DIEE",
            "POSGRADO E INVESTIGACION": "DEPI",
            "ADMINISTRATIVO": "ADMON",
            "EXTERNO": "EXT",
            "DESARROLLO ACAD√âMICO": "DDA",
            "GESTION TECNOLOGICA": "DGT"
        };

        const getAcronym = (fullName) => {
            if(!fullName) return "ND";
            const nameUpper = fullName.toUpperCase()
                .replace('DEPARTAMENTO DE ', '')
                .replace('DIVISION DE ESTUDIOS DE ', '')
                .replace('CENTRO DE ', '');
            
            for (const [key, val] of Object.entries(DEPT_ACRONYMS)) {
                if (nameUpper.includes(key)) return val;
            }
            const words = nameUpper.split(' ');
            if(words.length > 1) return words.map(w => w[0]).join('').substring(0,4);
            return nameUpper.substring(0, 4) + ".";
        };

        // Funci√≥n auxiliar para dividir texto largo en l√≠neas
        const splitLabel = (label, maxLength = 45) => {
            if (label.length <= maxLength) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                if (currentLine.length + 1 + words[i].length <= maxLength) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        };

        const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';
        const TECNM_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg';

        const getImageDataFromURL = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = (err) => { console.warn("Error cargando imagen PDF", err); resolve(null); };
                img.src = url;
            });
        };

        const generatePDFReport = async (data, meta, returnBlob = false) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            const [itdLogo, tecNmLogo] = await Promise.all([
                getImageDataFromURL(ITD_LOGO_URL),
                getImageDataFromURL(TECNM_LOGO_URL)
            ]);

            const drawHeader = (data) => {
                if (tecNmLogo) doc.addImage(tecNmLogo, 'JPEG', 15, 10, 35, 16);
                if (itdLogo) {
                    const logoSize = 22; 
                    doc.addImage(itdLogo, 'PNG', pageWidth - 15 - logoSize, 8, logoSize, logoSize);
                }

                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(27, 57, 106);
                doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth / 2, 18, { align: "center" });
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth / 2, 23, { align: "center" });
                
                doc.setFontSize(11);
                doc.setTextColor(157, 36, 73);
                doc.text(`REPORTE DE INSCRIPCIONES - PERIODO ${meta.period}`, pageWidth / 2, 32, { align: "center" });

                doc.setFontSize(9);
                doc.setTextColor(50);
                doc.text(`Departamento Filtrado: ${meta.department}`, 15, 42);
                doc.text(`Fecha de Emisi√≥n: ${new Date().toLocaleDateString()}`, 15, 47);
            };

            const drawWatermark = () => {
                if (itdLogo) {
                    doc.saveGraphicsState();
                    doc.setGState(new doc.GState({ opacity: 0.08 }));
                    const w = 140;
                    const h = 140;
                    const x = (pageWidth - w) / 2;
                    const y = (pageHeight - h) / 2;
                    doc.addImage(itdLogo, 'PNG', x, y, w, h);
                    doc.restoreGraphicsState();
                }
            };

            const tableColumn = ["Docente", "Curso Inscrito", "Fechas", "Depto. que Ofrece"];
            const tableRows = data.map(row => [
                row.nombre,
                row.curso,
                row.fechas || 'N/A',
                row.depto_oferente || 'N/A'
            ]);

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 52,
                theme: 'grid',
                headStyles: { fillColor: [27, 57, 106], textColor: 255, fontSize: 8, fontStyle: 'bold', halign: 'center' },
                bodyStyles: { fontSize: 7 },
                columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 30 }, 3: { cellWidth: 45 } },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 52, left: 15, right: 15 },
                didDrawPage: function (data) { drawWatermark(); drawHeader(); }
            });

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, 290, { align: "center" });
            }

            if (returnBlob) {
                return doc.output('bloburl');
            } else {
                doc.save(`Reporte_ITD_${meta.period}_${meta.department.substring(0,10)}.pdf`);
            }
        };

        const generateExcelReport = (data, meta) => {
            if (typeof XLSX === 'undefined') { alert("La librer√≠a de Excel no se carg√≥ correctamente."); return; }
            const formattedData = data.map(row => ({ "Docente": row.nombre, "Curso Inscrito": row.curso, "Fechas del Curso": row.fechas || 'N/A', "Departamento que Ofrece": row.depto_oferente || 'N/A', "Folio": row.folio }));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(formattedData);
            const wscols = [{wch: 40}, {wch: 50}, {wch: 25}, {wch: 35}, {wch: 20}];
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, `Reporte ${meta.period}`);
            XLSX.writeFile(wb, `Reporte_ITD_${meta.period}.xlsx`);
        };

        const StatsChart = ({ type, data, title, id, horizontal = false }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);
            
            const hasData = useMemo(() => {
                if (!data) return false;
                return Object.keys(data).length > 0;
            }, [data]);

            useEffect(() => {
                if (!canvasRef.current || !hasData) return;
                if (typeof window.Chart === 'undefined') return;
                
                // Registro de Plugin para Etiquetas en Puntos
                if(window.ChartDataLabels) {
                    window.Chart.register(window.ChartDataLabels);
                }

                if (chartRef.current) chartRef.current.destroy();
                
                try {
                    const ctx = canvasRef.current.getContext('2d');
                    const isPie = type === 'pie' || type === 'doughnut';
                    const isHistory = id === 'chartHistory'; // Flag para la gr√°fica de historia
                    
                    let chartDataConfig = {};
                    let chartType = type;
                    let chartOptions = {
                        responsive: true, 
                        maintainAspectRatio: false,
                        indexAxis: horizontal ? 'y' : 'x',
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                display: isPie || isHistory,
                                labels: { font: { weight: 'bold' } }
                            },
                            datalabels: {
                                display: false // Por defecto apagado
                            }
                        },
                        scales: !isPie ? { 
                            y: { 
                                beginAtZero: true, 
                                grid: { color: '#e0e0e0' },
                                ticks: { font: { weight: 'bold' } }
                            }, 
                            x: { 
                                beginAtZero: true, 
                                grid: { display: false },
                                ticks: { autoSkip: false, font: { weight: 'bold' } }
                            } 
                        } : {}
                    };

                    // L√≥gica para Historial (L√çNEAS + PUNTOS + ETIQUETAS)
                    if (isHistory) {
                        chartType = 'line'; // Forzamos tipo l√≠nea
                        const labels = Object.keys(data).sort((a,b) => parseInt(a) - parseInt(b));
                        const regData = labels.map(year => data[year].registros);
                        const courseData = labels.map(year => data[year].cursos);
                        
                        chartDataConfig = {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Docentes Inscritos', 
                                    data: regData,
                                    borderColor: '#36A2EB', // Azul
                                    backgroundColor: '#36A2EB',
                                    tension: 0.3, // Curva suave
                                    pointRadius: 6,
                                    pointHoverRadius: 8,
                                    borderWidth: 3
                                },
                                {
                                    label: 'Cursos Ofertados',
                                    data: courseData,
                                    borderColor: '#FF6384', // Rojo
                                    backgroundColor: '#FF6384',
                                    tension: 0.3,
                                    pointRadius: 6,
                                    pointHoverRadius: 8,
                                    borderWidth: 3
                                }
                            ]
                        };

                        // Configurar datalabels SOLO para esta gr√°fica
                        chartOptions.plugins.datalabels = {
                            display: true,
                            color: '#333',
                            font: { weight: 'bold', size: 11 },
                            align: 'top',
                            offset: 4,
                            formatter: Math.round
                        };

                    } else {
                        // L√≥gica para Gr√°ficas Normales (Barras / Pastel)
                        let backgroundColors = isPie ? INSTITUTIONAL_COLORS : VIBRANT_COLORS;
                        let labels = Object.keys(data);
                        
                        // Dividir etiquetas largas en m√∫ltiples l√≠neas para cursos horizontales
                        if (horizontal && id === 'chartCourse') {
                            labels = labels.map(l => splitLabel(l));
                        }

                        let values = Object.values(data);

                        chartDataConfig = {
                            labels: labels,
                            datasets: [{
                                label: title || 'Valor',
                                data: values,
                                backgroundColor: backgroundColors,
                                borderWidth: isPie ? 2 : 0,
                                borderRadius: isPie ? 0 : 4
                            }]
                        };
                    }

                    const chartConfig = {
                        type: chartType,
                        data: chartDataConfig,
                        options: chartOptions
                    };

                    chartRef.current = new window.Chart(ctx, chartConfig);
                } catch (err) { console.error("Chart error:", err); }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, title, hasData, horizontal, id]);

            if (!hasData) return (
                <div className="bg-white p-4 rounded-xl shadow-md h-full w-full flex flex-col items-center justify-center text-gray-400 border border-gray-100 min-h-[320px]">
                    <div className="text-4xl mb-2">üìä</div><p className="text-sm font-bold">Sin datos suficientes.</p>
                </div>
            );

            return (
                <div className="bg-white p-6 rounded-xl shadow-md h-full w-full border-t-4 border-[#1B396A] flex flex-col">
                    {/* T√≠tulo condicional */}
                    {title && <h3 className="text-lg font-bold text-gray-800 mb-4 text-center flex-shrink-0">{title}</h3>}
                    <div className="flex-1 min-h-[240px] relative"><canvas ref={canvasRef} id={id}></canvas></div>
                </div>
            );
        };

        const AIAnalysisPanel = ({ statsData, period }) => {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleGenerateAnalysis = async () => {
                setLoading(true); 
                setError(null);
                
                try {
                    const cleanStats = { ...statsData, allDepartamentos: undefined };
                    // Enviamos el prompt a nuestro backend (Apps Script)
                    const promptText = `Act√∫a como analista acad√©mico. Analiza estos datos del periodo ${period}: ${JSON.stringify(cleanStats)}. Dame un resumen ejecutivo breve.`;
                    
                    // Hacemos la petici√≥n a nuestro propio Apps Script, no a Google directamente
                    const response = await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ 
                            action: 'generateAnalysis', 
                            prompt: promptText 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) throw new Error(result.message || "Error en la respuesta del servidor");
                    if (result.analysis) setAnalysis(result.analysis); 
                    else throw new Error("El servidor no devolvi√≥ an√°lisis.");
                    
                } catch (err) { 
                    console.error("AI Error:", err); 
                    let msg = err.message;
                    // Detectar error de permisos y dar instrucciones precisas
                    if(msg.includes("No cuentas con el permiso") || msg.includes("permissions") || msg.includes("Exception:")) {
                        msg = "‚ö†Ô∏è EL SCRIPT NECESITA AUTORIZACI√ìN: Ve al editor de Apps Script, ejecuta la funci√≥n 'AUTHORIZE_PERMISSIONS', acepta los permisos y crea una Nueva Implementaci√≥n (Deploy).";
                    }
                    setError(msg); 
                } finally { 
                    setLoading(false); 
                }
            };

            return (
                <div className="mt-8 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                    <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div className="flex items-center gap-2"><span className="text-2xl">‚ú®</span><h3 className="text-lg font-bold text-[#1B396A]">An√°lisis Inteligente (IA)</h3></div>
                        {!analysis && !loading && <button onClick={handleGenerateAnalysis} className="bg-[#9D2449] text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md hover:bg-[#801d3b]">‚ö° Generar An√°lisis</button>}
                    </div>
                    {loading && <div className="text-[#1B396A] p-4 animate-pulse font-bold">Analizando datos con IA... Esto puede tomar unos segundos.</div>}
                    {error && <div className="text-red-600 p-3 text-sm bg-red-50 rounded border border-red-200 font-bold">{error}</div>}
                    {analysis && <div className="bg-gray-50 p-6 rounded-lg border-l-4 border-[#D4AF37] markdown-body text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }} />}
                </div>
            );
        };

        const PdfPreviewModal = ({ isOpen, onClose, pdfUrl, onDownload }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col animate-fadeIn">
                        <div className="flex justify-between items-center p-4 border-b border-gray-200">
                            <h3 className="text-xl font-bold text-[#1B396A]">Vista Previa del Reporte</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-red-500 text-2xl font-bold">&times;</button>
                        </div>
                        <div className="flex-1 bg-gray-100 p-1 overflow-hidden">
                            {pdfUrl ? (
                                <iframe src={pdfUrl} className="w-full h-full border-0 rounded" title="Vista Previa PDF"></iframe>
                            ) : (
                                <div className="flex justify-center items-center h-full">
                                    <div className="animate-spin h-10 w-10 border-4 border-[#1B396A] rounded-full border-t-transparent"></div>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t border-gray-200 flex justify-end gap-3 bg-gray-50 rounded-b-xl">
                            <button onClick={onClose} className="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-bold hover:bg-gray-300">Cerrar</button>
                            <button onClick={onDownload} className="px-6 py-2 bg-[#1B396A] text-white rounded-lg font-bold hover:bg-[#152d54] shadow-lg">üñ®Ô∏è Imprimir / Descargar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportModal = ({ isOpen, onClose, departments, period, onGeneratePdf, onGenerateExcel }) => {
            const [selectedDept, setSelectedDept] = useState('TODOS');
            const [loading, setLoading] = useState(false);
            const [pdfPreviewUrl, setPdfPreviewUrl] = useState(null);
            const [showPreview, setShowPreview] = useState(false);

            useEffect(() => {
                if (isOpen) { setShowPreview(false); setPdfPreviewUrl(null); }
            }, [isOpen]);

            if(!isOpen) return null;

            const handlePreviewPdf = async () => {
                setLoading(true);
                try {
                    const url = await onGeneratePdf(selectedDept, true); 
                    setPdfPreviewUrl(url);
                    setShowPreview(true);
                } catch (e) {
                    console.error(e);
                    alert("Error al generar vista previa.");
                } finally {
                    setLoading(false);
                }
            };

            const handleDownloadPdf = async () => {
                 await onGeneratePdf(selectedDept, false); 
                 onClose();
            };

            const handleExcel = async () => {
                setLoading(true);
                await onGenerateExcel(selectedDept);
                setLoading(false);
                onClose();
            };

            if (showPreview) {
                return <PdfPreviewModal isOpen={true} onClose={() => setShowPreview(false)} pdfUrl={pdfPreviewUrl} onDownload={handleDownloadPdf} />;
            }

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full animate-fadeIn border-t-4 border-[#1B396A]">
                        <h3 className="text-xl font-bold text-[#1B396A] mb-2">Generar Reporte</h3>
                        <p className="text-sm text-gray-600 mb-6">Periodo: <strong>{period}</strong>.</p>
                        <label className="block text-sm font-bold text-gray-700 mb-2">Filtrar por Departamento:</label>
                        <select value={selectedDept} onChange={(e) => setSelectedDept(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 mb-8 bg-gray-50 font-semibold">
                            <option value="TODOS">-- TODOS LOS DEPARTAMENTOS --</option>
                            {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>
                        <div className="grid grid-cols-1 gap-3">
                            <button onClick={handlePreviewPdf} disabled={loading} className="bg-[#1B396A] hover:bg-[#152d54] text-white px-4 py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2">
                                {loading ? '‚è≥ Generando...' : 'üëÅÔ∏è Vista Previa PDF'}
                            </button>
                            <button onClick={handleExcel} disabled={loading} className="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold shadow-lg flex items-center justify-center gap-2">
                                {loading ? '‚è≥' : 'üìä'} Descargar Excel
                            </button>
                            <button onClick={onClose} disabled={loading} className="mt-2 bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-bold hover:bg-gray-200">Cancelar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showReportModal, setShowReportModal] = useState(false);
            const [period, setPeriod] = useState('ACTUAL');
            const [availableYears, setAvailableYears] = useState([]);

            useEffect(() => {
                setLoading(true);
                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`)
                    .then(r => r.json())
                    .then(res => { if(res.success) { setStats(res.data); if(res.availableYears) setAvailableYears(res.availableYears); } })
                    .finally(() => setLoading(false));
            }, [period]);

            const getReportData = async (dept) => {
                try {
                    const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getReportData&period=${period}&department=${encodeURIComponent(dept)}`);
                    const json = await response.json();
                    if(json.success) return json; else throw new Error(json.message);
                } catch(e) { alert("Error obteniendo datos: " + e.toString()); return null; }
            };

            const handlePdf = async (dept, returnBlob = false) => { 
                const res = await getReportData(dept); 
                if(res) {
                    return await generatePDFReport(res.data, res.meta, returnBlob);
                }
            };
            
            const handleExcel = async (dept) => { const res = await getReportData(dept); if(res) generateExcelReport(res.data, res.meta); };

            // Datos procesados para departamentos con siglas
            const processedDepts = useMemo(() => {
                if (!stats?.topDepartamentos) return { chartData: {}, legend: [] };
                const chartData = {};
                const legend = [];
                
                stats.topDepartamentos.forEach(([name, count]) => {
                    const acronym = getAcronym(name);
                    chartData[acronym] = count;
                    legend.push({ acronym, name });
                });
                return { chartData, legend };
            }, [stats]);

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#1B396A] gap-4">
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-[#1B396A]">Dashboard de Resultados</h2>
                            <p className="text-sm text-gray-500 font-bold">Usuario: <span className="font-extrabold text-gray-700">{user.name}</span></p>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <span className="text-sm font-bold text-gray-700">Periodo:</span>
                            <select value={period} onChange={(e) => setPeriod(e.target.value)} className="bg-white border border-gray-300 text-gray-700 text-sm rounded-md font-bold block p-1.5" disabled={loading}>
                                <option value="ACTUAL">üü¢ Periodo Actual</option>
                                {availableYears.map(year => <option key={year} value={year}>üìÖ Hist√≥rico {year}</option>)}
                            </select>
                        </div>
                        <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm font-bold text-gray-700 border border-gray-300">Cerrar Sesi√≥n</button>
                    </div>

                    {loading ? <div className="flex justify-center p-20"><div className="animate-spin h-12 w-12 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div> : !stats ? <div className="text-center p-10 font-bold">Error de carga.</div> : (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#1B396A]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üìù</div>
                                        <div><div className="text-2xl font-bold text-gray-800">{stats.totalInscripciones}</div><div className="text-[10px] font-bold text-gray-500 uppercase">Inscripciones Totales</div></div>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#D4AF37]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üë©‚Äçüè´</div>
                                        <div><div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.actualizados}</div><div className="text-[10px] font-bold text-gray-500 uppercase">Docentes √önicos</div></div>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#9D2449]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üîÅ</div>
                                        <div><div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.recurrentes}</div><div className="text-[10px] font-bold text-gray-500 uppercase">Docentes Recurrentes</div></div>
                                    </div>
                                </div>
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-gray-500">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üéØ</div>
                                        <div><div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.porcentaje}%</div><div className="text-[10px] font-bold text-gray-500 uppercase">Cobertura Estimada</div></div>
                                    </div>
                                </div>
                            </div>

                            <AIAnalysisPanel statsData={stats} period={period} />

                            {/* FILA 1: CURSOS (Izq) y G√âNERO (Der) */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 my-8">
                                {/* IZQUIERDA: Cursos M√°s Demandados (Barras horizontales) */}
                                <div className="lg:col-span-7 h-full">
                                    <StatsChart type="bar" data={Object.fromEntries(stats.topCursos||[])} title="Cursos M√°s Demandados" id="chartCourse" horizontal={true} />
                                </div>

                                {/* DERECHA: Distribuci√≥n por G√©nero */}
                                <div className="lg:col-span-5 h-full">
                                    <StatsChart type="doughnut" data={stats.distribucionGenero} title="Distribuci√≥n por G√©nero" id="chartGen" />
                                </div>
                            </div>

                            {/* FILA 2: DEPARTAMENTOS (Izq) y TIPO DE CURSO (Der) */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
                                {/* IZQUIERDA: Top Departamentos (Horizontal ahora para siglas) */}
                                <div className="lg:col-span-9 h-full flex flex-col bg-white rounded-xl shadow-md border-t-4 border-[#1B396A]">
                                    <div className="p-6 flex-1">
                                        <div className="h-64">
                                            {/* TITULO A√ëADIDO AQUI */}
                                            <StatsChart type="bar" data={processedDepts.chartData} title="Top 5 Departamentos" id="chartDept" horizontal={true} />
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-4 border-t border-gray-200 rounded-b-xl">
                                        <p className="text-xs font-bold text-gray-500 mb-2 uppercase">Leyenda de Departamentos:</p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs text-gray-600 max-h-32 overflow-y-auto custom-scrollbar">
                                            {processedDepts.legend.map((item, idx) => (
                                                <div key={idx} className="flex items-start gap-2">
                                                    <span className="font-bold text-[#1B396A] min-w-[35px]">{item.acronym}:</span>
                                                    <span className="truncate font-bold" title={item.name}>{item.name}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* DERECHA: Tipo de Curso (CAMBIADO A VERTICAL) */}
                                <div className="lg:col-span-3 h-full">
                                    <StatsChart type="bar" data={stats.distribucionTipo} title="Tipo de Curso" id="chartType" horizontal={false} />
                                </div>
                            </div>

                            {/* SECCI√ìN DE TENDENCIA HIST√ìRICA (L√çNEA + PUNTOS + ETIQUETAS) */}
                            <div className="mb-8">
                                <StatsChart type="line" data={stats.historicalTrend || {}} title="Evoluci√≥n de Inscripciones y Oferta por A√±o" id="chartHistory" horizontal={false} />
                            </div>

                            <div className="bg-[#1B396A] rounded-xl p-8 text-center text-white shadow-lg mb-12 relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-4xl mb-4">üìÑ</div>
                                    <h3 className="text-2xl font-bold mb-2">Reporte Ejecutivo</h3>
                                    <p className="mb-6 opacity-90 text-sm font-bold">Generar reporte detallado de participantes del periodo <strong>{period}</strong>.</p>
                                    <button onClick={() => setShowReportModal(true)} className="bg-white text-[#1B396A] px-8 py-3 rounded-full font-bold shadow-md hover:bg-gray-100 transition-transform transform hover:scale-105">üìÑ Generar Reporte</button>
                                </div>
                            </div>

                            <ReportModal isOpen={showReportModal} onClose={() => setShowReportModal(false)} departments={stats.allDepartamentos || []} period={period} onGeneratePdf={handlePdf} onGenerateExcel={handleExcel} />
                        </>
                    )}
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const ref = useRef(null);
            useEffect(() => {
                if(window.google?.accounts) {
                    window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin });
                    window.google.accounts.id.renderButton(ref.current, { theme: "outline", size: "large", text: "signin_with" });
                }
            }, [onLogin]);
            return (
                <div className="flex justify-center items-center py-20 animate-fadeIn">
                    <div className="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 p-10 rounded-xl shadow-lg text-center max-w-md w-full border-t-4 border-[#9D2449]">
                        <h2 className="text-2xl font-bold text-[#9D2449] mb-4">Acceso Restringido</h2>
                        <p className="text-gray-600 mb-8 font-bold">Inicie sesi√≥n con su cuenta institucional.</p>
                        <div className="flex justify-center" ref={ref}></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const handleLogin = (res) => { const p = JSON.parse(atob(res.credential.split('.')[1])); setUser({ name: p.name, email: p.email }); };
            return user ? <Dashboard user={user} onLogout={() => setUser(null)} /> : <Login onLogin={handleLogin} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        document.addEventListener('DOMContentLoaded', () => document.getElementById('copyright-year').textContent = new Date().getFullYear());
    </script>
</body>
</html>
