<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- Import Map para Google GenAI (Permite importar la librer√≠a moderna) -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
    </script>

    <!-- React y Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <!-- SHIM: Simulaci√≥n de process.env para que el SDK de Google funcione en navegador -->
    <script>
        window.process = {
            env: {
                // ‚ö†Ô∏è IMPORTANTE: Reemplaza esto con tu API KEY real de Google AI Studio
                API_KEY: 'TU_API_KEY_DE_GOOGLE_AQUI' 
            }
        };
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        /* Estilos para el Markdown generado por la IA */
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1e3a8a; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e40af; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body strong { color: #334155; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-blue-900 leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-blue-700 mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 sm:py-8 mt-12">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>

    <script type="text/babel">
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useRef = React.useRef;
        const useMemo = React.useMemo;

        // CONFIGURACI√ìN
        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', // Tu Client ID
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec', // Tu Script URL
            ALLOWED_DOMAIN: 'itdurango.edu.mx'
        };

        // ==========================================
        // COMPONENTE: GR√ÅFICA (Chart.js Wrapper)
        // ==========================================
        const StatsChart = ({ type, data, title, id }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            const hasData = useMemo(() => {
                return data && Object.keys(data).length > 0 && Object.values(data).some(val => val > 0);
            }, [data]);

            useEffect(() => {
                if (!canvasRef.current || !hasData) return;
                
                // Asegurarse que Chart.js est√© cargado
                if (typeof window.Chart === 'undefined') {
                    console.error("Chart.js no est√° cargado");
                    return;
                }

                // Destruir gr√°fica previa si existe
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                
                const colors = [
                    'rgba(59, 130, 246, 0.7)', // Azul
                    'rgba(236, 72, 153, 0.7)', // Rosa
                    'rgba(245, 158, 11, 0.7)', // Ambar
                    'rgba(16, 185, 129, 0.7)', // Verde
                    'rgba(139, 92, 246, 0.7)', // Violeta
                ];

                // Para gr√°ficas de barra, usamos un solo color principal, para pie/doughnut usamos varios
                const bgColors = (type === 'pie' || type === 'doughnut') ? colors : colors[0];
                const borderColors = (type === 'pie' || type === 'doughnut') ? colors.map(c => c.replace('0.7', '1')) : colors[0].replace('0.7', '1');

                chartRef.current = new window.Chart(ctx, {
                    type: type,
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: title,
                            data: Object.values(data),
                            backgroundColor: bgColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                display: type !== 'bar'
                            },
                            title: {
                                display: true,
                                text: title
                            }
                        },
                        scales: type === 'bar' ? {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0 // Solo n√∫meros enteros
                                }
                            }
                        } : {}
                    }
                });

                return () => {
                    if (chartRef.current) chartRef.current.destroy();
                };
            }, [data, type, title, hasData]);

            if (!hasData) {
                return (
                    <div className="bg-white p-4 rounded-xl shadow-md h-80 w-full flex flex-col items-center justify-center text-gray-400">
                        <span className="text-4xl mb-2">üìä</span>
                        <p className="text-sm">Sin datos suficientes para mostrar.</p>
                    </div>
                );
            }

            return (
                <div className="bg-white p-4 rounded-xl shadow-md h-80 w-full">
                    <canvas ref={canvasRef} id={id}></canvas>
                </div>
            );
        };

        // ==========================================
        // COMPONENTE: AN√ÅLISIS IA (Gemini)
        // ==========================================
        const AIAnalysisPanel = ({ statsData }) => {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleGenerateAnalysis = async () => {
                setLoading(true);
                setError(null);
                try {
                    // Importaci√≥n Din√°mica para evitar errores de carga inicial
                    const { GoogleGenAI } = await import("@google/genai");
                    
                    if (!window.process?.env?.API_KEY || window.process.env.API_KEY === 'TU_API_KEY_DE_GOOGLE_AQUI') {
                        throw new Error("Falta configurar la API Key en el c√≥digo HTML.");
                    }

                    const ai = new GoogleGenAI({ apiKey: window.process.env.API_KEY });
                    
                    // Preparar el prompt con los datos
                    const prompt = `
                        Act√∫a como un experto analista de datos acad√©micos del Tecnol√≥gico Nacional de M√©xico.
                        Analiza los siguientes datos JSON de inscripciones a cursos de actualizaci√≥n docente:
                        ${JSON.stringify(statsData)}

                        Genera un reporte ejecutivo breve (m√°ximo 200 palabras) en formato Markdown que incluya:
                        1. Un resumen general de la participaci√≥n.
                        2. Hallazgos clave (ej. departamentos con baja participaci√≥n, g√©nero predominante).
                        3. Una recomendaci√≥n estrat√©gica para mejorar la cobertura docente.
                        
                        Usa un tono profesional, institucional y motivador.
                    `;

                    const response = await ai.models.generateContent({
                        model: 'gemini-2.5-flash',
                        contents: prompt,
                    });

                    setAnalysis(response.text);
                } catch (err) {
                    console.error(err);
                    setError("No se pudo generar el an√°lisis. Verifique la API Key o la conexi√≥n. Detalle: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="mt-8 bg-gradient-to-r from-violet-100 to-fuchsia-50 border border-violet-200 rounded-xl p-6 shadow-sm">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">‚ú®</span>
                            <h3 className="text-lg font-bold text-violet-900">An√°lisis Inteligente (IA)</h3>
                        </div>
                        {!analysis && !loading && (
                            <button 
                                onClick={handleGenerateAnalysis}
                                className="bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2 shadow-md"
                            >
                                ‚ö° Generar An√°lisis
                            </button>
                        )}
                    </div>

                    {loading && (
                        <div className="flex items-center justify-center py-8 text-violet-700">
                            <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-violet-700 mr-3"></div>
                            Analizando datos hist√≥ricos y tendencias...
                        </div>
                    )}

                    {error && (
                        <div className="text-red-600 text-sm bg-red-50 p-3 rounded border border-red-200">
                            {error}
                        </div>
                    )}

                    {analysis && (
                        <div className="animate-fadeIn bg-white p-6 rounded-lg border border-violet-100 shadow-inner">
                            <div 
                                className="markdown-body text-sm text-gray-800"
                                dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }}
                            />
                            <p className="text-xs text-gray-400 mt-4 text-right italic">Generado por Google Gemini 2.5 Flash</p>
                        </div>
                    )}
                    
                    {!analysis && !loading && (
                        <p className="text-sm text-violet-700 italic opacity-80">
                            Genera insights y res√∫menes ejecutivos con Inteligencia Artificial.
                        </p>
                    )}
                </div>
            );
        };

        // ==========================================
        // COMPONENTE: MODAL DE REPORTE PDF
        // ==========================================
        const ReportModal = ({ isOpen, onClose, departments, onGenerate, isGenerating }) => {
            const [selectedDept, setSelectedDept] = useState('TODOS');

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
                        <h3 className="text-xl font-bold text-gray-800 mb-4">Generar Reporte PDF</h3>
                        <p className="text-gray-600 text-sm mb-4">
                            Seleccione el departamento para filtrar el reporte, o elija "TODOS" para un reporte general.
                            El PDF se enviar√° a su correo electr√≥nico.
                        </p>
                        
                        <label className="block text-sm font-medium text-gray-700 mb-2">Filtrar por Departamento:</label>
                        <select 
                            className="w-full border border-gray-300 rounded-lg p-2 mb-6 text-sm focus:ring-2 focus:ring-blue-500"
                            value={selectedDept}
                            onChange={(e) => setSelectedDept(e.target.value)}
                        >
                            <option value="TODOS">-- TODOS LOS DEPARTAMENTOS --</option>
                            {departments.map(dept => (
                                <option key={dept} value={dept}>{dept}</option>
                            ))}
                        </select>

                        <div className="flex justify-end gap-3">
                            <button 
                                onClick={onClose}
                                className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-semibold"
                                disabled={isGenerating}
                            >
                                Cancelar
                            </button>
                            <button 
                                onClick={() => onGenerate(selectedDept)}
                                className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold flex items-center gap-2"
                                disabled={isGenerating}
                            >
                                {isGenerating ? 'Generando...' : 'üìÑ Enviar Reporte'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // PANTALLA DE LOGIN
        // ==========================================
        const LoginScreen = ({ onLogin, error }) => {
            const googleButtonRef = useRef(null);

            useEffect(() => {
                if (window.google && window.google.accounts) {
                    window.google.accounts.id.initialize({
                        client_id: CONFIG.GOOGLE_CLIENT_ID,
                        callback: onLogin
                    });
                    window.google.accounts.id.renderButton(
                        googleButtonRef.current, 
                        { theme: "outline", size: "large", width: "250" }
                    );
                }
            }, [onLogin]);

            return (
                <div className="flex flex-col items-center justify-center py-12 px-4 animate-fadeIn">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center border-t-4 border-blue-600">
                        <div className="text-6xl mb-4">üìä</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Acceso a Estad√≠sticas</h2>
                        <p className="text-gray-600 mb-6 text-sm">
                            Este panel es exclusivo para jefes de departamento y directivos. Inicie sesi√≥n con su cuenta institucional.
                        </p>
                        
                        <div className="mb-6 text-left text-xs bg-blue-50 p-3 rounded text-blue-800 border border-blue-100">
                            <a href="index.html" className="flex items-center gap-1 font-bold hover:underline">
                                <span>‚Üê</span> Volver al Portal Principal
                            </a>
                        </div>
                        
                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-6 border border-red-200">
                                {error}
                            </div>
                        )}

                        <div className="flex justify-center" ref={googleButtonRef}></div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // COMPONENTE PRINCIPAL: DASHBOARD
        // ==========================================
        const Dashboard = ({ user, onLogout }) => {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [reportModalOpen, setReportModalOpen] = useState(false);
            const [generatingReport, setGeneratingReport] = useState(false);

            useEffect(() => {
                fetchStats();
            }, []);

            const fetchStats = async () => {
                try {
                    const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData`);
                    const result = await response.json();
                    if (result.success) {
                        setStats(result.data);
                    } else {
                        console.error(result.message);
                    }
                } catch (error) {
                    console.error("Error fetching stats:", error);
                } finally {
                    setLoading(false);
                }
            };

            const handleGenerateReport = async (dept) => {
                setGeneratingReport(true);
                try {
                    await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Google Apps Script limitation fix
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'generateStatsReport',
                            id_token: user.token,
                            department: dept
                        })
                    });
                    alert(`Solicitud enviada. El reporte de ${dept} llegar√° a su correo en breve.`);
                    setReportModalOpen(false);
                } catch (error) {
                    alert("Error al solicitar reporte: " + error.message);
                } finally {
                    setGeneratingReport(false);
                }
            };

            if (loading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[50vh]">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
                        <p className="text-gray-600 font-semibold">Cargando datos en tiempo real...</p>
                    </div>
                );
            }

            if (!stats) return <div className="text-center p-10">No hay datos disponibles.</div>;

            // Preparamos los datos de forma memorizada para evitar re-renderizados
            const topDeptosData = useMemo(() => Object.fromEntries(stats.topDepartamentos || []), [stats]);
            const topCursosData = useMemo(() => Object.fromEntries(stats.topCursos || []), [stats]);

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl animate-fadeIn">
                    
                    {/* Bot√≥n Volver */}
                    <div className="mb-6">
                        <a href="index.html" className="inline-flex items-center px-4 py-2 bg-white text-blue-600 font-semibold rounded-lg shadow-sm hover:bg-gray-50 transition-colors border border-gray-200">
                            ‚Üê Volver al Portal Principal
                        </a>
                    </div>

                    {/* Barra Superior */}
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-8 flex flex-col sm:flex-row justify-between items-center border-l-4 border-blue-600">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">Dashboard de Resultados</h2>
                            <p className="text-sm text-gray-600">Hola, <span className="font-semibold text-blue-800">{user.name}</span>.</p>
                        </div>
                        <button onClick={onLogout} className="mt-4 sm:mt-0 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold transition-colors">
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    {/* Tarjetas KPI */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 flex items-center">
                            <div className="text-4xl mr-4">üìù</div>
                            <div>
                                <p className="text-3xl font-bold text-gray-800">{stats.totalInscripciones}</p>
                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wider">Inscripciones Activas</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500 flex items-center">
                            <div className="text-4xl mr-4">üë©‚Äçüè´</div>
                            <div>
                                <p className="text-3xl font-bold text-gray-800">{stats.coberturaDocente.actualizados}</p>
                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wider">Docentes Participantes</p>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500 flex items-center">
                            <div className="text-4xl mr-4">üéØ</div>
                            <div>
                                <p className="text-3xl font-bold text-gray-800">{stats.coberturaDocente.porcentaje}%</p>
                                <p className="text-xs text-gray-500 uppercase font-bold tracking-wider">% Cobertura Estimada</p>
                            </div>
                        </div>
                    </div>

                    {/* Panel IA */}
                    <AIAnalysisPanel statsData={stats} />

                    <div className="h-8"></div>

                    {/* Gr√°ficas */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 className="text-center font-bold text-gray-700 mb-4">Distribuci√≥n por G√©nero</h3>
                            <StatsChart type="doughnut" data={stats.distribucionGenero} title="Participaci√≥n por G√©nero" id="chartGeneros" />
                        </div>
                        <div>
                            <h3 className="text-center font-bold text-gray-700 mb-4">Tipo de Curso</h3>
                            <StatsChart type="bar" data={stats.distribucionTipo} title="Tipo de Curso" id="chartTipo" />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div>
                            <h3 className="text-center font-bold text-gray-700 mb-4">Top 5 Departamentos</h3>
                            <StatsChart type="bar" data={topDeptosData} title="Participaci√≥n por Depto" id="chartDeptos" />
                        </div>
                        <div>
                            <h3 className="text-center font-bold text-gray-700 mb-4">Cursos M√°s Demandados</h3>
                            <StatsChart type="bar" data={topCursosData} title="Inscritos por Curso" id="chartCursos" />
                        </div>
                    </div>

                    {/* Bot√≥n Generar Reporte */}
                    <div className="bg-blue-600 rounded-xl shadow-lg p-8 text-center text-white">
                        <div className="text-5xl mb-4">üìÑ</div>
                        <h3 className="text-2xl font-bold mb-2">Reporte Ejecutivo</h3>
                        <p className="opacity-90 mb-6 max-w-2xl mx-auto">
                            Genere un reporte PDF detallado con la lista de participantes y estad√≠sticas clave, 
                            filtrado por departamento. El documento se enviar√° a su correo: 
                            <strong> {user.email}</strong>
                        </p>
                        <button 
                            onClick={() => setReportModalOpen(true)}
                            className="bg-white text-blue-700 font-bold py-3 px-8 rounded-full hover:bg-blue-50 transition-all transform hover:scale-105 shadow-md flex items-center justify-center gap-2 mx-auto"
                        >
                            <span>‚ú® Seleccionar y Generar Reporte</span>
                        </button>
                    </div>
                    
                    <div className="mt-8 text-center">
                         <a href="index.html" className="text-blue-600 hover:underline">‚Üê Volver al Portal Principal</a>
                    </div>

                    <ReportModal 
                        isOpen={reportModalOpen} 
                        onClose={() => setReportModalOpen(false)}
                        departments={stats.allDepartamentos || []}
                        onGenerate={handleGenerateReport}
                        isGenerating={generatingReport}
                    />
                </div>
            );
        };

        // ==========================================
        // APP CONTAINER
        // ==========================================
        const App = () => {
            const [user, setUser] = useState(null);
            const [loginError, setLoginError] = useState(null);

            const handleLogin = (response) => {
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    setUser({
                        name: payload.name,
                        email: payload.email,
                        token: response.credential
                    });
                } catch (e) {
                    setLoginError("Error al iniciar sesi√≥n. Intente nuevamente.");
                }
            };

            const handleLogout = () => {
                if (window.google) window.google.accounts.id.disableAutoSelect();
                setUser(null);
            };

            return user ? <Dashboard user={user} onLogout={handleLogout} /> : <LoginScreen onLogin={handleLogin} error={loginError} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>
