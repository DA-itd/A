<change>
<file>estadisticas.html</file>
<description>Frontend actualizado: Funci√≥n getChartHeight para altura din√°mica de gr√°ficas, abreviaturas 'D.' en etiquetas y opci√≥n de mostrar todos los datos sin cortes.</description>
<content><![CDATA[
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
code
Code
<link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">

<!-- React y Babel -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind CSS y Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- PDF y Captura -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Google Sign-In -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
    .pdf-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .pdf-modal { background: white; padding: 40px 60px; border-radius: 16px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.3); max-width: 400px; }
    .pdf-spinner { width: 60px; height: 60px; border: 5px solid #e5e7eb; border-top-color: #1B396A; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .preview-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; z-index: 10000; }
    .preview-header { background: #1B396A; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
    .preview-body { flex: 1; overflow: auto; padding: 20px; display: flex; justify-content: center; background: #525659; }
    .preview-body iframe { background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.5); max-width: 100%; }
</style>
</head>
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen text-gray-800 flex flex-col">
code
Code
<header id="web-header" class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
    <div class="container mx-auto px-4 py-4 sm:py-6 flex items-center justify-between gap-4">
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
        <div class="text-center flex-1 px-2 sm:px-4">
            <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
            <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
        </div>
        <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
    </div>
</header>

<div id="back-link" class="container mx-auto px-4 py-4">
    <a href="index.html" class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-bold transition-colors">‚Üê Volver al Portal Principal</a>
</div>

<div id="root" class="flex-grow flex flex-col"><div class="flex justify-center items-center h-64 flex-grow"><div class="animate-spin h-12 w-12 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div></div>

<footer id="web-footer" class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
    <div class="container mx-auto px-4">
         <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
         <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
         <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
    </div>
</footer>

<script>document.addEventListener('DOMContentLoaded', function() { var yearEl = document.getElementById('copyright-year'); if (yearEl) yearEl.textContent = new Date().getFullYear(); });</script>

<script type="text/babel">
    const React = window.React; const ReactDOM = window.ReactDOM;
    const CONFIG = { GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec' };
    const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
    const VIBRANT_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8AC926', '#1982C4', '#E91E63', '#009688'];
    
    const shortenLabel = (label) => {
        if (!label) return '';
        return label.replace(/DEPARTAMENTO DE /g, 'D. ').replace(/DIVISION DE ESTUDIOS DE /g, 'Div. ').replace(/DIVISION DE /g, 'Div. ').replace(/CENTRO DE INFORMACI√ìN/g, 'C. Informaci√≥n').replace(/CENTRO DE /g, 'C. ').replace(/INGENIER√çA/g, 'Ing.').replace(/CIENCIAS/g, 'Ciencias').replace(/ECONOMICO-ADMINISTRATIVAS/g, 'Eco-Admin');
    };
    
    const getChartHeight = (count) => Math.max(400, count * 28) + "px";

    const Login = ({ onLogin, loginError }) => {
        const googleButtonRef = React.useRef(null);
        React.useEffect(() => {
            const initGoogle = () => {
                if (window.google && window.google.accounts && googleButtonRef.current) {
                    try { window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin }); window.google.accounts.id.renderButton(googleButtonRef.current, { theme: "outline", size: "large", text: "signin_with" }); return true; } catch (e) { return false; }
                } return false;
            };
            if (!initGoogle()) { let intervalId = setInterval(() => { if (initGoogle()) clearInterval(intervalId); }, 500); }
        }, [onLogin]);
        return (<div className="flex flex-col justify-center items-center py-20 animate-fadeIn px-4 flex-grow"><div className="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full border-t-8 border-[#9D2449]"><div className="text-5xl mb-6">üîí</div><h2 className="text-3xl font-bold text-[#1B396A] mb-2">Acceso Restringido</h2><p className="text-gray-500 mb-8 text-sm font-medium uppercase tracking-wide">Estad√≠sticas Institucionales</p>{loginError && <div className="mb-6 bg-red-100 text-red-700 px-4 py-3 rounded font-bold">{loginError}</div>}<div className="flex justify-center" ref={googleButtonRef}></div></div></div>);
    };

    const Dashboard = ({ user, onLogout }) => {
        const [stats, setStats] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [period, setPeriod] = React.useState('ACTUAL');
        const [availableYears, setAvailableYears] = React.useState([]);
        const [pdfState, setPdfState] = React.useState({ generating: false, preview: null, blob: null });

        React.useEffect(() => {
            let isMounted = true; setLoading(true); setError(null);
            fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`).then(r => { if(!r.ok) throw new Error(`Error HTTP: ${r.status}`); return r.json(); }).then(res => { if (!isMounted) return; if (res.success) { setStats(res.data); if (res.availableYears) setAvailableYears(res.availableYears); } else throw new Error(res.message || "Error"); }).catch(err => { if (isMounted) setError(err.message); }).finally(() => { if (isMounted) setLoading(false); });
            return () => { isMounted = false; };
        }, [period]);

        const captureElement = async (id) => { const el = document.getElementById(id); if (!el) return null; try { const c = await html2canvas(el, { scale: 2, backgroundColor: '#fff' }); return c.toDataURL('image/png'); } catch (e) { return null; } };
        const generatePDF = async () => {
            setPdfState({ generating: true, preview: null, blob: null });
            try {
                const { jsPDF } = window.jspdf; const pdf = new jsPDF('p', 'mm', 'letter'); const W = pdf.internal.pageSize.getWidth(); const H = pdf.internal.pageSize.getHeight(); const M = 10;
                pdf.setFillColor(27, 57, 106); pdf.rect(0, 0, W, 20, 'F');
                pdf.setFontSize(15); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(255, 255, 255); pdf.text('INSTITUTO TECNOLOGICO DE DURANGO', W/2, 9, { align: 'center' });
                pdf.setFontSize(10); pdf.setFont('helvetica', 'normal'); pdf.text('Reporte Estadistico - Actualizacion Docente', W/2, 15, { align: 'center' });
                
                let y = 30;
                pdf.setTextColor(0); pdf.setFontSize(11); pdf.text(`Periodo: ${period}`, M, y); 
                pdf.setFontSize(9); pdf.setTextColor(100); pdf.text(`Generado: ${new Date().toLocaleDateString()}`, W-M, y, { align: 'right' });
                y += 10;

                // KPIs
                const kpis = [{v:stats.totalInscripciones,l:'Inscritos'},{v:stats.coberturaDocente.actualizados,l:'Unicos'},{v:stats.coberturaDocente.recurrentes,l:'Recurrentes'},{v:stats.coberturaDocente.porcentaje+'%',l:'Cobertura'}];
                const kw = (W - (M*2) - 15) / 4;
                kpis.forEach((k, i) => {
                    const x = M + (i * (kw + 5));
                    pdf.setFillColor(245,245,245); pdf.roundedRect(x, y, kw, 15, 2, 2, 'F');
                    pdf.setFontSize(12); pdf.setTextColor(0); pdf.text(String(k.v), x + kw/2, y+6, {align:'center'});
                    pdf.setFontSize(7); pdf.setTextColor(100); pdf.text(k.l, x + kw/2, y+11, {align:'center'});
                });
                y += 25;

                const [imgC, imgG, imgD, imgT, imgH] = await Promise.all(['chartBox-chartCourses','chartBox-chartGender','chartBox-chartDepts','chartBox-chartType','chartBox-chartHistory'].map(id=>captureElement(id)));
                
                if (imgC) pdf.addImage(imgC, 'PNG', M, y, W*0.7, 60);
                if (imgG) pdf.addImage(imgG, 'PNG', M + (W*0.72), y+5, W*0.2, 50);
                y += 65;
                if (imgD) pdf.addImage(imgD, 'PNG', M, y, W*0.65, 65);
                if (imgT) pdf.addImage(imgT, 'PNG', M + (W*0.67), y, W*0.28, 65);
                y += 70;
                if (imgH) pdf.addImage(imgH, 'PNG', M, y, W-(M*2), 50);

                const blob = pdf.output('blob');
                setPdfState({ generating: false, preview: URL.createObjectURL(blob), blob: blob, filename: `Reporte_${period}.pdf` });
            } catch (e) { alert('Error PDF'); setPdfState({ generating: false, preview: null, blob: null }); }
        };

        if (loading && !stats) return <div className="flex justify-center items-center h-96 flex-grow"><div className="animate-spin h-16 w-16 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div>;
        if (error) return <div className="text-center py-20 text-red-600 font-bold">Error: {error} <br/><button onClick={()=>window.location.reload()} className="underline">Recargar</button></div>;
        if (!stats) return null;

        return (
            <div className="container mx-auto px-4 py-6 max-w-7xl animate-fadeIn flex-grow">
                {pdfState.generating && <div className="pdf-overlay"><div className="pdf-modal"><div className="pdf-spinner"></div><p>Generando PDF...</p></div></div>}
                {pdfState.preview && <div className="preview-overlay"><div className="preview-header"><h3>Vista Previa</h3><div><button onClick={()=>{const l=document.createElement('a');l.href=URL.createObjectURL(pdfState.blob);l.download=pdfState.filename;l.click();}} className="bg-green-500 text-white px-4 py-2 rounded mr-2">Descargar</button><button onClick={()=>{URL.revokeObjectURL(pdfState.preview);setPdfState({generating:false,preview:null,blob:null});}} className="bg-gray-500 text-white px-4 py-2 rounded">Cerrar</button></div></div><div className="preview-body"><iframe src={pdfState.preview} style={{width:'100%',height:'100%'}}></iframe></div></div>}
                
                <div className="bg-white rounded-xl shadow p-4 mb-6 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#9D2449] gap-4">
                    <div className="flex-1"><h2 className="text-xl font-bold text-[#1B396A]">Dashboard</h2><p className="text-sm font-bold text-gray-500">Usuario: {user.name}</p></div>
                    <div className="flex gap-3"><select value={period} onChange={(e)=>setPeriod(e.target.value)} className="border p-2 rounded"><option value="ACTUAL">Actual</option>{availableYears.filter(y=>y!=='ACTUAL').map(y=><option key={y} value={y}>{y}</option>)}</select><button onClick={generatePDF} className="bg-[#1B396A] text-white px-4 py-2 rounded font-bold">PDF</button><button onClick={onLogout} className="bg-gray-100 px-4 py-2 rounded border">Salir</button></div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    {[{i:"üìù",v:stats.totalInscripciones,l:"Inscritos"},{i:"üë©‚Äçüè´",v:stats.coberturaDocente.actualizados,l:"Docentes √önicos"},{i:"üîÅ",v:stats.coberturaDocente.recurrentes,l:"Recurrentes"},{i:"üéØ",v:`${stats.coberturaDocente.porcentaje}%`,l:"Cobertura"}].map((k,i)=>(<div key={i} className="bg-white p-4 rounded-xl shadow border-b-4 border-[#1B396A] flex gap-3"><div className="text-3xl">{k.i}</div><div><div className="text-2xl font-bold">{k.v}</div><div className="text-xs font-bold text-gray-500 uppercase">{k.l}</div></div></div>))}
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
                    <div className="lg:col-span-9"><ChartBox type="bar" data={Object.fromEntries(stats.topCursos||[])} title="üìö Cursos M√°s Demandados" id="chartCourses" horizontal={true} minHeight={getChartHeight(stats.topCursos?.length||0)} /></div>
                    <div className="lg:col-span-3"><ChartBox type="doughnut" data={stats.distribucionGenero} title="üë• G√©nero" id="chartGender" minHeight="380px" /></div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-6">
                    <div className="lg:col-span-8"><ChartBox type="bar" data={Object.fromEntries(stats.topDepartamentos||[])} title="üè¢ Participaci√≥n por Departamento" id="chartDepts" horizontal={true} shortenLabels={true} minHeight={getChartHeight(stats.topDepartamentos?.length||0)} /></div>
                    <div className="lg:col-span-4"><ChartBox type="bar" data={stats.distribucionTipo} title="üìã Tipo" id="chartType" minHeight="450px" /></div>
                </div>
                
                <div className="mb-6"><ChartBox type="line" data={stats.historicalTrend||{}} title="üìà Evoluci√≥n Hist√≥rica" id="chartHistory" minHeight="380px" /></div>
            </div>
        );
    };
    
    const ChartBox = ({ type, data, title, id, horizontal=false, shortenLabels=false, minHeight="320px" }) => {
        const chartRef = React.useRef(null); const canvasRef = React.useRef(null);
        React.useEffect(() => {
            if (!canvasRef.current || !data) return;
            if (chartRef.current) chartRef.current.destroy();
            const ctx = canvasRef.current.getContext('2d');
            const isHistory = id === 'chartHistory';
            const labels = Object.keys(data).map(l => shortenLabels ? shortenLabel(l) : l);
            
            chartRef.current = new Chart(ctx, {
                type: isHistory ? 'line' : type,
                data: {
                    labels: isHistory ? Object.keys(data).sort() : labels,
                    datasets: isHistory ? [
                        { label: 'Inscritos', data: Object.keys(data).sort().map(y=>data[y]?.registros), borderColor: '#36A2EB', backgroundColor: 'rgba(54,162,235,0.2)', fill: true },
                        { label: 'Cursos', data: Object.keys(data).sort().map(y=>data[y]?.cursos), borderColor: '#FF6384', backgroundColor: 'rgba(255,99,132,0.2)', fill: true }
                    ] : [{ label: title, data: Object.values(data), backgroundColor: VIBRANT_COLORS, borderWidth: 1 }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: horizontal ? 'y' : 'x',
                    scales: { y: { ticks: { autoSkip: false } } }, // Mostrar todos los labels
                    plugins: { datalabels: { display: true, align: horizontal?'end':'top', anchor: horizontal?'end':'end', font:{weight:'bold'}, formatter: Math.round }, legend: { display: isHistory || type==='doughnut', position: 'bottom' } },
                    layout: { padding: { right: 30, top: 20 } }
                }
            });
            return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [data, type, title, horizontal, id, shortenLabels]);

        return (<div id={`chartBox-${id}`} className="bg-white p-5 rounded-xl shadow h-full flex flex-col" style={{minHeight}}><h3 className="font-bold text-center mb-4 border-b pb-2">{title}</h3><div className="flex-1 relative"><canvas ref={canvasRef}></canvas></div></div>);
    };

    const App = () => {
        const [user, setUser] = React.useState(null);
        const handleLogin = (res) => { try { const p = JSON.parse(atob(res.credential.split('.')[1])); setUser({ name: p.name, email: p.email }); } catch (e) {} };
        return user ? <Dashboard user={user} onLogout={()=>setUser(null)} /> : <Login onLogin={handleLogin} />;
    };
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
]]></content>
</change>
