<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- React y Babel (Solo para esta p√°gina, en un entorno real esto se empaqueta) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1B396A; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #9D2449; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body strong { color: #1B396A; }
    </style>
    
    <!-- SHIM para process.env para evitar errores con librer√≠as de Node en navegador -->
    <script>
        window.process = { env: { API_KEY: 'TU_API_KEY_DE_GOOGLE_AQUI' } };
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>
    
    <div id="back-link" class="container mx-auto px-4 py-4">
        <a href="index.html" class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-semibold transition-colors">
            ‚Üê Volver al Portal Principal
        </a>
    </div>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>

    <script type="text/babel">
        // Importamos React Hooks desde el objeto global React
        const { useState, useEffect, useRef, useMemo } = React;

        // CONFIGURACI√ìN
        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec',
            GEMINI_API_KEY: 'TU_API_KEY_DE_GOOGLE_AQUI' 
        };

        // COLORES INSTITUCIONALES
        const INSTITUTIONAL_COLORS = [
            '#1B396A', // Azul ITD
            '#9D2449', // Guinda TecNM
            '#B0BEC5', // Gris Institucional Claro
            '#D4AF37', // Dorado
            '#546E7A', // Gris Azulado
            '#455A64'  // Gris Oscuro
        ];

        // COMPONENTE: GR√ÅFICA
        const StatsChart = ({ type, data, title, id }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            const hasData = useMemo(() => {
                if (!data) return false;
                // Verificaci√≥n m√°s robusta para datos num√©ricos
                return Object.keys(data).length > 0 && Object.values(data).some(val => typeof val === 'number' ? val > 0 : false);
            }, [data]);

            useEffect(() => {
                if (!canvasRef.current || !hasData) return;
                if (typeof window.Chart === 'undefined') return;

                if (chartRef.current) chartRef.current.destroy();

                try {
                    const ctx = canvasRef.current.getContext('2d');
                    const isPie = type === 'pie' || type === 'doughnut';
                    
                    // Asignaci√≥n de colores
                    let backgroundColors, borderColors;
                    
                    if (isPie) {
                        backgroundColors = INSTITUTIONAL_COLORS;
                        borderColors = '#ffffff';
                    } else {
                        // Para barras, usamos el Azul ITD como principal
                        backgroundColors = '#1B396A';
                        borderColors = '#1B396A';
                    }

                    chartRef.current = new window.Chart(ctx, {
                        type: type,
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                label: title,
                                data: Object.values(data),
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: isPie ? 2 : 0,
                                borderRadius: isPie ? 0 : 4,
                                hoverBackgroundColor: isPie ? INSTITUTIONAL_COLORS : '#9D2449' // Guinda al pasar el mouse en barras
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    position: 'bottom', 
                                    display: isPie,
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                title: { display: false }
                            },
                            scales: !isPie ? {
                                y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                                x: { grid: { display: false } }
                            } : {}
                        }
                    });
                } catch (err) { console.error("Chart error:", err); }

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, title, hasData]);

            if (!hasData) {
                return (
                    <div className="bg-white p-4 rounded-xl shadow-md h-80 w-full flex flex-col items-center justify-center text-gray-400 border border-gray-100">
                        <div className="text-4xl mb-2">üìä</div>
                        <p className="text-sm">Sin datos suficientes para mostrar.</p>
                    </div>
                );
            }

            return (
                <div className="bg-white p-6 rounded-xl shadow-md h-80 w-full border-t-4 border-[#1B396A]">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">{title}</h3>
                    <div className="h-60">
                        <canvas ref={canvasRef} id={id}></canvas>
                    </div>
                </div>
            );
        };

        // COMPONENTE: AN√ÅLISIS IA
        const AIAnalysisPanel = ({ statsData, period }) => {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleGenerateAnalysis = async () => {
                setLoading(true); setError(null);
                if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY.includes('TU_API')) {
                    setError("‚ö†Ô∏è Falta configurar la API Key de Gemini.");
                    setLoading(false); return;
                }
                try {
                    const cleanStats = { ...statsData, allDepartamentos: undefined };
                    const prompt = `Act√∫a como un analista acad√©mico experto. Analiza estos datos de capacitaci√≥n docente del periodo ${period}: ${JSON.stringify(cleanStats)}. Genera un resumen ejecutivo breve con: 1) Logros principales, 2) √Åreas de oportunidad detectadas. Usa formato Markdown simple.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) setAnalysis(text);
                    else throw new Error("No se pudo generar el an√°lisis.");

                } catch (err) { 
                    setError(err.message || "Error de conexi√≥n con IA"); 
                } finally { 
                    setLoading(false); 
                }
            };

            return (
                <div className="mt-8 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                    <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">‚ú®</span><h3 className="text-lg font-bold text-[#1B396A]">An√°lisis Inteligente (IA)</h3>
                        </div>
                        {!analysis && !loading && (
                            <button onClick={handleGenerateAnalysis} className="bg-[#9D2449] hover:bg-[#801c3a] text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition-colors flex items-center gap-2">
                                <span>‚ö°</span> Generar An√°lisis
                            </button>
                        )}
                    </div>
                    {loading && (
                        <div className="flex items-center text-[#1B396A] gap-2 animate-pulse p-4 bg-gray-50 rounded">
                            <div className="h-4 w-4 rounded-full bg-[#1B396A] animate-bounce"></div>
                            Analizando datos...
                        </div>
                    )}
                    {error && <div className="bg-red-100 text-red-700 p-3 rounded text-sm border border-red-200">{error}</div>}
                    {analysis && <div className="bg-gray-50 p-6 rounded-lg border-l-4 border-[#D4AF37] markdown-body text-sm sm:text-base" dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }} />}
                </div>
            );
        };

        // COMPONENTE: REPORT MODAL
        const ReportModal = ({ isOpen, onClose, departments, onGenerate }) => {
            const [selectedDept, setSelectedDept] = useState('TODOS');
            if(!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full animate-fadeIn border-t-4 border-[#1B396A]">
                        <h3 className="text-xl font-bold text-[#1B396A] mb-2">Generar Reporte Ejecutivo</h3>
                        <p className="text-sm text-gray-600 mb-6">Seleccione el departamento para filtrar el reporte PDF o elija "Todos".</p>
                        
                        <label className="block text-sm font-bold text-gray-700 mb-2">Filtrar por Departamento:</label>
                        <select 
                            value={selectedDept} 
                            onChange={(e) => setSelectedDept(e.target.value)}
                            className="w-full border border-gray-300 rounded-lg p-3 mb-8 focus:ring-2 focus:ring-[#1B396A] outline-none bg-gray-50"
                        >
                            <option value="TODOS">-- TODOS LOS DEPARTAMENTOS --</option>
                            {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>

                        <div className="flex justify-end gap-3">
                            <button onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition-colors">Cancelar</button>
                            <button 
                                onClick={() => onGenerate(selectedDept)} 
                                className="bg-[#1B396A] hover:bg-[#152d54] text-white px-6 py-2 rounded-lg font-semibold shadow-lg transition-transform transform hover:scale-105"
                            >
                                ‚ú® Generar PDF
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // COMPONENTE: DASHBOARD PRINCIPAL
        const Dashboard = ({ user, onLogout }) => {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [generatingReport, setGeneratingReport] = useState(false);
            const [showReportModal, setShowReportModal] = useState(false);
            const [period, setPeriod] = useState('ACTUAL');
            const [availableYears, setAvailableYears] = useState([]);

            // Efecto para cargar datos cuando cambia el periodo
            useEffect(() => {
                setLoading(true);
                console.log("Iniciando fetch para periodo:", period);
                
                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`)
                    .then(r => r.json())
                    .then(res => {
                        console.log("Datos recibidos:", res);
                        if(res.success) {
                            setStats(res.data);
                            if(res.availableYears) {
                                setAvailableYears(res.availableYears);
                            }
                        } else {
                            console.error("Error del servidor:", res.message);
                            alert("Error al cargar datos: " + res.message);
                        }
                    })
                    .catch(e => {
                        console.error("Error de red:", e);
                        alert("Error de conexi√≥n al cargar estad√≠sticas.");
                    })
                    .finally(() => setLoading(false));
            }, [period]);

            const handleReport = async (dept) => {
                setShowReportModal(false);
                setGeneratingReport(true);
                try {
                    await fetch(CONFIG.APPS_SCRIPT_URL, {
                        method: 'POST', mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'generateStatsReport', 
                            id_token: user.token, 
                            department: dept,
                            period: period 
                        })
                    });
                    alert(`La solicitud de reporte para el periodo ${period} (${dept}) ha sido enviada. Por favor verifique su correo institucional en unos momentos.`);
                } catch (e) { 
                    alert("Error al solicitar el reporte. Intente de nuevo."); 
                } finally { 
                    setGeneratingReport(false); 
                }
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl animate-fadeIn">
                    
                    {/* Header del Dashboard con Selector de Periodo */}
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#1B396A] gap-4">
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-[#1B396A]">Dashboard de Resultados</h2>
                            <p className="text-sm text-gray-500">Usuario: <span className="font-semibold">{user.name}</span></p>
                        </div>
                        
                        {/* Selector de Periodo */}
                        <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <span className="text-sm font-bold text-gray-700">Periodo:</span>
                            <select 
                                value={period}
                                onChange={(e) => setPeriod(e.target.value)}
                                className="bg-white border border-gray-300 text-gray-700 text-sm rounded-md focus:ring-[#1B396A] focus:border-[#1B396A] block p-1.5 outline-none font-semibold"
                                disabled={loading}
                            >
                                <option value="ACTUAL">üü¢ Periodo Actual</option>
                                {availableYears.map(year => (
                                    <option key={year} value={year}>üìÖ Hist√≥rico {year}</option>
                                ))}
                            </select>
                        </div>

                        <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm font-bold text-gray-700 transition-colors border border-gray-300">
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    {loading ? (
                        <div className="flex flex-col items-center justify-center p-20">
                            <div className="animate-spin h-12 w-12 border-4 border-[#1B396A] rounded-full border-t-transparent mb-4"></div>
                            <p className="text-[#1B396A] font-semibold">Cargando datos...</p>
                        </div>
                    ) : !stats ? (
                        <div className="text-center p-10 bg-white rounded-xl shadow">
                            <p className="text-[#9D2449] font-bold">No se pudieron cargar los datos. Verifique su conexi√≥n.</p>
                        </div>
                    ) : (
                        <>
                            {/* Tarjetas de Resumen (KPIs) */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-[#1B396A] hover:shadow-lg transition-shadow">
                                    <div className="flex items-center gap-4">
                                        <div className="text-4xl p-3 bg-blue-50 rounded-full">üìù</div>
                                        <div>
                                            <div className="text-3xl font-bold text-gray-800">{stats.totalInscripciones}</div>
                                            <div className="text-xs font-bold text-gray-500 uppercase tracking-wide">Inscripciones</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-[#D4AF37] hover:shadow-lg transition-shadow">
                                    <div className="flex items-center gap-4">
                                        <div className="text-4xl p-3 bg-yellow-50 rounded-full">üë©‚Äçüè´</div>
                                        <div>
                                            <div className="text-3xl font-bold text-gray-800">{stats.coberturaDocente.actualizados}</div>
                                            <div className="text-xs font-bold text-gray-500 uppercase tracking-wide">Docentes</div>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-md border-b-4 border-[#9D2449] hover:shadow-lg transition-shadow">
                                    <div className="flex items-center gap-4">
                                        <div className="text-4xl p-3 bg-pink-50 rounded-full">üéØ</div>
                                        <div>
                                            <div className="text-3xl font-bold text-gray-800">{stats.coberturaDocente.porcentaje}%</div>
                                            <div className="text-xs font-bold text-gray-500 uppercase tracking-wide">Cobertura</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Panel IA */}
                            <AIAnalysisPanel statsData={stats} period={period} />

                            {/* Gr√°ficas Principales */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 my-8">
                                <StatsChart type="doughnut" data={stats.distribucionGenero} title="Distribuci√≥n por G√©nero" id="chartGen" />
                                <StatsChart type="bar" data={stats.distribucionTipo} title="Tipo de Curso" id="chartType" />
                            </div>
                            
                            {/* Gr√°ficas Secundarias */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                <StatsChart type="bar" data={Object.fromEntries(stats.topDepartamentos||[])} title="Top 5 Departamentos" id="chartDept" />
                                <StatsChart type="bar" data={Object.fromEntries(stats.topCursos||[])} title="Cursos M√°s Demandados" id="chartCourse" />
                            </div>

                            {/* Bot√≥n de Reporte */}
                            <div className="bg-[#1B396A] rounded-xl p-8 text-center text-white shadow-lg mb-12 relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-4xl mb-4">üìÑ</div>
                                    <h3 className="text-2xl font-bold mb-2">Reporte Ejecutivo</h3>
                                    <p className="mb-6 opacity-90 max-w-2xl mx-auto text-sm">
                                        Genere un reporte PDF detallado con la lista de participantes y estad√≠sticas clave del periodo <strong>{period}</strong>. 
                                        El documento se enviar√° a su correo institucional.
                                    </p>
                                    <button 
                                        onClick={() => setShowReportModal(true)} 
                                        disabled={generatingReport} 
                                        className="bg-white text-[#1B396A] px-8 py-3 rounded-full font-bold shadow-md hover:bg-gray-100 disabled:opacity-70 disabled:cursor-not-allowed transition-all transform hover:scale-105"
                                    >
                                        {generatingReport ? "‚è≥ Generando..." : "‚ú® Seleccionar y Generar Reporte"}
                                    </button>
                                </div>
                                {/* Decoraci√≥n de fondo */}
                                <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                                     <div className="absolute -right-10 -top-10 w-64 h-64 bg-[#D4AF37] rounded-full mix-blend-overlay"></div>
                                     <div className="absolute -left-10 -bottom-10 w-64 h-64 bg-[#9D2449] rounded-full mix-blend-overlay"></div>
                                </div>
                            </div>

                            <ReportModal 
                                isOpen={showReportModal} 
                                onClose={() => setShowReportModal(false)} 
                                departments={stats.allDepartamentos || []} 
                                onGenerate={handleReport} 
                            />
                        </>
                    )}
                </div>
            );
        };

        // COMPONENTE: LOGIN
        const Login = ({ onLogin }) => {
            const ref = useRef(null);
            useEffect(() => {
                if(window.google?.accounts) {
                    window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin });
                    window.google.accounts.id.renderButton(ref.current, { theme: "outline", size: "large", text: "signin_with" });
                }
            }, [onLogin]);
            return (
                <div className="flex flex-col justify-center items-center py-20 animate-fadeIn">
                    <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full border-t-4 border-[#1B396A]">
                        <h2 className="text-2xl font-bold text-[#1B396A] mb-4">Acceso Administrativo</h2>
                        <p className="text-gray-600 mb-8">Inicie sesi√≥n con su cuenta institucional para ver las estad√≠sticas.</p>
                        <div className="flex justify-center" ref={ref}></div>
                    </div>
                </div>
            );
        };

        // COMPONENTE: APP PRINCIPAL
        const App = () => {
            const [user, setUser] = useState(null);
            const handleLogin = (res) => {
                const p = JSON.parse(atob(res.credential.split('.')[1]));
                setUser({ name: p.name, email: p.email, token: res.credential });
            };
            return user ? <Dashboard user={user} onLogout={() => setUser(null)} /> : <Login onLogin={handleLogin} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        document.addEventListener('DOMContentLoaded', () => document.getElementById('copyright-year').textContent = new Date().getFullYear());
    </script>
</body>
</html>
