<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- React y Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Librer√≠as para Reportes (PDF y Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Google Identity -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .markdown-body h1 { font-size: 1.5em; font-weight: bold; margin-bottom: 0.5em; color: #1B396A; }
        .markdown-body h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #9D2449; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body li { margin-bottom: 0.3em; }
        .markdown-body strong { color: #1B396A; }
    </style>
    
    <!-- Inicializaci√≥n segura de process.env si no existe -->
    <script>
        window.process = window.process || { env: {} };
    </script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40 border-b-4 border-[#1B396A]">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 md:h-20 object-contain">
                <div class="text-center flex-1 px-2 sm:px-4">
                    <h1 class="text-sm sm:text-xl md:text-2xl lg:text-3xl font-bold text-[#1B396A] leading-tight">PANEL DE ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm md:text-base text-[#9D2449] mt-1 font-semibold">Desarrollo Acad√©mico</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 md:h-20 object-contain">
            </div>
        </div>
    </header>
    
    <div id="back-link" class="container mx-auto px-4 py-4">
        <a href="index.html" class="text-[#1B396A] hover:text-[#9D2449] hover:underline flex items-center gap-1 text-sm font-semibold transition-colors">
            ‚Üê Volver al Portal Principal
        </a>
    </div>

    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-[#1B396A] text-white text-center py-6 sm:py-8 mt-12 border-t-4 border-[#9D2449]">
        <div class="container mx-auto px-4">
             <p class="font-semibold text-sm sm:text-base mb-2">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
             <p class="text-xs sm:text-sm opacity-90">M.C. Alejandro Calder√≥n Renter√≠a</p>
             <p id="copyright-year" class="text-xs sm:text-sm opacity-75 mt-1"></p>
        </div>
    </footer>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const CONFIG = {
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com', 
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec'
        };

        const INSTITUTIONAL_COLORS = ['#1B396A', '#9D2449', '#B0BEC5', '#D4AF37', '#546E7A', '#455A64'];
        const ITD_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png';
        const TECNM_LOGO_URL = 'https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg';

        // Helper para obtener im√°genes para el PDF
        const getImageDataFromURL = (url) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = (err) => { console.warn("Error cargando imagen PDF", err); resolve(null); };
                img.src = url;
            });
        };

        // Funci√≥n para Generar PDF Cliente Avanzado
        const generatePDFReport = async (data, meta) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();

            // Cargar Im√°genes
            const [itdLogo, tecNmLogo] = await Promise.all([
                getImageDataFromURL(ITD_LOGO_URL),
                getImageDataFromURL(TECNM_LOGO_URL)
            ]);

            // Definir funci√≥n de cabecera para repetir en cada p√°gina
            const drawHeader = (data) => {
                // Logo TecNM (Derecha) - Mantenemos en cabecera
                if (tecNmLogo) doc.addImage(tecNmLogo, 'JPEG', 160, 10, 35, 16);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.setTextColor(27, 57, 106); // Azul ITD
                doc.text("INSTITUTO TECNOL√ìGICO DE DURANGO", pageWidth / 2, 18, { align: "center" });
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Coordinaci√≥n de Actualizaci√≥n Docente", pageWidth / 2, 23, { align: "center" });
                
                doc.setFontSize(11);
                doc.setTextColor(157, 36, 73); // Guinda
                doc.text(`REPORTE DE INSCRIPCIONES - PERIODO ${meta.period}`, pageWidth / 2, 32, { align: "center" });

                // Informaci√≥n del Filtro
                doc.setFontSize(9);
                doc.setTextColor(50);
                doc.text(`Departamento Filtrado: ${meta.department}`, 15, 42);
                doc.text(`Fecha de Emisi√≥n: ${new Date().toLocaleDateString()}`, 15, 47);
            };

            // Definir funci√≥n de Marca de Agua (ITD Logo en el fondo)
            const drawWatermark = () => {
                if (itdLogo) {
                    doc.saveGraphicsState();
                    doc.setGState(new doc.GState({ opacity: 0.1 })); // Transparencia baja
                    const w = 120;
                    const h = 120;
                    const x = (pageWidth - w) / 2;
                    const y = (pageHeight - h) / 2;
                    doc.addImage(itdLogo, 'PNG', x, y, w, h);
                    doc.restoreGraphicsState();
                }
            };

            // Definir columnas y datos
            const tableColumn = ["Docente", "Curso Inscrito", "Fechas", "Depto. que Ofrece"];
            const tableRows = data.map(row => [
                row.nombre,
                row.curso,
                row.fechas || 'N/A', // Nueva Columna Fechas
                row.depto_oferente || 'N/A'
            ]);

            // Generar Tabla con Hooks
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 52,
                theme: 'grid',
                headStyles: { 
                    fillColor: [27, 57, 106], 
                    textColor: 255, 
                    fontSize: 8, 
                    fontStyle: 'bold',
                    halign: 'center'
                },
                bodyStyles: { fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 50 }, // Docente
                    1: { cellWidth: 'auto' }, // Curso
                    2: { cellWidth: 30 }, // Fechas
                    3: { cellWidth: 45 } // Depto Oferente
                },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: 52, left: 15, right: 15 },
                // Hook: Se ejecuta antes de dibujar cada p√°gina
                didDrawPage: function (data) {
                    // Dibujar Marca de Agua y Cabecera en cada p√°gina
                    drawWatermark();
                    drawHeader();
                }
            });

            // Footer con n√∫mero de p√°gina
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${i} de ${pageCount}`, pageWidth / 2, 290, { align: "center" });
            }

            doc.save(`Reporte_ITD_${meta.period}_${meta.department.substring(0,10)}.pdf`);
        };

        // Funci√≥n para Generar Excel
        const generateExcelReport = (data, meta) => {
            if (typeof XLSX === 'undefined') {
                alert("La librer√≠a de Excel no se carg√≥ correctamente.");
                return;
            }

            // Preparar datos para Excel
            const formattedData = data.map(row => ({
                "Docente": row.nombre,
                "Curso Inscrito": row.curso,
                "Fechas del Curso": row.fechas || 'N/A',
                "Departamento que Ofrece": row.depto_oferente || 'N/A',
                "Folio": row.folio
            }));

            // Crear libro y hoja
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(formattedData);

            // Ajustar ancho de columnas (estimado)
            const wscols = [
                {wch: 40}, // Docente
                {wch: 50}, // Curso
                {wch: 25}, // Fechas
                {wch: 35}, // Depto
                {wch: 20}  // Folio
            ];
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, `Reporte ${meta.period}`);
            
            // Descargar
            XLSX.writeFile(wb, `Reporte_ITD_${meta.period}.xlsx`);
        };

        const StatsChart = ({ type, data, title, id }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            const hasData = useMemo(() => {
                if (!data) return false;
                return Object.keys(data).length > 0 && Object.values(data).some(val => typeof val === 'number' ? val > 0 : false);
            }, [data]);

            useEffect(() => {
                if (!canvasRef.current || !hasData) return;
                if (typeof window.Chart === 'undefined') return;
                if (chartRef.current) chartRef.current.destroy();

                try {
                    const ctx = canvasRef.current.getContext('2d');
                    const isPie = type === 'pie' || type === 'doughnut';
                    let backgroundColors = isPie ? INSTITUTIONAL_COLORS : '#1B396A';
                    
                    chartRef.current = new window.Chart(ctx, {
                        type: type,
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                label: title,
                                data: Object.values(data),
                                backgroundColor: backgroundColors,
                                borderWidth: isPie ? 2 : 0,
                                borderRadius: isPie ? 0 : 4,
                                hoverBackgroundColor: isPie ? INSTITUTIONAL_COLORS : '#9D2449'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', display: isPie } },
                            scales: !isPie ? { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } } : {}
                        }
                    });
                } catch (err) { console.error("Chart error:", err); }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, title, hasData]);

            if (!hasData) return (
                <div className="bg-white p-4 rounded-xl shadow-md h-80 w-full flex flex-col items-center justify-center text-gray-400 border border-gray-100">
                    <div className="text-4xl mb-2">üìä</div><p className="text-sm">Sin datos suficientes.</p>
                </div>
            );

            return (
                <div className="bg-white p-6 rounded-xl shadow-md h-80 w-full border-t-4 border-[#1B396A]">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 text-center">{title}</h3>
                    <div className="h-60"><canvas ref={canvasRef} id={id}></canvas></div>
                </div>
            );
        };

        const AIAnalysisPanel = ({ statsData, period }) => {
            const [analysis, setAnalysis] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleGenerateAnalysis = async () => {
                setLoading(true); setError(null);
                
                // Acceder directamente a la variable de entorno
                const apiKey = process.env.API_KEY;
                
                if (!apiKey) { 
                    setError("‚ö†Ô∏è Falta configuraci√≥n de API Key."); 
                    setLoading(false); 
                    return; 
                }
                
                try {
                    const cleanStats = { ...statsData, allDepartamentos: undefined };
                    const prompt = `Act√∫a como analista acad√©mico. Analiza estos datos del periodo ${period}: ${JSON.stringify(cleanStats)}. Destaca el √≠ndice de recurrencia docente (maestros tomando >1 curso). Dame un resumen ejecutivo.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) setAnalysis(text); else throw new Error("Sin respuesta del modelo.");
                    
                } catch (err) { 
                    console.error("AI Error:", err);
                    setError("Error al conectar con la IA. Verifique la consola."); 
                } finally { 
                    setLoading(false); 
                }
            };

            return (
                <div className="mt-8 bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                    <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div className="flex items-center gap-2"><span className="text-2xl">‚ú®</span><h3 className="text-lg font-bold text-[#1B396A]">An√°lisis Inteligente (IA)</h3></div>
                        {!analysis && !loading && <button onClick={handleGenerateAnalysis} className="bg-[#9D2449] text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md">‚ö° Generar An√°lisis</button>}
                    </div>
                    {loading && <div className="text-[#1B396A] p-4 animate-pulse">Analizando datos...</div>}
                    {error && <div className="text-red-600 p-3 text-sm bg-red-50 rounded border border-red-200">{error}</div>}
                    {analysis && <div className="bg-gray-50 p-6 rounded-lg border-l-4 border-[#D4AF37] markdown-body text-sm" dangerouslySetInnerHTML={{ __html: marked.parse(analysis) }} />}
                </div>
            );
        };

        const ReportModal = ({ isOpen, onClose, departments, period, onGeneratePdf, onGenerateExcel }) => {
            const [selectedDept, setSelectedDept] = useState('TODOS');
            const [loading, setLoading] = useState(false);

            if(!isOpen) return null;

            const handleAction = async (action) => {
                setLoading(true);
                if (action === 'pdf') await onGeneratePdf(selectedDept);
                if (action === 'excel') await onGenerateExcel(selectedDept);
                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full animate-fadeIn border-t-4 border-[#1B396A]">
                        <h3 className="text-xl font-bold text-[#1B396A] mb-2">Descargar Reporte</h3>
                        <p className="text-sm text-gray-600 mb-6">Periodo: <strong>{period}</strong>.</p>
                        
                        <label className="block text-sm font-bold text-gray-700 mb-2">Filtrar por Departamento:</label>
                        <select value={selectedDept} onChange={(e) => setSelectedDept(e.target.value)} className="w-full border border-gray-300 rounded-lg p-3 mb-8 bg-gray-50">
                            <option value="TODOS">-- TODOS LOS DEPARTAMENTOS --</option>
                            {departments.map(d => <option key={d} value={d}>{d}</option>)}
                        </select>

                        <div className="grid grid-cols-1 gap-3">
                            <button onClick={() => handleAction('pdf')} disabled={loading} className="bg-[#1B396A] hover:bg-[#152d54] text-white px-4 py-3 rounded-lg font-semibold shadow-lg flex items-center justify-center gap-2">
                                {loading ? '‚è≥' : 'üìÑ'} Descargar PDF
                            </button>
                            <button onClick={() => handleAction('excel')} disabled={loading} className="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-semibold shadow-lg flex items-center justify-center gap-2">
                                {loading ? '‚è≥' : 'üìä'} Descargar Excel
                            </button>
                            <button onClick={onClose} disabled={loading} className="mt-2 bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-200">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ user, onLogout }) => {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showReportModal, setShowReportModal] = useState(false);
            const [period, setPeriod] = useState('ACTUAL');
            const [availableYears, setAvailableYears] = useState([]);

            useEffect(() => {
                setLoading(true);
                fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}`)
                    .then(r => r.json())
                    .then(res => {
                        if(res.success) { setStats(res.data); if(res.availableYears) setAvailableYears(res.availableYears); }
                    })
                    .finally(() => setLoading(false));
            }, [period]);

            const getReportData = async (dept) => {
                try {
                    const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getReportData&period=${period}&department=${encodeURIComponent(dept)}`);
                    const json = await response.json();
                    if(json.success) return json;
                    else throw new Error(json.message);
                } catch(e) {
                    alert("Error obteniendo datos: " + e.toString());
                    return null;
                }
            };

            const handlePdf = async (dept) => {
                const res = await getReportData(dept);
                if(res) await generatePDFReport(res.data, res.meta);
            };

            const handleExcel = async (dept) => {
                const res = await getReportData(dept);
                if(res) generateExcelReport(res.data, res.meta);
            };

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-sm p-4 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#1B396A] gap-4">
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-[#1B396A]">Dashboard de Resultados</h2>
                            <p className="text-sm text-gray-500">Usuario: <span className="font-semibold">{user.name}</span></p>
                        </div>
                        <div className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200">
                            <span className="text-sm font-bold text-gray-700">Periodo:</span>
                            <select value={period} onChange={(e) => setPeriod(e.target.value)} className="bg-white border border-gray-300 text-gray-700 text-sm rounded-md font-semibold block p-1.5" disabled={loading}>
                                <option value="ACTUAL">üü¢ Periodo Actual</option>
                                {availableYears.map(year => <option key={year} value={year}>üìÖ Hist√≥rico {year}</option>)}
                            </select>
                        </div>
                        <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded text-sm font-bold text-gray-700 border border-gray-300">Cerrar Sesi√≥n</button>
                    </div>

                    {loading ? <div className="flex justify-center p-20"><div className="animate-spin h-12 w-12 border-4 border-[#1B396A] rounded-full border-t-transparent"></div></div> : !stats ? <div className="text-center p-10">Error de carga.</div> : (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#1B396A]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üìù</div>
                                        <div>
                                            <div className="text-2xl font-bold text-gray-800">{stats.totalInscripciones}</div>
                                            <div className="text-[10px] font-bold text-gray-500 uppercase">Inscripciones Totales</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#D4AF37]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üë©‚Äçüè´</div>
                                        <div>
                                            <div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.actualizados}</div>
                                            <div className="text-[10px] font-bold text-gray-500 uppercase">Docentes √önicos</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-[#9D2449]">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üîÅ</div>
                                        <div>
                                            <div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.recurrentes}</div>
                                            <div className="text-[10px] font-bold text-gray-500 uppercase">Docentes Recurrentes</div>
                                            <div className="text-[9px] text-gray-400">M√°s de 1 curso</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-5 rounded-xl shadow-md border-b-4 border-gray-500">
                                    <div className="flex items-center gap-3">
                                        <div className="text-3xl">üéØ</div>
                                        <div>
                                            <div className="text-2xl font-bold text-gray-800">{stats.coberturaDocente.porcentaje}%</div>
                                            <div className="text-[10px] font-bold text-gray-500 uppercase">Cobertura Estimada</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <AIAnalysisPanel statsData={stats} period={period} />

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 my-8">
                                <StatsChart type="doughnut" data={stats.distribucionGenero} title="Distribuci√≥n por G√©nero" id="chartGen" />
                                <StatsChart type="bar" data={stats.distribucionTipo} title="Tipo de Curso" id="chartType" />
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                                <StatsChart type="bar" data={Object.fromEntries(stats.topDepartamentos||[])} title="Top 5 Departamentos" id="chartDept" />
                                <StatsChart type="bar" data={Object.fromEntries(stats.topCursos||[])} title="Cursos M√°s Demandados" id="chartCourse" />
                            </div>

                            <div className="bg-[#1B396A] rounded-xl p-8 text-center text-white shadow-lg mb-12 relative overflow-hidden">
                                <div className="relative z-10">
                                    <div className="text-4xl mb-4">üìÑ</div>
                                    <h3 className="text-2xl font-bold mb-2">Reporte Ejecutivo</h3>
                                    <p className="mb-6 opacity-90 text-sm">Descargar lista detallada de participantes del periodo <strong>{period}</strong>.</p>
                                    <button onClick={() => setShowReportModal(true)} className="bg-white text-[#1B396A] px-8 py-3 rounded-full font-bold shadow-md hover:bg-gray-100 transition-transform transform hover:scale-105">
                                        ‚¨áÔ∏è Descargar Reporte
                                    </button>
                                </div>
                            </div>

                            <ReportModal 
                                isOpen={showReportModal} 
                                onClose={() => setShowReportModal(false)} 
                                departments={stats.allDepartamentos || []} 
                                period={period} 
                                onGeneratePdf={handlePdf}
                                onGenerateExcel={handleExcel}
                            />
                        </>
                    )}
                </div>
            );
        };

        const Login = ({ onLogin }) => {
            const ref = useRef(null);
            useEffect(() => {
                if(window.google?.accounts) {
                    window.google.accounts.id.initialize({ client_id: CONFIG.GOOGLE_CLIENT_ID, callback: onLogin });
                    window.google.accounts.id.renderButton(ref.current, { theme: "outline", size: "large", text: "signin_with" });
                }
            }, [onLogin]);
            return (
                <div className="flex justify-center items-center py-20 animate-fadeIn">
                    <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-md w-full border-t-4 border-[#1B396A]">
                        <h2 className="text-2xl font-bold text-[#1B396A] mb-4">Acceso Administrativo</h2>
                        <p className="text-gray-600 mb-8">Inicie sesi√≥n con su cuenta institucional.</p>
                        <div className="flex justify-center" ref={ref}></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const handleLogin = (res) => { const p = JSON.parse(atob(res.credential.split('.')[1])); setUser({ name: p.name, email: p.email }); };
            return user ? <Dashboard user={user} onLogout={() => setUser(null)} /> : <Login onLogin={handleLogin} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
        document.addEventListener('DOMContentLoaded', () => document.getElementById('copyright-year').textContent = new Date().getFullYear());
    </script>
</body>
</html>
