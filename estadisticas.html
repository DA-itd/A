<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estad√≠sticas</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <!-- PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- DARK MODE -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const toggle = () => {
                document.documentElement.classList.toggle("dark");
                localStorage.setItem("DARK", document.documentElement.classList.contains("dark"));
            };
            if (localStorage.getItem("DARK") === "true") document.documentElement.classList.add("dark");
            window.toggleDarkMode = toggle;
        });
    </script>

    <style>
        .dark body { background: #0f0f0f !important; color: white !important; }
        .dark .card { background: #1a1a1a !important; color: white !important; }
        .card { background: white; border-radius: 12px; padding: 20px; }
    </style>
</head>
<body class="p-6">

    <a href="index.html" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 mb-4 inline-block">‚Üê Regresar al panel principal</a>
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">üìä Panel de Estad√≠sticas</h1>
        <button onclick="toggleDarkMode()" class="px-4 py-2 bg-black text-white rounded">üåô Modo Noche</button>
    </div>

    <div class="mb-4 flex gap-4">
        <select id="yearSelector" class="p-2 border rounded"></select>
        <button onclick="generatePDF()" class="px-4 py-2 bg-red-700 text-white rounded">üìÑ Exportar PDF</button>
    </div>

    <div id="statsContainer" class="space-y-6">

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card"><div class="text-gray-600 dark:text-gray-300">Inscripciones</div><div id="kpi1" class="text-3xl font-bold"></div></div>
            <div class="card"><div class="text-gray-600 dark:text-gray-300">Docentes √önicos</div><div id="kpi2" class="text-3xl font-bold"></div></div>
            <div class="card"><div class="text-gray-600 dark:text-gray-300">Recurrentes</div><div id="kpi3" class="text-3xl font-bold"></div></div>
            <div class="card"><div class="text-gray-600 dark:text-gray-300">Cobertura</div><div id="kpi4" class="text-3xl font-bold"></div></div>
        </div>

        <!-- Cursos -->
        <div class="card">
            <h2 class="text-xl font-bold mb-2">Top Cursos</h2>
            <canvas id="chartCursos"></canvas>
        </div>

        <!-- Departamentos y G√©nero -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card"><h2 class="text-xl font-bold mb-2">Departamentos</h2><canvas id="chartDept"></canvas></div>
            <div class="card"><h2 class="text-xl font-bold mb-2">G√©nero</h2><canvas id="chartGenero"></canvas></div>
        </div>

        <!-- Frecuencia y Tipo -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card"><h2 class="text-xl font-bold mb-2">Frecuencia</h2><canvas id="chartFreq"></canvas></div>
            <div class="card"><h2 class="text-xl font-bold mb-2">Tipo</h2><canvas id="chartTipo"></canvas></div>
        </div>

        <!-- Hist√≥rico -->
        <div class="card"><h2 class="text-xl font-bold mb-2">Hist√≥rico</h2><canvas id="chartHist"></canvas></div>

        <!-- Comparativa 3 a√±os -->
        <div class="card"><h2 class="text-xl font-bold mb-2">Comparativa 3 A√±os</h2><canvas id="chart3Y"></canvas></div>

    </div>

<script>
let stats = null;
let years = [];

async function loadStats() {
    google.script.run
        .withSuccessHandler(function(result) {
            renderStats(result);
        })
        .withFailureHandler(function(err) {
            console.error("ERROR cargando estad√≠sticas:", err);
        })
        .getStatisticsData({ period: "ACTUAL" });
}

function renderStats(result) {
    if (!result || !result.success) {
        console.error("Error obteniendo datos:", result);
        return;
    }

    stats = result.data;
    years = result.availableYears;

    document.getElementById("kpi1").textContent = stats.totalInscripciones;
    document.getElementById("kpi2").textContent = stats.coberturaDocente.actualizados;
    document.getElementById("kpi3").textContent = stats.coberturaDocente.recurrentes;
    document.getElementById("kpi4").textContent = stats.coberturaDocente.porcentaje + "%";

    const sel = document.getElementById("yearSelector");
    sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");

    setTimeout(() => { renderCharts(); }, 150);
}


}

function renderCharts() {
    createBarChart("chartCursos", stats.topCursos.slice(0,10).map(x => x[0]), stats.topCursos.slice(0,10).map(x => x[1]));
    createBarChart("chartDept", stats.topDepartamentos.map(x=>x[0]), stats.topDepartamentos.map(x=>x[1]));
    createPieChart("chartGenero", Object.keys(stats.distribucionGenero), Object.values(stats.distribucionGenero));
    createBarChart("chartFreq", Object.keys(stats.frecuenciaParticipacion), Object.values(stats.frecuenciaParticipacion));
    createPieChart("chartTipo", Object.keys(stats.distribucionTipo), Object.values(stats.distribucionTipo));

    createLineChart("chartHist",
        Object.keys(stats.historicalTrend),
        Object.values(stats.historicalTrend).map(x=>x.registros));

    const last3 = Object.keys(stats.historicalTrend).slice(-3);
    createBarChart("chart3Y",
        last3,
        last3.map(y => stats.historicalTrend[y].registros)
    );
}

function createBarChart(id, labels, data) {
    new Chart(document.getElementById(id), {
        type: "bar",
        data: { labels, datasets: [{ data, backgroundColor: "#8b0000" }] },
        options: { responsive: true }
    });
}

function createPieChart(id, labels, data) {
    new Chart(document.getElementById(id), {
        type: "pie",
        data: { labels, datasets: [{ data }] },
        options: { responsive: true }
    });
}

function createLineChart(id, labels, data) {
    new Chart(document.getElementById(id), {
        type: "line",
        data: { labels, datasets: [{ data, borderColor: "#8b0000" }] },
        options: { responsive: true }
    });
}

async function generatePDF() {
    const el = document.getElementById("statsContainer");
    const canvas = await html2canvas(el, { scale: 4 });

    const img = canvas.toDataURL("image/png", 1.0);
    const pdf = new jspdf.jsPDF({ unit: "mm", format: "letter", compress: false });

    const w = 210;
    const h = (canvas.height * 210) / canvas.width;

    pdf.addImage(img, "PNG", 0, 0, w, h, undefined, "SLOW");
    pdf.save("Estadisticas.pdf");
}

loadStats();
</script>
</body>
</html>
