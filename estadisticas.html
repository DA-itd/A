<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Portal de Actualizaci√≥n Docente ITD</title>
    
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png">
    
    <!-- React y Babel (CDNJS para mayor estabilidad) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Estilos y Utilidades -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JH1X2720VL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JH1X2720VL');
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Colores Institucionales TecNM */
        .text-tecnm-blue { color: #1B396A; }
        .bg-tecnm-blue { background-color: #1B396A; }
        .border-tecnm-guinda { border-color: #9D2449; }
        .text-tecnm-guinda { color: #9D2449; }
        
        /* Spinner para carga inicial */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #9D2449;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<!-- Fondo c√°lido (orange/amber) igual que historial.html -->
<body class="bg-gradient-to-br from-orange-50 via-amber-50 to-yellow-50 min-h-screen text-gray-800 flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-xl sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 sm:py-6">
            <div class="flex items-center justify-between gap-4">
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/TecNM_logo.jpg" alt="TecNM" class="h-12 sm:h-16 object-contain">
                <div class="text-center flex-1">
                    <h1 class="text-lg sm:text-2xl font-bold text-tecnm-blue">ESTAD√çSTICAS</h1>
                    <p class="text-xs sm:text-sm text-blue-700 font-semibold">Actualizaci√≥n Docente ITD</p>
                </div>
                <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="ITD" class="h-12 sm:h-16 object-contain">
            </div>
        </div>
    </header>
    
    <!-- Bot√≥n Volver -->
    <div class="container mx-auto px-4 py-4 max-w-7xl">
        <a href="index.html" class="text-indigo-800 hover:text-indigo-600 font-bold text-sm flex items-center gap-1">
            ‚Üê Volver al Portal Principal
        </a>
    </div>

    <!-- Contenedor Principal React -->
    <div id="root" class="flex-grow container mx-auto px-4">
        <!-- Fallback visible si React falla -->
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto mt-10 text-center">
            <div class="loader"></div>
            <h2 class="text-xl font-bold text-gray-700 mt-4">Cargando sistema...</h2>
            <p class="text-sm text-gray-500 mt-2">Si esto tarda demasiado, por favor recargue la p√°gina.</p>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-orange-900 to-amber-900 text-white text-center py-6 mt-12">
        <div class="container mx-auto px-4">
            <p class="font-bold text-sm">¬© Coordinaci√≥n de Actualizaci√≥n Docente</p>
            <p class="text-xs opacity-75 mt-1">Instituto Tecnol√≥gico de Durango</p>
        </div>
    </footer>

    <!-- L√ìGICA REACT -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFO97VhIEO2ke2p-ZvYpXMWHP_LAxqmR0U5CmhPvOoQAH24FUAOt2rqGtoUhU-MKQauw/exec',
            GOOGLE_CLIENT_ID: '524996225715-5l95j3lces5hi49c19rfgotdrfo2seq1.apps.googleusercontent.com',
        };

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Error al decodificar token:", e);
                return null;
            }
        }

        // --- COMPONENTES VISUALES ---

        const KpiCard = ({ title, value, icon, color }) => (
            <div className={`bg-white p-6 rounded-xl shadow-md border-l-4 ${color} flex items-center justify-between transform transition hover:scale-105`}>
                <div>
                    <p className="text-sm text-gray-500 font-semibold uppercase tracking-wider">{title}</p>
                    <p className="text-3xl font-bold text-gray-800 mt-1">{value}</p>
                </div>
                <div className="text-4xl opacity-30 grayscale">{icon}</div>
            </div>
        );

        const Dashboard = ({ data, availableYears, selectedPeriod, onPeriodChange, user, onLogout }) => {
            const chartsRef = useRef({});

            useEffect(() => {
                if (!data) return;
                
                // Limpieza segura
                Object.keys(chartsRef.current).forEach(key => {
                    if (chartsRef.current[key]) {
                        chartsRef.current[key].destroy();
                        chartsRef.current[key] = null;
                    }
                });

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                };

                try {
                    // 1. Gr√°fica por Departamento
                    const ctxDept = document.getElementById('chartDept');
                    if (ctxDept && data.topDepartamentos) {
                        chartsRef.current.dept = new Chart(ctxDept, {
                            type: 'bar',
                            data: {
                                labels: data.topDepartamentos.map(d => d[0]),
                                datasets: [{
                                    label: 'Participantes',
                                    data: data.topDepartamentos.map(d => d[1]),
                                    backgroundColor: '#1B396A',
                                    borderRadius: 4
                                }]
                            },
                            options: { ...commonOptions, plugins: { legend: { display: false } } }
                        });
                    }

                    // 2. Gr√°fica por G√©nero
                    const ctxGender = document.getElementById('chartGender');
                    if (ctxGender && data.distribucionGenero) {
                        chartsRef.current.gender = new Chart(ctxGender, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(data.distribucionGenero),
                                datasets: [{
                                    data: Object.values(data.distribucionGenero),
                                    backgroundColor: ['#1B396A', '#9D2449', '#9CA3AF'],
                                    borderWidth: 0
                                }]
                            },
                            options: commonOptions
                        });
                    }

                    // 3. Top Cursos
                    const ctxCourses = document.getElementById('chartCourses');
                    if (ctxCourses && data.topCursos) {
                        const labels = data.topCursos.map(c => {
                            const name = c[0] || '';
                            return name.length > 30 ? name.substring(0, 30) + '...' : name;
                        });
                        chartsRef.current.courses = new Chart(ctxCourses, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Inscritos',
                                    data: data.topCursos.map(c => c[1]),
                                    backgroundColor: '#9D2449',
                                    borderRadius: 4,
                                    indexAxis: 'y',
                                }]
                            },
                            options: { ...commonOptions, indexAxis: 'y', plugins: { legend: { display: false } } }
                        });
                    }
                } catch (e) {
                    console.error("Error creando gr√°ficas:", e);
                }

                return () => {
                    Object.values(chartsRef.current).forEach(c => c && c.destroy());
                };
            }, [data]);

            return (
                <div className="animate-fadeIn container mx-auto py-4">
                    
                    {/* Tarjeta Principal con L√≠nea Guinda */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-8 border-tecnm-guinda flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-tecnm-blue">Tablero de Control</h2>
                            <p className="text-gray-600">Bienvenido, <span className="font-semibold">{user.name}</span></p>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2 items-center">
                            <label className="text-sm font-semibold text-gray-600">Periodo:</label>
                            <select 
                                value={selectedPeriod}
                                onChange={(e) => onPeriodChange(e.target.value)}
                                className="bg-gray-50 border border-gray-300 text-gray-700 py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-900"
                            >
                                {availableYears.map(year => (
                                    <option key={year} value={year}>{year === 'ACTUAL' ? 'Ciclo Actual' : `Ciclo ${year}`}</option>
                                ))}
                            </select>
                            <button onClick={onLogout} className="w-full sm:w-auto bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-bold transition shadow-sm ml-0 sm:ml-2">
                                Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>

                    {/* KPIs */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <KpiCard title="Total Inscripciones" value={data.totalInscripciones} icon="üë•" color="border-blue-800" />
                        <KpiCard title="Cobertura Docente" value={`${data.coberturaDocente?.porcentaje || 0}%`} icon="üìä" color="border-yellow-500" />
                        <KpiCard title="Cursos Ofertados" value={data.historicalTrend?.[selectedPeriod === 'ACTUAL' ? new Date().getFullYear() : selectedPeriod]?.cursos || (data.topCursos ? data.topCursos.length : 0)} icon="üìö" color="border-tecnm-guinda" />
                    </div>

                    {/* Gr√°ficas */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-800">
                            <h3 className="text-lg font-bold text-tecnm-blue mb-4">Participaci√≥n por Departamento (Top 5)</h3>
                            <div className="h-64 relative"><canvas id="chartDept"></canvas></div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-tecnm-guinda">
                            <h3 className="text-lg font-bold text-tecnm-guinda mb-4">Distribuci√≥n por G√©nero</h3>
                            <div className="h-64 relative"><canvas id="chartGender"></canvas></div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-gray-600">
                        <h3 className="text-lg font-bold text-gray-700 mb-4">Top Cursos M√°s Solicitados</h3>
                        <div className="h-80 relative"><canvas id="chartCourses"></canvas></div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, error }) => {
            const btnRef = useRef(null);
            const [status, setStatus] = useState('loading'); // loading, ready, error

            useEffect(() => {
                let attempts = 0;
                const interval = setInterval(() => {
                    if (window.google && window.google.accounts) {
                        clearInterval(interval);
                        setStatus('ready');
                        try {
                            window.google.accounts.id.initialize({
                                client_id: CONFIG.GOOGLE_CLIENT_ID,
                                callback: onLogin,
                                cancel_on_tap_outside: false
                            });
                            if (btnRef.current) {
                                window.google.accounts.id.renderButton(btnRef.current, {
                                    theme: "filled_blue", size: "large", shape: "rectangular", width: 280
                                });
                            }
                        } catch (e) {
                            console.error("GSI Error:", e);
                            setStatus('error');
                        }
                    } else {
                        attempts++;
                        if (attempts > 20) { // 10 segundos
                            clearInterval(interval);
                            setStatus('timeout');
                        }
                    }
                }, 500);
                return () => clearInterval(interval);
            }, [onLogin]);

            return (
                <div className="flex flex-col items-center justify-center py-12 animate-fadeIn px-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full border-t-8 border-tecnm-blue">
                        <div className="text-6xl mb-4">üîí</div>
                        <h2 className="text-2xl font-bold text-tecnm-blue mb-2">Acceso a Estad√≠sticas</h2>
                        <p className="text-gray-600 mb-8">
                            Por favor, inicie sesi√≥n con su cuenta institucional para visualizar los datos.
                        </p>
                        
                        {error && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-6 border border-red-200">
                                <strong>Error:</strong> {error}
                            </div>
                        )}

                        {status === 'timeout' && (
                            <div className="bg-yellow-50 text-yellow-800 p-3 rounded mb-4 text-sm">
                                La conexi√≥n con Google est√° tardando. Verifique su internet.
                            </div>
                        )}
                        
                        <div className="flex justify-center min-h-[50px]" ref={btnRef}>
                            {status === 'loading' && <span className="text-gray-400 text-sm self-center animate-pulse">Cargando bot√≥n de acceso...</span>}
                            {status === 'timeout' && <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Recargar P√°gina</button>}
                        </div>
                    </div>
                </div>
            );
        };

        const LoadingScreen = () => (
            <div className="flex flex-col items-center justify-center h-96 animate-fadeIn">
                <div className="loader mb-4"></div>
                <p className="text-gray-600 font-semibold animate-pulse">Procesando datos del servidor...</p>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [statsResponse, setStatsResponse] = useState(null);
            const [selectedPeriod, setSelectedPeriod] = useState('ACTUAL');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleLogin = async (response) => {
                try {
                    const payload = parseJwt(response.credential);
                    if (payload) {
                        setUser({
                            name: payload.name,
                            email: payload.email,
                            picture: payload.picture,
                            token: response.credential
                        });
                        setError(null);
                    } else {
                        setError("No se pudo decodificar su informaci√≥n.");
                    }
                } catch (e) {
                    console.error(e);
                    setError("Error de autenticaci√≥n interna.");
                }
            };

            useEffect(() => {
                if (user) {
                    fetchStatistics(selectedPeriod);
                }
            }, [user, selectedPeriod]);

            const fetchStatistics = async (period) => {
                setLoading(true);
                setError(null);
                try {
                    const url = `${CONFIG.APPS_SCRIPT_URL}?action=getStatisticsData&period=${period}&id_token=${user.token}`;
                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        setStatsResponse(result);
                    } else {
                        setError(result.message || "No se pudieron cargar las estad√≠sticas.");
                    }
                } catch (err) {
                    console.error(err);
                    setError("Error de conexi√≥n con el servidor.");
                } finally {
                    setLoading(false);
                }
            };

            if (!user) return <LoginScreen onLogin={handleLogin} error={error} />;
            if (loading && !statsResponse) return <LoadingScreen />;
            if (error) {
                return (
                    <div className="container mx-auto p-8 text-center animate-fadeIn">
                        <div className="bg-white border-l-8 border-red-500 text-gray-700 p-8 rounded shadow-xl inline-block max-w-2xl">
                            <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                            <h3 className="font-bold text-2xl mb-2 text-red-600">Error de Carga</h3>
                            <p className="text-lg mb-6">{error}</p>
                            <div className="flex justify-center gap-4">
                                <button onClick={() => fetchStatistics(selectedPeriod)} className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition shadow">Reintentar</button>
                                <button onClick={() => { setUser(null); setError(null); }} className="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 transition">Cerrar Sesi√≥n</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <Dashboard 
                    data={statsResponse ? statsResponse.data : null} 
                    availableYears={statsResponse ? statsResponse.availableYears : ['ACTUAL']}
                    selectedPeriod={selectedPeriod}
                    onPeriodChange={setSelectedPeriod}
                    user={user} 
                    onLogout={() => setUser(null)} 
                />
            );
        };

        // Montaje seguro de React
        try {
            const rootElement = document.getElementById('root');
            if (rootElement) {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } else {
                console.error("Elemento root no encontrado");
            }
        } catch (error) {
            console.error("Error cr√≠tico al montar React:", error);
            document.getElementById('root').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative text-center mt-10" role="alert">
                    <strong class="font-bold">Error de Inicializaci√≥n:</strong>
                    <span class="block sm:inline">No se pudo cargar la aplicaci√≥n. Por favor, actualice su navegador.</span>
                    <br><small>${error.message}</small>
                </div>
            `;
        }
    </script>
</body>
</html>
