// =============================================================================
// GOOGLE APPS SCRIPT - SISTEMA COMPLETO ITD
// Versi√≥n: 11.0.0 - Extracci√≥n Directa de ID de Curso
// =============================================================================

// ===== CONFIGURACI√ìN =====
const SPREADSHEET_ID = '1KLPdMw1AzDdNSqYRRUZnvkyHLQnL2TWQ0Sk0282CN-A';

// =============================================================================
// FUNCI√ìN PRINCIPAL - MANEJA TODAS LAS PETICIONES POST
// =============================================================================
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'submitSurveyRecord') {
      return ContentService.createTextOutput(JSON.stringify(submitSurveyRecord(data))).setMimeType(ContentService.MimeType.JSON);
    }
    if (data.action === 'enrollStudent') {
      // La acci√≥n 'enrollStudent' ahora llama a la nueva funci√≥n
      return ContentService.createTextOutput(JSON.stringify(processEnrollment_v11(data))).setMimeType(ContentService.MimeType.JSON);
    }
    if (data.action === 'cancelSingle') {
      return ContentService.createTextOutput(JSON.stringify(cancelSingleCourse(data))).setMimeType(ContentService.MimeType.JSON);
    }
    if (data.action === 'submitInstructorProposal') {
      return ContentService.createTextOutput(JSON.stringify(submitInstructorProposal(data))).setMimeType(ContentService.MimeType.JSON);
    }
    if (data.action === 'submitInstructorEvidence') {
      return ContentService.createTextOutput(JSON.stringify(submitInstructorEvidence(data))).setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Acci√≥n no reconocida' })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('‚ùå Error en doPost: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// =============================================================================
// FUNCI√ìN PARA PETICIONES GET (Buscar por CURP)
// =============================================================================
function doGet(e) {
  try {
    if (e.parameter.action === 'lookupByCurp' && e.parameter.curp) {
      return ContentService.createTextOutput(JSON.stringify(lookupByCurp(e.parameter.curp))).setMimeType(ContentService.MimeType.JSON);
    }
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Par√°metros inv√°lidos' })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log('‚ùå Error en doGet: ' + error.toString());
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

// =============================================================================
// FUNCI√ìN: REGISTRAR ENCUESTA
// =============================================================================
function submitSurveyRecord(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('Encuestas');
    if (!sheet) {
      sheet = ss.insertSheet('Encuestas');
      sheet.appendRow(['Timestamp', 'Nombre Docente', 'Email', 'Departamento', 'ID Curso', 'Nombre Curso', 'URL Encuesta', 'Estado']);
      sheet.getRange(1, 1, 1, 8).setBackground('#1e3a8a').setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
    }
    sheet.appendRow([
      data.timestamp || new Date().toISOString(), 
      data.teacherName || '', 
      data.teacherEmail || '',
      data.department || '', 
      data.courseId || '', 
      data.courseName || '', 
      data.surveyUrl || '', 
      'Pendiente'
    ]);
    sheet.autoResizeColumns(1, 8);
    return { success: true, message: 'Registro de encuesta guardado exitosamente' };
  } catch (error) {
    Logger.log('‚ùå Error en submitSurveyRecord: ' + error.toString());
    return { success: false, message: 'Error al guardar registro: ' + error.toString() };
  }
}


// =============================================================================
// FUNCI√ìN PRINCIPAL DE INSCRIPCI√ìN - VERSI√ìN 11.0.0 (Extracci√≥n Directa)
// =============================================================================
function processEnrollment_v11(data) {
  Logger.log('üöÄ Ejecutando processEnrollment_v11 con extracci√≥n directa de ID...');
  
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('Inscripciones');
    
    if (!sheet) {
      sheet = ss.insertSheet('Inscripciones');
      sheet.appendRow(['Folio', 'Timestamp', 'Nombre Completo', 'CURP', 'Email', 'G√©nero', 'Departamento', 'ID Curso', 'Nombre Curso', 'Fechas', 'Ubicaci√≥n', 'Horario', 'Estado']);
      sheet.getRange(1, 1, 1, 13).setBackground('#be123c').setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
    }
    
    const results = [];
    const timestampISO = new Date().toISOString();
    const previousIds = (data.previousRegistrationIds || []).map(id => String(id).trim());
    
    // PASO 1: Cancelar cursos que ya no est√°n seleccionados
    if (previousIds.length > 0) {
      const inscripcionesData = sheet.getDataRange().getValues();
      for (let i = 1; i < inscripcionesData.length; i++) {
        const rowCurp = inscripcionesData[i][3];
        const rowCourseId = String(inscripcionesData[i][7]).trim();
        const estado = inscripcionesData[i][12];
        
        if (rowCurp === data.curp && estado === 'Activo' && previousIds.includes(rowCourseId)) {
          if (!data.selectedCourses.some(c => String(c.id).trim() === rowCourseId)) {
            sheet.getRange(i + 1, 13).setValue('Cancelado');
          }
        }
      }
      SpreadsheetApp.flush();
    }
    
    // PASO 2: Iterar sobre la selecci√≥n ORIGINAL del usuario
    const newCoursesToEnroll = data.selectedCourses.filter(
        course => !previousIds.includes(String(course.id).trim())
    );

    for (let i = 0; i < newCoursesToEnroll.length; i++) {
        const currentCourse = newCoursesToEnroll[i];
        const courseIdToProcess = String(currentCourse.id).trim();

        const lock = LockService.getScriptLock();
        lock.waitLock(30000);

        try {
            const inscripcionesData = sheet.getDataRange().getValues();
            let enrollments = 0;

            Logger.log(`\n--- [v11] Iteraci√≥n ${i} ---`);
            Logger.log(`[v11] Procesando Curso NUEVO: ${currentCourse.name} (ID: ${courseIdToProcess})`);

            for (let j = 1; j < inscripcionesData.length; j++) {
                if (String(inscripcionesData[j][7]).trim() === courseIdToProcess && inscripcionesData[j][12] === 'Activo') {
                    enrollments++;
                }
            }

            Logger.log(`[v11] Inscripciones para ${courseIdToProcess}: ${enrollments}`);

            if (enrollments >= 30) {
                results.push({
                    registrationId: courseIdToProcess,
                    courseName: currentCourse.name,
                    folio: null,
                    error: 'El curso ya ha alcanzado su capacidad m√°xima (30 participantes)'
                });
            } else {
                // ============================================================
                // L√ìGICA DE GENERACI√ìN DE FOLIO v11 - EXTRACCI√ìN DIRECTA
                // ============================================================
                const prefix = "TNM-054";
                const year = new Date().getFullYear().toString();

                const idParts = courseIdToProcess.split('-'); // ["TNM", "054", "02", "2026"]
                
                let courseIdPart = "XX"; // Fallback
                if (idParts.length >= 3) {
                    courseIdPart = idParts[2]; // Extrae "02"
                }

                const nextEnrollment = enrollments + 1;
                const paddedConsecutive = "00" + String(nextEnrollment);
                const consecutivePart = paddedConsecutive.substring(paddedConsecutive.length - 2);

                const finalFolio = [prefix, courseIdPart, year, consecutivePart].join('-');

                Logger.log(`[v11] ID para Folio: "${courseIdToProcess}" -> Parte extra√≠da: "${courseIdPart}"`);
                Logger.log(`[v11] Folio Final Generado: ${finalFolio}`);

                sheet.appendRow([
                    finalFolio, timestampISO, data.fullName, data.curp, data.email,
                    data.gender, data.DepartamentoSeleccionado, courseIdToProcess,
                    currentCourse.name, currentCourse.dates, currentCourse.location, currentCourse.schedule, 'Activo'
                ]);

                SpreadsheetApp.flush();

                results.push({
                    registrationId: courseIdToProcess,
                    courseName: currentCourse.name,
                    folio: finalFolio
                });
            }
        } catch (innerError) {
            Logger.log(`[v11] ‚ùå Error procesando curso ${currentCourse.id}: ${innerError.toString()}`);
            results.push({
                registrationId: courseIdToProcess,
                courseName: currentCourse.name,
                folio: null,
                error: innerError.toString()
            });
        } finally {
            lock.releaseLock();
        }
    }
    
    // Agregar cursos existentes a los resultados para el email
    const existingCoursesInSelection = data.selectedCourses.filter(
        course => previousIds.includes(String(course.id).trim())
    );

    existingCoursesInSelection.forEach(course => {
        results.push({
            registrationId: String(course.id).trim(),
            courseName: course.name,
            folio: "EXISTENTE"
        });
    });

    sheet.autoResizeColumns(1, 13);
    
    let emailSent = false;
    let emailError = null;
    
    if (results.length > 0) {
      try {
        sendEnrollmentEmail(data, results);
        emailSent = true;
      } catch (e) {
        emailError = 'No se pudo enviar el email: ' + e.toString();
      }
    }
    
    return { 
      success: true, 
      data: { 
        results: results, 
        emailSent: emailSent, 
        emailError: emailError 
      } 
    };
    
  } catch (error) {
    Logger.log('‚ùå ERROR CR√çTICO en processEnrollment_v11: ' + error.toString());
    Logger.log('üìö Stack trace: ' + error.stack);
    return { 
      success: false, 
      message: 'Error al inscribir: ' + error.toString() 
    };
  }
}

// =============================================================================
// FUNCI√ìN: BUSCAR INSCRIPCIONES POR CURP
// =============================================================================
function lookupByCurp(curp) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('Inscripciones');
    if (!sheet) return { success: true, data: { registeredCourses: [] } };
    const data = sheet.getDataRange().getValues();
    const registeredCourses = [];
    for (let i = 1; i < data.length; i++) {
      if (data[i][3] === curp && data[i][12] === 'Activo') {
        registeredCourses.push(String(data[i][7]).trim());
      }
    }
    return { success: true, data: { registeredCourses: registeredCourses } };
  } catch (error) {
    Logger.log('‚ùå Error en lookupByCurp: ' + error.toString());
    return { success: false, message: error.toString() };
  }
}

// =============================================================================
// FUNCI√ìN: CANCELAR UN SOLO CURSO
// =============================================================================
function cancelSingleCourse(data) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('Inscripciones');
    if (!sheet) throw new Error('Hoja de inscripciones no encontrada');
    const sheetData = sheet.getDataRange().getValues();
    let cancelled = false;
    const normalizedCourseId = String(data.courseToCancel.id).trim();
    for (let i = sheetData.length - 1; i > 0; i--) {
      const rowCurp = sheetData[i][3];
      const rowCourseId = String(sheetData[i][7]).trim();
      const estado = sheetData[i][12];
      if (rowCurp === data.curp && rowCourseId === normalizedCourseId && estado === 'Activo') {
        sheet.getRange(i + 1, 13).setValue('Cancelado');
        cancelled = true;
        break;
      }
    }
    if (!cancelled) {
      throw new Error('No se encontr√≥ un registro activo para cancelar.');
    }
    return { success: true, message: 'Curso cancelado exitosamente' };
  } catch (error) {
    Logger.log('‚ùå Error en cancelSingleCourse: ' + error.toString());
    return { success: false, message: error.toString() };
  }
}

// =============================================================================
// FUNCI√ìN: ENVIAR PROPUESTA DE INSTRUCTOR
// =============================================================================
function submitInstructorProposal(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('Propuestas_Instructores');
    if (!sheet) {
      sheet = ss.insertSheet('Propuestas_Instructores');
      sheet.appendRow(['Timestamp', 'Nombre Instructor', 'Email', 'ID Curso', 'Nombre Curso', 'CVU', 'Ficha T√©cnica', 'Estado']);
      sheet.getRange(1, 1, 1, 8).setBackground('#4338ca').setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
    }
    const folderId = createInstructorFolder(data.instructorName);
    const cvuFileId = saveBase64File(data.cvuFile, 'CVU_' + data.instructorName + '.pdf', folderId);
    const fichaFileId = saveBase64File(data.fichaFile, 'Ficha_' + data.courseName + '.pdf', folderId);
    sheet.appendRow([
      new Date().toISOString(), data.instructorName, data.instructorEmail, data.courseId, data.courseName,
      'https://drive.google.com/file/d/' + cvuFileId + '/view', 'https://drive.google.com/file/d/' + fichaFileId + '/view', 'Pendiente Revisi√≥n'
    ]);
    sheet.autoResizeColumns(1, 8);
    return { success: true, message: 'Propuesta enviada exitosamente' };
  } catch (error) {
    Logger.log('‚ùå Error en submitInstructorProposal: ' + error.toString());
    return { success: false, message: 'Error al enviar propuesta: ' + error.toString() };
  }
}

// =============================================================================
// FUNCI√ìN: ENVIAR EVIDENCIAS DE INSTRUCTOR
// =============================================================================
function submitInstructorEvidence(data) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName('Evidencias_Instructores');
    if (!sheet) {
      sheet = ss.insertSheet('Evidencias_Instructores');
      sheet.appendRow(['Timestamp', 'Nombre Instructor', 'Email', 'Nombre Curso', 'N√∫mero de Archivos', 'Enlaces Drive', 'Estado']);
      sheet.getRange(1, 1, 1, 7).setBackground('#4338ca').setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
    }
    const folderId = createInstructorFolder(data.instructorName + '_Evidencias');
    const fileLinks = [];
    for (let i = 0; i < data.evidenceFiles.length; i++) {
      const fileId = saveBase64File(data.evidenceFiles[i], 'Evidencia_' + (i + 1) + '_' + data.courseName, folderId);
      fileLinks.push('https://drive.google.com/file/d/' + fileId + '/view');
    }
    sheet.appendRow([
      new Date().toISOString(), data.instructorName, data.instructorEmail,
      data.courseName, data.evidenceFiles.length, fileLinks.join('\n'), 'Recibido'
    ]);
    sheet.autoResizeColumns(1, 7);
    return { success: true, message: 'Evidencias enviadas exitosamente' };
  } catch (error) {
    Logger.log('‚ùå Error en submitInstructorEvidence: ' + error.toString());
    return { success: false, message: 'Error al enviar evidencias: ' + error.toString() };
  }
}

// =============================================================================
// FUNCIONES AUXILIARES - GOOGLE DRIVE
// =============================================================================
function createInstructorFolder(folderName) {
  const parentFolderName = 'Instructores_Documentacion_ITD';
  let parentFolder;
  const folders = DriveApp.getFoldersByName(parentFolderName);
  if (folders.hasNext()) {
    parentFolder = folders.next();
  } else {
    parentFolder = DriveApp.createFolder(parentFolderName);
  }
  let subFolder;
  const subFolders = parentFolder.getFoldersByName(folderName);
  if (subFolders.hasNext()) {
    subFolder = subFolders.next();
  } else {
    subFolder = parentFolder.createFolder(folderName);
  }
  return subFolder.getId();
}

function saveBase64File(base64Data, fileName, folderId) {
  const splitData = base64Data.split(',');
  const contentType = splitData[0].split(';')[0].replace('data:', '');
  const bytes = Utilities.base64Decode(splitData[1]);
  const blob = Utilities.newBlob(bytes, contentType, fileName);
  const folder = DriveApp.getFolderById(folderId);
  const file = folder.createFile(blob);
  return file.getId();
}

// =============================================================================
// FUNCI√ìN AUXILIAR - ENV√çO DE EMAIL
// =============================================================================
function sendEnrollmentEmail(data, results) {
  const recipient = data.email;
  const subject = 'Confirmaci√≥n de Inscripci√≥n a Cursos - ITD';
  let courseDetailsHtml = '';
  let hasErrors = false;
  results.forEach(result => {
    if (result.error) {
      hasErrors = true;
      courseDetailsHtml += `
        <div style="padding: 12px; border: 1px solid #fecaca; background-color: #fef2f2; border-radius: 8px; margin-bottom: 12px;">
          <p style="margin: 0; font-weight: bold; color: #b91c1c;">${result.courseName}</p>
          <p style="margin: 4px 0 0; color: #991b1b; font-size: 14px;"><strong>Error:</strong> ${result.error}</p>
        </div>`;
    } else if (result.folio === "EXISTENTE") {
      courseDetailsHtml += `
        <div style="padding: 12px; border: 1px solid #bfdbfe; background-color: #eff6ff; border-radius: 8px; margin-bottom: 12px;">
          <p style="margin: 0; font-weight: bold; color: #1e40af;">${result.courseName}</p>
          <p style="margin: 4px 0 0; color: #1e3a8a; font-size: 14px;">
            <strong>Estado:</strong> Ya estabas inscrito en este curso
          </p>
        </div>`;
    } else {
      courseDetailsHtml += `
        <div style="padding: 12px; border: 1px solid #bbf7d0; background-color: #f0fdf4; border-radius: 8px; margin-bottom: 12px;">
          <p style="margin: 0; font-weight: bold; color: #166534;">${result.courseName}</p>
          <p style="margin: 4px 0 0; color: #15803d; font-size: 14px;">
            <strong>Folio de Registro:</strong> 
            <span style="font-family: 'Courier New', monospace; background-color: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold;">${result.folio}</span>
          </p>
        </div>`;
    }
  });
  const mainMessage = hasErrors ? 
    'Hubo un problema con la inscripci√≥n de algunos cursos. Por favor, revise los detalles a continuaci√≥n:' :
    'Hemos recibido y procesado exitosamente tu solicitud de inscripci√≥n. A continuaci√≥n, encontrar√°s los detalles y folios de registro:';
  const htmlBody = `
    <!DOCTYPE html>
    <html lang="es">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; background-color: #f3f4f6; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; padding: 0; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .header { text-align: center; padding: 30px 20px; background: linear-gradient(135deg, #0c2f68 0%, #1e40af 100%); }
        .header img { height: 60px; margin-bottom: 15px; }
        .header h1 { color: #ffffff; margin: 0; font-size: 24px; font-weight: 600; }
        .content { padding: 30px 20px; }
        .content p { margin: 0 0 15px 0; }
        .footer { text-align: center; padding: 20px; background-color: #f9fafb; border-top: 1px solid #e5e7eb; font-size: 12px; color: #6b7280; }
        .footer p { margin: 5px 0; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <img src="https://raw.githubusercontent.com/DA-itd/web/main/logo_itdurango.png" alt="Logo ITD">
          <h1>Confirmaci√≥n de Inscripci√≥n</h1>
        </div>
        <div class="content">
          <p>Hola <strong>${data.fullName}</strong>,</p>
          <p>${mainMessage}</p>
          ${courseDetailsHtml}
          <p style="margin-top: 20px;"><strong>üìå Importante:</strong> Guarda este correo como comprobante de tu inscripci√≥n.</p>
          <p>Si tienes alguna duda, por favor contacta a la Coordinaci√≥n de Actualizaci√≥n Docente.</p>
          <p style="margin-top: 20px;">¬°Te esperamos en los cursos!</p>
        </div>
        <div class="footer">
          <p><strong>Coordinaci√≥n de Actualizaci√≥n Docente</strong></p>
          <p>Instituto Tecnol√≥gico de Durango</p>
          <p style="margin-top: 10px; font-size: 11px;">Este es un correo electr√≥nico generado autom√°ticamente, por favor no respondas a este mensaje.</p>
        </div>
      </div>
    </body>
    </html>
  `;
  MailApp.sendEmail({
    to: recipient,
    subject: subject,
    htmlBody: htmlBody,
    name: 'Portal de Actualizaci√≥n Docente ITD'
  });
}