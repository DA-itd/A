<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sitio en Mantenimiento - ITD</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;500;600;700&family=Barlow+Condensed:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --guinda:   #9D2449;
            --guinda-dk:#7a1a38;
            --guinda-lt:rgba(157,36,73,.08);
            --azul:     #1B396A;
            --azul-mid: #2a52a0;
            --gris:     #6b7280;
            --gris-lt:  #f3f4f6;
        }
        * { box-sizing:border-box; margin:0; padding:0; }
        body {
            font-family:'Barlow',system-ui,sans-serif;
            background:var(--gris-lt);
            background-image:
                radial-gradient(ellipse at 10% 15%,rgba(157,36,73,.06) 0%,transparent 55%),
                radial-gradient(ellipse at 90% 85%,rgba(27,57,106,.07) 0%,transparent 55%);
            min-height:100vh; overflow-x:hidden;
        }
        #view-info   { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:24px 16px; }
        #view-tetris { display:none; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; padding:12px 8px; }

        @keyframes fadeIn  { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:none} }
        @keyframes fadeOut { from{opacity:1} to{opacity:0;transform:translateY(-10px)} }
        .fade-in  { animation:fadeIn  .35s ease-out forwards; }
        .fade-out { animation:fadeOut .3s  ease-in  forwards; }

        .info-card {
            background:#fff; border-radius:20px;
            border:1px solid rgba(157,36,73,.12);
            box-shadow:0 6px 32px rgba(157,36,73,.1),0 1px 4px rgba(0,0,0,.04);
            max-width:460px; width:100%;
            padding:36px 32px 28px; text-align:center;
            overflow:hidden; position:relative;
        }
        .info-card::before {
            content:''; position:absolute; top:0;left:0;right:0;height:5px;
            background:linear-gradient(90deg,var(--guinda),var(--azul),var(--guinda));
            background-size:200% 100%; animation:shimmer 4s linear infinite;
        }
        .status-chip { display:inline-flex;align-items:center;gap:8px;background:var(--guinda-lt);border:1px solid rgba(157,36,73,.2);border-radius:999px;padding:5px 16px;font-size:12px;font-weight:600;color:var(--guinda); }
        .status-dot  { width:7px;height:7px;border-radius:50%;background:var(--guinda);animation:pulse-dot 1.5s ease-in-out infinite; }
        .divider     { height:2px;background:linear-gradient(90deg,transparent,var(--guinda),rgba(27,57,106,.4),var(--guinda),transparent);border-radius:2px;margin:18px auto;width:80px; }
        .divider-full{ height:1px;background:linear-gradient(90deg,transparent,rgba(157,36,73,.2),rgba(27,57,106,.2),transparent);margin:20px 0 16px; }
        .main-title  { font-family:'Barlow Condensed',sans-serif;font-size:2em;font-weight:800;color:var(--azul);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px; }
        .main-sub    { font-size:.7em;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--guinda);opacity:.7; }
        .dots        { display:flex;justify-content:center;gap:8px;margin:16px 0; }

        .play-btn {
            display:inline-flex;align-items:center;gap:10px;
            background:linear-gradient(135deg,var(--guinda),#c42d5a);
            color:#fff;border:none;border-radius:14px;padding:13px 28px;
            font-family:'Barlow',sans-serif;font-size:15px;font-weight:700;cursor:pointer;margin-top:4px;
            box-shadow:0 4px 18px rgba(157,36,73,.35);transition:transform .15s,box-shadow .15s;
        }
        .play-btn:hover  { transform:scale(1.05);box-shadow:0 6px 24px rgba(157,36,73,.45); }
        .play-btn:active { transform:scale(.97); }
        .tetris-icon     { display:grid;grid-template-columns:repeat(3,8px);gap:2px; }
        .tetris-icon span   { width:8px;height:8px;border-radius:2px;background:rgba(255,255,255,.85); }
        .tetris-icon span.e { background:transparent; }

        .info-footer   { font-size:.8em;color:var(--gris); }
        .info-footer b { color:var(--azul); }
        .email-link    { color:var(--guinda);font-weight:600;text-decoration:none;border-bottom:1px dashed rgba(157,36,73,.4); }
        .email-link:hover { color:var(--guinda-dk); }

        .tetris-wrap {
            background:#fff;border-radius:18px;
            border:1px solid rgba(157,36,73,.12);
            box-shadow:0 6px 28px rgba(157,36,73,.1);
            overflow:hidden;width:100%;max-width:420px;
        }
        .game-header { background:var(--azul);border-bottom:4px solid var(--guinda);padding:10px 14px;display:flex;align-items:center;justify-content:space-between; }
        .back-btn    { display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Barlow',sans-serif;transition:background .2s; }
        .back-btn:hover { background:rgba(255,255,255,.22); }
        .game-lbl    { font-family:'Barlow Condensed',sans-serif;font-size:1em;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:.5px; }
        #btn-sound   { background:none;border:none;cursor:pointer;font-size:18px;padding:0;line-height:1; }

        .score-row { display:flex;gap:6px;padding:10px 12px 6px; }
        .score-box { flex:1;background:linear-gradient(135deg,var(--guinda-lt),rgba(27,57,106,.07));border:1px solid rgba(157,36,73,.12);border-radius:8px;padding:5px 6px;text-align:center; }
        .score-box span   { display:block;font-size:9px;color:var(--guinda);font-weight:600;text-transform:uppercase;letter-spacing:.04em; }
        .score-box strong { font-size:14px;color:var(--azul);font-weight:700; }

        .game-area  { display:flex;gap:8px;justify-content:center;align-items:flex-start;padding:0 12px 8px; }
        #tetris     { border:2px solid rgba(157,36,73,.3);border-radius:8px;background:#0f1624;display:block; }
        .side-panel { display:flex;flex-direction:column;gap:6px;min-width:60px; }
        .side-lbl   { font-size:9px;font-weight:700;color:var(--guinda);opacity:.7;text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px; }
        #next-piece { border:1px solid rgba(157,36,73,.2);border-radius:7px;background:#0f1624;display:block; }
        .hint-keys  { font-size:10px;color:var(--azul);opacity:.6;line-height:1.9; }

        .ctrl-grid  { padding:6px 12px 10px; }
        .btn-row    { display:flex;gap:8px;justify-content:center;margin-bottom:7px; }
        .ctrl-btn   {
            background:linear-gradient(135deg,var(--guinda),#c42d5a);color:#fff;border:none;border-radius:10px;
            width:48px;height:48px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
            box-shadow:0 2px 8px rgba(157,36,73,.3);transition:transform .1s;user-select:none;-webkit-tap-highlight-color:transparent;
        }
        .ctrl-btn:active { transform:scale(.88); }
        .ctrl-btn.wide   { width:110px;font-size:13px;font-weight:700; }
        .ctrl-btn.azul   { background:linear-gradient(135deg,var(--azul),var(--azul-mid));box-shadow:0 2px 8px rgba(27,57,106,.3); }
        .hint-touch { font-size:10px;color:var(--gris);text-align:center;margin-top:2px;opacity:.6; }

        #game-overlay {
            position:absolute;inset:0;border-radius:8px;
            background:rgba(15,22,36,.88);backdrop-filter:blur(5px);
            display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;
        }
        #game-overlay img { height:52px;width:auto;object-fit:contain;opacity:.85;margin-bottom:4px;filter:drop-shadow(0 2px 8px rgba(157,36,73,.5)); }
        #game-overlay h3  { font-family:'Barlow Condensed',sans-serif;font-size:22px;color:#fff;font-weight:800;letter-spacing:1px; }
        #game-overlay p   { font-size:12px;color:rgba(255,255,255,.55); }
        .start-btn {
            background:linear-gradient(135deg,var(--guinda),#c42d5a);color:#fff;
            font-family:'Barlow',sans-serif;font-weight:700;font-size:14px;padding:10px 28px;
            border-radius:999px;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(157,36,73,.4);transition:transform .15s;margin-top:4px;
        }
        .start-btn:hover { transform:scale(1.06); }

        #idle-bar-wrap { width:100%;background:rgba(157,36,73,.1);height:4px;overflow:hidden;display:none; }
        #idle-bar      { height:100%;background:linear-gradient(90deg,var(--guinda),var(--azul));width:100%;transition:none; }
        #idle-msg      { font-size:10px;color:var(--guinda);text-align:center;padding:3px 0 6px;display:none;opacity:.75; }

        @keyframes shimmer    { 0%{background-position:0 0} 100%{background-position:200% 0} }
        @keyframes spin-slow  { from{transform:rotate(0)} to{transform:rotate(360deg)} }
        @keyframes spin-rev   { from{transform:rotate(0)} to{transform:rotate(-360deg)} }
        @keyframes pulse-logo { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.04);opacity:.9} }
        @keyframes bounce-dot { 0%,80%,100%{transform:translateY(0);opacity:.4} 40%{transform:translateY(-7px);opacity:1} }
        @keyframes float-1    { 0%,100%{transform:translateY(0) rotate(-5deg)} 50%{transform:translateY(-10px) rotate(5deg)} }
        @keyframes float-2    { 0%,100%{transform:translateY(0) rotate(8deg)}  50%{transform:translateY(-13px) rotate(-4deg)} }
        @keyframes pulse-dot  { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.5);opacity:.6} }

        .spin-slow  { animation:spin-slow 8s linear infinite; }
        .spin-rev   { animation:spin-rev  6s linear infinite; }
        .pulse-logo { animation:pulse-logo 3s ease-in-out infinite; }
        .dot-1 { animation:bounce-dot 1.4s ease-in-out 0s   infinite; }
        .dot-2 { animation:bounce-dot 1.4s ease-in-out .2s  infinite; }
        .dot-3 { animation:bounce-dot 1.4s ease-in-out .4s  infinite; }
        .float-1 { animation:float-1 4s ease-in-out infinite; }
        .float-2 { animation:float-2 5s ease-in-out .5s infinite; }

        @media(max-width:400px){
            .info-card { padding:28px 18px 22px; }
            .main-title { font-size:1.7em; }
            .play-btn { padding:11px 20px;font-size:14px; }
            .ctrl-btn { width:44px;height:44px;font-size:16px; }
            .ctrl-btn.wide { width:100px; }
        }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEW: INFO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-info">
    <div class="info-card">
        <div style="position:absolute;top:32px;left:20px;font-size:20px;opacity:.12;" class="float-1">üîß</div>
        <div style="position:absolute;top:40px;right:24px;font-size:18px;opacity:.12;" class="float-2">üõ†Ô∏è</div>

        <!-- Logo ITD centrado -->
        <div style="display:flex;justify-content:center;margin-bottom:20px;">
            <img src="https://cdn.jsdelivr.net/gh/DA-itd/web/logo_itdurango.png"
                 alt="Logo ITD" class="pulse-logo"
                 style="height:90px;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(157,36,73,.2));">
        </div>

        <!-- Engranajes -->
        <div style="display:flex;justify-content:center;align-items:center;gap:4px;margin-bottom:16px;">
            <span class="spin-slow" style="font-size:28px;color:var(--guinda);opacity:.6;">‚öôÔ∏è</span>
            <span class="spin-rev"  style="font-size:20px;color:var(--azul);opacity:.5;margin-top:8px;">‚öôÔ∏è</span>
            <span class="spin-slow" style="font-size:24px;color:var(--gris);opacity:.4;animation-delay:1s;">‚öôÔ∏è</span>
        </div>

        <div style="display:flex;justify-content:center;margin-bottom:14px;">
            <div class="status-chip"><span class="status-dot"></span>Trabajando en mejoras</div>
        </div>

        <h1 class="main-title">Sitio en Mantenimiento</h1>
        <p class="main-sub">Portal de Actualizaci√≥n Docente ¬∑ ITD</p>
        <div class="divider"></div>

        <p style="color:var(--gris);font-size:.88em;line-height:1.6;margin-bottom:8px;max-width:340px;margin-left:auto;margin-right:auto;">
            ¬°Disculpen las molestias! Estamos realizando mejoras para ofrecerles un mejor servicio.
        </p>
        <p style="color:#9ca3af;font-size:.78em;line-height:1.5;max-width:300px;margin:0 auto 16px;">
            El sistema estar√° disponible en breve. Agradecemos su paciencia.
        </p>

        <div class="dots">
            <span class="dot-1" style="width:10px;height:10px;border-radius:50%;display:inline-block;background:var(--guinda);"></span>
            <span class="dot-2" style="width:10px;height:10px;border-radius:50%;display:inline-block;background:var(--azul);"></span>
            <span class="dot-3" style="width:10px;height:10px;border-radius:50%;display:inline-block;background:var(--gris);"></span>
        </div>

        <button class="play-btn" id="btn-open-tetris">
            <span class="tetris-icon" aria-hidden="true">
                <span></span><span></span><span class="e"></span>
                <span></span><span></span><span></span>
                <span class="e"></span><span></span><span class="e"></span>
            </span>
            üéÆ Jugar mientras esperas
        </button>

        <div class="divider-full"></div>
        <div class="info-footer">
            <b>M.C. Alejandro Calder√≥n Renter√≠a</b><br>
            <span style="font-size:.85em;">Coordinaci√≥n de Actualizaci√≥n Docente</span><br>
            <span style="font-size:.82em;color:#9ca3af;">¬øUrgencia? &nbsp;
                <a href="mailto:alejandro.calderon@itdurango.edu.mx" class="email-link">alejandro.calderon@itdurango.edu.mx</a>
            </span>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEW: TETRIS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="view-tetris">
    <div class="tetris-wrap">
        <div class="game-header">
            <button class="back-btn" id="btn-back">‚Üê Volver</button>
            <span class="game-lbl">üéÆ TETRIS ITD</span>
            <button id="btn-sound">üîä</button>
        </div>
        <div class="score-row">
            <div class="score-box"><span>Puntaje</span><strong id="score">0</strong></div>
            <div class="score-box"><span>Nivel</span>  <strong id="level">1</strong></div>
            <div class="score-box"><span>L√≠neas</span> <strong id="lines">0</strong></div>
        </div>
        <div class="game-area">
            <div style="position:relative;">
                <canvas id="tetris" width="200" height="400"></canvas>
                <div id="game-overlay">
                    <img src="https://github.com/DA-itd/A/blob/main/pola.png?raw=true" alt="Logo">
                    <h3>TETRIS ITD</h3>
                    <p id="overlay-msg">¬øListo para jugar?</p>
                    <button class="start-btn" id="start-btn">‚ñ∂ Iniciar</button>
                </div>
            </div>
            <div class="side-panel">
                <div>
                    <div class="side-lbl">Siguiente</div>
                    <canvas id="next-piece" width="56" height="56"></canvas>
                </div>
                <div style="margin-top:4px;">
                    <div class="side-lbl">Teclado</div>
                    <div class="hint-keys">‚Üê ‚Üí Mover<br>‚Üë Rotar<br>‚Üì Bajar<br>Esp. Caer</div>
                </div>
            </div>
        </div>
        <div class="ctrl-grid">
            <div class="btn-row">
                <button class="ctrl-btn" id="btn-left">‚óÄ</button>
                <button class="ctrl-btn azul" id="btn-rotate">üîÑ</button>
                <button class="ctrl-btn" id="btn-right">‚ñ∂</button>
            </div>
            <div class="btn-row">
                <button class="ctrl-btn" id="btn-down">‚ñº</button>
                <button class="ctrl-btn wide azul" id="btn-drop">‚¨á Caer</button>
            </div>
            <p class="hint-touch">Toca los botones o usa el teclado</p>
        </div>
        <div id="idle-bar-wrap"><div id="idle-bar"></div></div>
        <p id="idle-msg">Regresando al inicio en <span id="idle-countdown">20</span>s‚Ä¶</p>
    </div>
</div>

<script>
window.onload = function() {

    var viewInfo   = document.getElementById('view-info');
    var viewTetris = document.getElementById('view-tetris');
    var cvEl       = document.getElementById('tetris');
    var cx         = cvEl.getContext('2d');
    var ncv        = document.getElementById('next-piece');
    var ncx        = ncv.getContext('2d');

    var COLS = 10, ROWS = 20, SZ = 20;

    function calcSZ() {
        var maxW = Math.min(window.innerWidth - 130, 240);
        var maxH = Math.min(window.innerHeight - 280, 400);
        var byW  = Math.floor(maxW / COLS);
        var byH  = Math.floor(maxH / ROWS);
        return Math.max(14, Math.min(byW, byH));
    }
    function resizeCanvas() {
        SZ = calcSZ();
        cvEl.width  = COLS * SZ;
        cvEl.height = ROWS * SZ;
    }
    resizeCanvas();
    window.addEventListener('resize', function(){ resizeCanvas(); if(running) render(); });

    // VISTAS
    document.getElementById('btn-open-tetris').onclick = function() {
        viewInfo.classList.add('fade-out');
        setTimeout(function(){
            viewInfo.style.display = 'none';
            viewInfo.classList.remove('fade-out');
            viewTetris.style.display = 'flex';
            viewTetris.classList.add('fade-in');
            resizeCanvas();
            setTimeout(function(){ viewTetris.classList.remove('fade-in'); }, 400);
        }, 300);
    };

    document.getElementById('btn-back').onclick = function() {
        if(running) pauseGame();
        clearIdleTimer();
        viewTetris.classList.add('fade-out');
        setTimeout(function(){
            viewTetris.style.display = 'none';
            viewTetris.classList.remove('fade-out');
            viewInfo.style.display = 'flex';
            viewInfo.classList.add('fade-in');
            setTimeout(function(){ viewInfo.classList.remove('fade-in'); }, 400);
        }, 300);
    };

    // SONIDO
    var audioCtx = null, soundOn = true;
    function getAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
    function beep(freq,dur,type,vol){
        if(!soundOn) return;
        try{
            var ac=getAudio(), o=ac.createOscillator(), g=ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.type=type||'square'; o.frequency.setValueAtTime(freq,ac.currentTime);
            g.gain.setValueAtTime(vol||0.08,ac.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+dur);
            o.start(); o.stop(ac.currentTime+dur);
        }catch(e){}
    }
    function soundMove()   { beep(220,.05,'square',.05); }
    function soundRotate() { beep(330,.06,'sine',.07); }
    function soundDrop()   { beep(110,.12,'sawtooth',.09); }
    function soundLine(n)  {
        var notes=[[262,.08],[330,.08],[392,.08],[523,.12]];
        for(var i=0;i<Math.min(n,4);i++){
            (function(f,d){ setTimeout(function(){ beep(f,d,'sine',.1); }, i*80); })(notes[i][0],notes[i][1]);
        }
    }
    function soundOver()  { var f=[220,196,174,156,130]; for(var i=0;i<f.length;i++){ (function(ff,ii){ setTimeout(function(){ beep(ff,.18,'sawtooth',.1); },ii*120); })(f[i],i); } }
    function soundStart() { var f=[330,392,523]; for(var i=0;i<f.length;i++){ (function(ff,ii){ setTimeout(function(){ beep(ff,.1,'sine',.08); },ii*100); })(f[i],i); } }

    document.getElementById('btn-sound').onclick = function(){
        soundOn = !soundOn;
        this.textContent = soundOn ? 'üîä' : 'üîá';
    };

    // IDLE
    var IDLE_SECS=20, idleTimer=null, idleTick=null, idleLeft=IDLE_SECS;
    function resetIdle(){
        clearIdleTimer();
        if(!running) return;
        document.getElementById('idle-bar-wrap').style.display='none';
        document.getElementById('idle-msg').style.display='none';
    }
    function startIdleCountdown(){
        document.getElementById('idle-bar-wrap').style.display='block';
        document.getElementById('idle-msg').style.display='block';
        idleLeft=IDLE_SECS;
        document.getElementById('idle-countdown').textContent=idleLeft;
        var bar=document.getElementById('idle-bar');
        bar.style.transition='none'; bar.style.width='100%';
        requestAnimationFrame(function(){
            bar.style.transition='width '+IDLE_SECS+'s linear';
            bar.style.width='0%';
        });
        idleTick=setInterval(function(){
            idleLeft--;
            document.getElementById('idle-countdown').textContent=idleLeft;
            if(idleLeft<=0){ clearInterval(idleTick); document.getElementById('btn-back').onclick(); }
        },1000);
    }
    function clearIdleTimer(){
        clearTimeout(idleTimer); clearInterval(idleTick);
        document.getElementById('idle-bar-wrap').style.display='none';
        document.getElementById('idle-msg').style.display='none';
    }
    function touchReset(){
        if(viewTetris.style.display!=='none' && running){
            clearIdleTimer();
            idleTimer=setTimeout(startIdleCountdown,8000);
        }
    }
    ['keydown','touchstart','mousedown'].forEach(function(ev){
        document.addEventListener(ev, touchReset, {passive:true});
    });

    // TETRIS ENGINE
    var C=['','#9D2449','#1B396A','#c42d5a','#2a52a0','#7a1a38','#6b7280','#b0b8c4'];
    var GHOST='rgba(157,36,73,.12)';
    var SHAPES=[
        null,
        [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
        [[2,2],[2,2]],
        [[0,3,0],[3,3,3],[0,0,0]],
        [[0,4,4],[4,4,0],[0,0,0]],
        [[5,5,0],[0,5,5],[0,0,0]],
        [[6,0,0],[6,6,6],[0,0,0]],
        [[0,0,7],[7,7,7],[0,0,0]]
    ];

    var board,piece,px,py,nextT;
    var sc=0,lv=1,ln=0;
    var running=false,paused=false,animId,lastT=0;

    function mkBoard(){ return Array.from({length:ROWS},function(){ return new Array(COLS).fill(0); }); }
    function randT(){ return Math.floor(Math.random()*7)+1; }

    function hits(b,p,ox,oy){
        for(var r=0;r<p.length;r++)
            for(var c=0;c<p[r].length;c++)
                if(p[r][c]){ var x=ox+c,y=oy+r; if(x<0||x>=COLS||y>=ROWS)return true; if(y>=0&&b[y][x])return true; }
        return false;
    }
    function spawn(){
        var t=nextT||randT(); nextT=randT();
        piece=SHAPES[t].map(function(r){ return r.slice(); });
        px=Math.floor(COLS/2)-Math.floor(piece[0].length/2); py=0;
        drawNext();
        if(hits(board,piece,px,py)) endGame();
    }
    function merge(){ piece.forEach(function(r,ri){ r.forEach(function(v,ci){ if(v&&py+ri>=0) board[py+ri][px+ci]=v; }); }); }
    function rotateMx(p){
        var R=p.length,C2=p[0].length;
        return Array.from({length:C2},function(_,r){ return Array.from({length:R},function(_,c){ return p[R-1-c][r]; }); });
    }
    function tryRot(){
        var rot=rotateMx(piece);
        var offsets=[0,-1,1,-2,2];
        for(var i=0;i<offsets.length;i++){
            if(!hits(board,rot,px+offsets[i],py)){ piece=rot; px+=offsets[i]; soundRotate(); return; }
        }
    }
    function clearLines(){
        var cl=0;
        for(var r=ROWS-1;r>=0;r--)
            if(board[r].every(function(v){ return v; })){ board.splice(r,1); board.unshift(new Array(COLS).fill(0)); cl++; r++; }
        if(cl){
            soundLine(cl);
            sc+=([0,100,300,500,800][cl]||800)*lv;
            ln+=cl; lv=Math.floor(ln/10)+1;
            document.getElementById('score').textContent=sc;
            document.getElementById('level').textContent=lv;
            document.getElementById('lines').textContent=ln;
        }
    }
    function drop(){
        if(!running||paused) return;
        py++;
        if(hits(board,piece,px,py)){ py--; merge(); clearLines(); spawn(); }
    }
    function hardDrop(){ while(!hits(board,piece,px,py+1)) py++; soundDrop(); drop(); }
    function ghostPY(){ var g=py; while(!hits(board,piece,px,g+1)) g++; return g; }

    function drawBlock(ctx2,x,y,col,sz){
        ctx2.fillStyle=col; ctx2.fillRect(x*sz+1,y*sz+1,sz-2,sz-2);
        ctx2.fillStyle='rgba(255,255,255,.18)'; ctx2.fillRect(x*sz+2,y*sz+2,sz-4,4);
        ctx2.fillStyle='rgba(0,0,0,.25)'; ctx2.fillRect(x*sz+1,y*sz+sz-4,sz-2,3);
    }
    function render(){
        cx.fillStyle='#0f1624'; cx.fillRect(0,0,cvEl.width,cvEl.height);
        cx.strokeStyle='rgba(27,57,106,.12)'; cx.lineWidth=.5;
        for(var r=0;r<ROWS;r++){ cx.beginPath();cx.moveTo(0,r*SZ);cx.lineTo(cvEl.width,r*SZ);cx.stroke(); }
        for(var c=0;c<COLS;c++){ cx.beginPath();cx.moveTo(c*SZ,0);cx.lineTo(c*SZ,cvEl.height);cx.stroke(); }
        board.forEach(function(row,r){ row.forEach(function(v,c){ if(v) drawBlock(cx,c,r,C[v],SZ); }); });
        if(running&&piece){
            var gy=ghostPY();
            piece.forEach(function(row,r){ row.forEach(function(v,c){ if(v&&gy+r>=0){ cx.fillStyle=GHOST; cx.fillRect((px+c)*SZ+1,(gy+r)*SZ+1,SZ-2,SZ-2); } }); });
            piece.forEach(function(row,r){ row.forEach(function(v,c){ if(v&&py+r>=0) drawBlock(cx,px+c,py+r,C[v],SZ); }); });
        }
    }
    function drawNext(){
        var s=13;
        ncx.fillStyle='#0f1624'; ncx.fillRect(0,0,ncv.width,ncv.height);
        if(!nextT) return;
        var p=SHAPES[nextT];
        var ox=Math.floor((ncv.width-p[0].length*s)/2);
        var oy=Math.floor((ncv.height-p.length*s)/2);
        p.forEach(function(row,r){ row.forEach(function(v,c){
            if(v){ ncx.fillStyle=C[v]; ncx.fillRect(ox+c*s+1,oy+r*s+1,s-2,s-2); ncx.fillStyle='rgba(255,255,255,.18)'; ncx.fillRect(ox+c*s+2,oy+r*s+2,s-4,3); }
        }); });
    }
    function loop(ts){
        if(!running||paused) return;
        var speed=Math.max(80,500-(lv-1)*45);
        if(ts-lastT>=speed){ drop(); lastT=ts; }
        render();
        animId=requestAnimationFrame(loop);
    }
    function startGame(){
        resizeCanvas();
        board=mkBoard(); sc=0; lv=1; ln=0;
        document.getElementById('score').textContent=0;
        document.getElementById('level').textContent=1;
        document.getElementById('lines').textContent=0;
        nextT=randT(); spawn(); running=true; paused=false; lastT=0;
        document.getElementById('game-overlay').style.display='none';
        soundStart();
        animId=requestAnimationFrame(loop);
        clearIdleTimer();
        idleTimer=setTimeout(startIdleCountdown,8000);
    }
    function pauseGame(){ paused=true; running=false; cancelAnimationFrame(animId); }
    function endGame(){
        running=false; paused=false; cancelAnimationFrame(animId); render();
        soundOver(); clearIdleTimer();
        document.getElementById('overlay-msg').textContent='Puntaje final: '+sc;
        document.getElementById('start-btn').textContent='‚Ü∫ Reiniciar';
        document.getElementById('game-overlay').style.display='flex';
    }

    document.getElementById('start-btn').onclick = startGame;

    document.addEventListener('keydown',function(e){
        if(!running||paused) return;
        var acted=false;
        if(e.key==='ArrowLeft'&&!hits(board,piece,px-1,py)){ px--; soundMove(); acted=true; }
        else if(e.key==='ArrowRight'&&!hits(board,piece,px+1,py)){ px++; soundMove(); acted=true; }
        else if(e.key==='ArrowDown'){ drop(); acted=true; }
        else if(e.key==='ArrowUp'){ tryRot(); acted=true; }
        else if(e.key===' '){ e.preventDefault(); hardDrop(); acted=true; }
        if(acted){ render(); touchReset(); }
    });

    function addBtn(id,fn){
        var b=document.getElementById(id); if(!b) return;
        var iv;
        var go=function(){ if(running&&!paused){ fn(); render(); touchReset(); } };
        b.addEventListener('touchstart',function(e){ e.preventDefault(); go(); iv=setInterval(go,110); },{passive:false});
        b.addEventListener('touchend',  function(e){ e.preventDefault(); clearInterval(iv); },{passive:false});
        b.addEventListener('mousedown', function(e){ e.preventDefault(); go(); iv=setInterval(go,110); });
        b.addEventListener('mouseup',   function(){ clearInterval(iv); });
        b.addEventListener('mouseleave',function(){ clearInterval(iv); });
    }
    addBtn('btn-left', function(){ if(!hits(board,piece,px-1,py)){ px--; soundMove(); } });
    addBtn('btn-right',function(){ if(!hits(board,piece,px+1,py)){ px++; soundMove(); } });
    addBtn('btn-down', drop);
    document.getElementById('btn-rotate').onclick=function(){ if(running&&!paused){ tryRot(); render(); } };
    document.getElementById('btn-drop').onclick  =function(){ if(running&&!paused){ hardDrop(); render(); } };

}; // fin window.onload
</script>
</body>
</html>
